ü
åC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\CatalogService.API\APIModule.cs
	namespace 	
CatalogService
 
. 
API 
{ 
internal 
static 
class 
	APIModule #
{ 
public		 
static		 
IServiceCollection		 ( 
RegisterDependencies		) =
(		= >
this		> B
IServiceCollection		C U
services		V ^
)		^ _
{

 	
services 
. !
RegisterBusinessLayer &
(& '
)' (
. 
RegisterDataLayer "
(" #
)# $
. 
RegisterExchange !
(! "
)" #
;# $
return 
services 
; 
} 	
} 
} ¥ü
äC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\CatalogService.API\Program.cs
var 
getSingleResource 
= 
new 
Func  
<  !
int! $
,$ %
string& ,
,, -
string. 4
>4 5
(5 6
(6 7
id7 9
,9 :
singleItemPath; I
)I J
=>K M
singleItemPathN \
.\ ]
Replace] d
(d e
$stre k
,k l
idm o
.o p
ToStringp x
(x y
)y z
)z {
){ |
;| }
var 
builder 
= 
WebApplication 
. 
CreateBuilder *
(* +
args+ /
)/ 0
;0 1
builder 
. 
Services 
. #
AddEndpointsApiExplorer (
(( )
)) *
;* +
builder 
. 
Services 
. 
AddSwaggerGen 
( 
options  '
=>( *
{ 
options 
. !
AddSecurityDefinition !
(! "
$str" *
,* +
new, /!
OpenApiSecurityScheme0 E
{ 
Name 
= 
$str 
, 
Type 
= 
	Microsoft 
. 
OpenApi  
.  !
Models! '
.' (
SecuritySchemeType( :
.: ;
ApiKey; A
,A B
Scheme 
= 
$str 
, 
BearerFormat 
= 
$str 
, 
In 

= 
	Microsoft 
. 
OpenApi 
. 
Models %
.% &
ParameterLocation& 7
.7 8
Header8 >
,> ?
Description 
= 
$str 5
} 
) 
; 
options 
. "
AddSecurityRequirement "
(" #
new# &&
OpenApiSecurityRequirement' A
{ 
{   	
new!! !
OpenApiSecurityScheme!! %
{!!& '
	Reference!!( 1
=!!2 3
new!!4 7
OpenApiReference!!8 H
{!!I J
Type!!K O
=!!P Q
ReferenceType!!R _
.!!_ `
SecurityScheme!!` n
,!!n o
Id!!p r
=!!s t
$str!!u }
}!!} ~
}!!~ 
,	!! Ä
new
!!Å Ñ
string
!!Ö ã
[
!!ã å
]
!!å ç
{
!!é è
}
!!ê ë
}"" 	
}## 
)## 
;## 
}$$ 
)$$ 
;$$ 
builder&& 
.&& 
Services&& 
.&&  
RegisterDependencies&& %
(&&% &
)&&& '
;&&' (
builder(( 
.(( 
Services(( 
.(( 
AddAuthentication(( "
(((" #
$str((# +
)((+ ,
.)) 
AddJwtBearer)) 
()) 
$str)) 
,)) 
options)) #
=>))$ &
{** 
options++ 
.++ 
	Authority++ 
=++ 
$str++ 4
;++4 5
options,, 
.,, %
TokenValidationParameters,, )
=,,* +
new,,, /%
TokenValidationParameters,,0 I
{-- 	
ValidateAudience.. 
=.. 
false.. $
}// 	
;//	 

}00 
)00 
;00 
builder11 
.11 
Services11 
.11 
AddAuthorization11 !
(11! "
)11" #
;11# $
builder22 
.22 
Services22 
.22 +
AddApplicationInsightsTelemetry22 0
(220 1
builder221 8
.228 9
Configuration229 F
[22F G
$str22G n
]22n o
)22o p
;22p q
var44 
app44 
=44 	
builder44
 
.44 
Build44 
(44 
)44 
;44 
var66 
messagingService66 
=66 
app66 
.66 
Services66 #
.66# $

GetService66$ .
<66. /!
IItemMessagingService66/ D
>66D E
(66E F
)66F G
;66G H
messagingService77 
.77 
Start77 
(77 
)77 
;77 
if:: 
(:: 
app:: 
.:: 
Environment:: 
.:: 
IsDevelopment:: !
(::! "
)::" #
)::# $
{;; 
app<< 
.<< 

UseSwagger<< 
(<< 
)<< 
;<< 
app== 
.== 
UseSwaggerUI== 
(== 
)== 
;== 
}>> 
app@@ 
.@@ 
UseHttpsRedirection@@ 
(@@ 
)@@ 
;@@ 
appAA 
.AA 
UseAuthenticationAA 
(AA 
)AA 
;AA 
appBB 
.BB 
UseAuthorizationBB 
(BB 
)BB 
;BB 
constDD 
stringDD 

categoriesDD 
=DD 
$strDD '
;DD' (
constEE 
stringEE 
singleCategoryEE 
=EE 

categoriesEE (
+EE) *
$strEE+ 2
;EE2 3
constFF 
stringFF 
itemsFF 
=FF 
$strFF 
;FF 
constGG 
stringGG 

singleItemGG 
=GG 
itemsGG 
+GG  !
$strGG" )
;GG) *
appII 
.II 
MapGetII 

(II
 

categoriesII 
,II 
(II 
ICategoryServiceII (
categoryServiceII) 8
)II8 9
=>II: <
{JJ 
varKK 
resultKK 
=KK 
categoryServiceKK  
.KK  !
GetCategoriesKK! .
(KK. /
)KK/ 0
.KK0 1
SelectKK1 7
(KK7 8
cKK8 9
=>KK: <
newKK= @
{KKA B
CategoryKKC K
=KKL M
cKKN O
,KKO P
hrefKKQ U
=KKV W
getSingleResourceKKX i
(KKi j
cKKj k
.KKk l
IdKKl n
,KKn o
singleCategoryKKp ~
)KK~ 
}
KKÄ Å
)
KKÅ Ç
;
KKÇ É
returnLL 

ResultsLL 
.LL 
OkLL 
(LL 
resultLL 
)LL 
;LL 
}MM 
)MM 
;MM 
appOO 
.OO 
MapPostOO 
(OO 

categoriesOO 
,OO 
[OO 
	AuthorizeOO "
(OO" #
RolesOO# (
=OO) *
RolesOO+ 0
.OO0 1
ManagerOO1 8
)OO8 9
]OO9 :
(OO; <
CategoryOO< D
categoryOOE M
,OOM N
ICategoryServiceOOO _
categoryServiceOO` o
)OOo p
=>OOq s
{PP 
tryQQ 
{RR 
varSS 
resultSS 
=SS 
categoryServiceSS $
.SS$ %
AddCategorySS% 0
(SS0 1
categorySS1 9
.SS9 :
NameSS: >
,SS> ?
categorySS@ H
.SSH I
ImageSSI N
,SSN O
categorySSP X
.SSX Y
ParentCategorySSY g
)SSg h
;SSh i
varTT 
pathTT 
=TT 
getSingleResourceTT $
(TT$ %
categoryTT% -
.TT- .
IdTT. 0
,TT0 1
singleCategoryTT2 @
)TT@ A
;TTA B
returnUU 
ResultsUU 
.UU 
CreatedUU 
(UU 
pathUU #
,UU# $
resultUU% +
)UU+ ,
;UU, -
}VV 
catchWW 	
(WW	 

	ExceptionWW
 
eWW 
)WW 
{XX 
returnYY 
ResultsYY 
.YY 

BadRequestYY !
(YY! "
eYY" #
)YY# $
;YY$ %
}ZZ 
}[[ 
)[[ 
;[[ 
app]] 
.]] 
MapPut]] 

(]]
 
singleCategory]] 
,]] 
[]] 
	Authorize]] %
(]]% &
Roles]]& +
=]], -
Roles]]. 3
.]]3 4
Manager]]4 ;
)]]; <
]]]< =
(]]> ?
int]]? B
id]]C E
,]]E F
Category]]G O
category]]P X
,]]X Y
ICategoryService]]Z j
categoryService]]k z
)]]z {
=>]]| ~
{^^ 
try__ 
{`` 
categoryServiceaa 
.aa 
UpdateCategoryaa &
(aa& '
idaa' )
,aa) *
categoryaa+ 3
.aa3 4
Nameaa4 8
,aa8 9
categoryaa: B
.aaB C
ImageaaC H
,aaH I
categoryaaJ R
.aaR S
ParentCategoryaaS a
)aaa b
;aab c
returnbb 
Resultsbb 
.bb 
Okbb 
(bb 
)bb 
;bb 
}cc 
catchdd 	
(dd
 
CatalogExceptiondd 
edd 
)dd 
{ee 
returnff 
Resultsff 
.ff 
NotFoundff 
(ff  
)ff  !
;ff! "
}gg 
catchhh 	
(hh
 
	Exceptionhh 
ehh 
)hh 
{ii 
returnjj 
Resultsjj 
.jj 

BadRequestjj !
(jj! "
ejj" #
)jj# $
;jj$ %
}kk 
}ll 
)ll 
;ll 
appnn 
.nn 
	MapDeletenn 
(nn 
singleCategorynn 
,nn 
[nn 
	Authorizenn (
(nn( )
Rolesnn) .
=nn/ 0
Rolesnn1 6
.nn6 7
Managernn7 >
)nn> ?
]nn? @
(nnA B
intnnB E
idnnF H
,nnH I
ICategoryServicennJ Z
categoryServicenn[ j
)nnj k
=>nnl n
{oo 
trypp 
{qq 
categoryServicerr 
.rr 
DeleteCategoryrr &
(rr& '
idrr' )
)rr) *
;rr* +
returnss 
Resultsss 
.ss 
Okss 
(ss 
)ss 
;ss 
}tt 
catchuu 	
(uu
 
CatalogExceptionuu 
)uu 
{vv 
returnww 
Resultsww 
.ww 
NotFoundww 
(ww  
)ww  !
;ww! "
}xx 
catchyy 	
(yy
 
	Exceptionyy 
eyy 
)yy 
{zz 
return{{ 
Results{{ 
.{{ 

BadRequest{{ !
({{! "
e{{" #
){{# $
;{{$ %
}|| 
}}} 
)}} 
;}} 
app 
. 
MapGet 

(
 
items 
, 
( 
IItemService 
itemService  +
)+ ,
=>- /
{ÄÄ 
var
ÅÅ 
result
ÅÅ 
=
ÅÅ 
itemService
ÅÅ 
.
ÅÅ 
GetItems
ÅÅ %
(
ÅÅ% &
)
ÅÅ& '
.
ÅÅ' (
Select
ÅÅ( .
(
ÅÅ. /
i
ÅÅ/ 0
=>
ÅÅ1 3
new
ÅÅ4 7
{
ÅÅ8 9
Item
ÅÅ: >
=
ÅÅ? @
i
ÅÅA B
,
ÅÅB C
href
ÅÅD H
=
ÅÅI J
getSingleResource
ÅÅK \
(
ÅÅ\ ]
i
ÅÅ] ^
.
ÅÅ^ _
Id
ÅÅ_ a
,
ÅÅa b

singleItem
ÅÅc m
)
ÅÅm n
}
ÅÅo p
)
ÅÅp q
;
ÅÅq r
return
ÇÇ 

Results
ÇÇ 
.
ÇÇ 
Ok
ÇÇ 
(
ÇÇ 
result
ÇÇ 
)
ÇÇ 
;
ÇÇ 
}ÉÉ 
)
ÉÉ 
;
ÉÉ 
appÖÖ 
.
ÖÖ 
MapGet
ÖÖ 

(
ÖÖ
 

singleItem
ÖÖ 
+
ÖÖ 
$str
ÖÖ %
,
ÖÖ% &
(
ÖÖ' (
int
ÖÖ( +
id
ÖÖ, .
)
ÖÖ. /
=>
ÖÖ0 2
{ÜÜ 
var
áá 
result
áá 
=
áá 
new
áá 

Dictionary
áá 
<
áá  
string
áá  &
,
áá& '
string
áá( .
>
áá. /
{
àà 
{
ââ 	
$str
ââ
 
,
ââ 
$str
ââ 
}
ââ 
,
ââ 
{
ää 	
$str
ää
 
,
ää 
$str
ää 
}
ää 
}
ãã 
;
ãã 
return
çç 

Results
çç 
.
çç 
Ok
çç 
(
çç 
result
çç 
)
çç 
;
çç 
}éé 
)
éé 
;
éé 
appêê 
.
êê 
MapPost
êê 
(
êê 
items
êê 
,
êê 
[
êê 
	Authorize
êê 
(
êê 
Roles
êê #
=
êê$ %
Roles
êê& +
.
êê+ ,
Manager
êê, 3
)
êê3 4
]
êê4 5
(
êê6 7
Item
êê7 ;
item
êê< @
,
êê@ A
IItemService
êêB N
itemService
êêO Z
)
êêZ [
=>
êê\ ^
{ëë 
try
íí 
{
ìì 
var
îî 
result
îî 
=
îî 
itemService
îî  
.
îî  !
AddItem
îî! (
(
îî( )
item
îî) -
.
îî- .
Name
îî. 2
,
îî2 3
item
îî4 8
.
îî8 9
Description
îî9 D
,
îîD E
item
ïï 
.
ïï 
Image
ïï 
,
ïï 
item
ïï 
.
ïï 
Category
ïï %
,
ïï% &
item
ïï' +
.
ïï+ ,
Price
ïï, 1
,
ïï1 2
item
ïï3 7
.
ïï7 8
Amount
ïï8 >
)
ïï> ?
;
ïï? @
var
ññ 
path
ññ 
=
ññ 
getSingleResource
ññ $
(
ññ$ %
result
ññ% +
.
ññ+ ,
Id
ññ, .
,
ññ. /

singleItem
ññ0 :
)
ññ: ;
;
ññ; <
return
óó 
Results
óó 
.
óó 
Created
óó 
(
óó 
path
óó #
,
óó# $
result
óó% +
)
óó+ ,
;
óó, -
}
òò 
catch
ôô 	
(
ôô	 

	Exception
ôô
 
e
ôô 
)
ôô 
{
öö 
return
õõ 
Results
õõ 
.
õõ 

BadRequest
õõ !
(
õõ! "
e
õõ" #
)
õõ# $
;
õõ$ %
}
úú 
}ùù 
)
ùù 
;
ùù 
appüü 
.
üü 
MapGet
üü 

(
üü
 

singleItem
üü 
,
üü 
(
üü 
int
üü 
id
üü 
,
üü 
IItemService
üü  ,
itemService
üü- 8
)
üü8 9
=>
üü: <
{†† 
try
°° 
{
¢¢ 
var
££ 
item
££ 
=
££ 
itemService
££ 
.
££ 
GetItem
££ &
(
££& '
id
££' )
)
££) *
;
££* +
return
§§ 
Results
§§ 
.
§§ 
Ok
§§ 
(
§§ 
item
§§ 
)
§§ 
;
§§  
}
•• 
catch
¶¶ 	
(
¶¶
 
CatalogException
¶¶ 
)
¶¶ 
{
ßß 
return
®® 
Results
®® 
.
®® 
NotFound
®® 
(
®®  
)
®®  !
;
®®! "
}
©© 
catch
™™ 	
(
™™
 
	Exception
™™ 
e
™™ 
)
™™ 
{
´´ 
return
¨¨ 
Results
¨¨ 
.
¨¨ 

BadRequest
¨¨ !
(
¨¨! "
e
¨¨" #
)
¨¨# $
;
¨¨$ %
}
≠≠ 
}ÆÆ 
)
ÆÆ 
;
ÆÆ 
app±± 
.
±± 
MapPut
±± 

(
±±
 

singleItem
±± 
,
±± 
(
±± 
[
±± 
	FromRoute
±± "
]
±±" #
int
±±$ '
id
±±( *
,
±±* +
[
±±, -
FromBody
±±- 5
]
±±5 6
Item
±±7 ;
item
±±< @
,
±±@ A
HttpRequest
±±B M
request
±±N U
,
±±U V
IItemService
±±W c
itemService
±±d o
)
±±o p
=>
±±q s
{≤≤ 
try
≥≥ 
{
¥¥ 
var
∫∫ 
haveCorrelation
∫∫ 
=
∫∫ 
request
∫∫ %
.
∫∫% &
Headers
∫∫& -
.
∫∫- .
TryGetValue
∫∫. 9
(
∫∫9 :
$str
∫∫: O
,
∫∫O P
out
∫∫Q T
var
∫∫U X
correlation
∫∫Y d
)
∫∫d e
;
∫∫e f
itemService
ªª 
.
ªª 

UpdateItem
ªª 
(
ªª 
id
ªª !
,
ªª! "
item
ªª# '
.
ªª' (
Name
ªª( ,
,
ªª, -
item
ªª. 2
.
ªª2 3
Description
ªª3 >
,
ªª> ?
item
ºº 
.
ºº 
Image
ºº 
,
ºº 
item
ºº 
.
ºº 
Category
ºº %
,
ºº% &
item
ºº' +
.
ºº+ ,
Price
ºº, 1
,
ºº1 2
item
ºº3 7
.
ºº7 8
Amount
ºº8 >
,
ºº> ?
haveCorrelation
ºº@ O
?
ººP Q
correlation
ººR ]
:
ºº^ _
string
ºº` f
.
ººf g
Empty
ººg l
)
ººl m
;
ººm n
return
ΩΩ 
Results
ΩΩ 
.
ΩΩ 
Ok
ΩΩ 
(
ΩΩ 
)
ΩΩ 
;
ΩΩ 
}
ææ 
catch
øø 	
(
øø
 
CatalogException
øø 
e
øø 
)
øø 
{
¿¿ 
return
¡¡ 
Results
¡¡ 
.
¡¡ 
NotFound
¡¡ 
(
¡¡  
)
¡¡  !
;
¡¡! "
}
¬¬ 
catch
√√ 	
(
√√
 
	Exception
√√ 
e
√√ 
)
√√ 
{
ƒƒ 
return
≈≈ 
Results
≈≈ 
.
≈≈ 

BadRequest
≈≈ !
(
≈≈! "
e
≈≈" #
)
≈≈# $
;
≈≈$ %
}
∆∆ 
}«« 
)
«« 
;
«« 
app…… 
.
…… 
	MapDelete
…… 
(
…… 

singleItem
…… 
,
…… 
[
…… 
	Authorize
…… $
(
……$ %
Roles
……% *
=
……+ ,
Roles
……- 2
.
……2 3
Manager
……3 :
)
……: ;
]
……; <
(
……= >
int
……> A
id
……B D
,
……D E
IItemService
……F R
itemService
……S ^
)
……^ _
=>
……` b
{   
try
ÀÀ 
{
ÃÃ 
itemService
ÕÕ 
.
ÕÕ 

DeleteItem
ÕÕ 
(
ÕÕ 
id
ÕÕ !
)
ÕÕ! "
;
ÕÕ" #
return
ŒŒ 
Results
ŒŒ 
.
ŒŒ 
Ok
ŒŒ 
(
ŒŒ 
)
ŒŒ 
;
ŒŒ 
}
œœ 
catch
–– 	
(
––
 
CatalogException
–– 
e
–– 
)
–– 
{
—— 
return
““ 
Results
““ 
.
““ 
NotFound
““ 
(
““  
)
““  !
;
““! "
}
”” 
catch
‘‘ 	
(
‘‘
 
	Exception
‘‘ 
e
‘‘ 
)
‘‘ 
{
’’ 
return
÷÷ 
Results
÷÷ 
.
÷÷ 

BadRequest
÷÷ !
(
÷÷! "
e
÷÷" #
)
÷÷# $
;
÷÷$ %
}
◊◊ 
}ÿÿ 
)
ÿÿ 
;
ÿÿ 
app⁄⁄ 
.
⁄⁄ 
Run
⁄⁄ 
(
⁄⁄ 
)
⁄⁄ 	
;
⁄⁄	 
‡
àC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\CatalogService.API\Roles.cs
	namespace 	
CatalogService
 
. 
API 
{ 
public 

static 
class 
Roles 
{ 
public 
const 
string 
Manager #
=$ %
$str& /
;/ 0
public 
const 
string 
Buyer !
=" #
$str$ +
;+ ,
} 
} 