ü
åC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\CatalogService.API\APIModule.cs
	namespace 	
CatalogService
 
. 
API 
{ 
internal 
static 
class 
	APIModule #
{ 
public		 
static		 
IServiceCollection		 ( 
RegisterDependencies		) =
(		= >
this		> B
IServiceCollection		C U
services		V ^
)		^ _
{

 	
services 
. !
RegisterBusinessLayer &
(& '
)' (
. 
RegisterDataLayer "
(" #
)# $
. 
RegisterExchange !
(! "
)" #
;# $
return 
services 
; 
} 	
} 
} Õ†
äC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\CatalogService.API\Program.cs
var 
getSingleResource 
= 
new 
Func  
<  !
int! $
,$ %
string& ,
,, -
string. 4
>4 5
(5 6
(6 7
id7 9
,9 :
singleItemPath; I
)I J
=>K M
singleItemPathN \
.\ ]
Replace] d
(d e
$stre k
,k l
idm o
.o p
ToStringp x
(x y
)y z
)z {
){ |
;| }
var 
builder 
= 
WebApplication 
. 
CreateBuilder *
(* +
args+ /
)/ 0
;0 1
builder 
. 
Services 
. #
AddEndpointsApiExplorer (
(( )
)) *
;* +
builder 
. 
Services 
. 
AddSwaggerGen 
( 
options  '
=>( *
{ 
options 
. !
AddSecurityDefinition !
(! "
$str" *
,* +
new, /!
OpenApiSecurityScheme0 E
{ 
Name 
= 
$str 
, 
Type 
= 
	Microsoft 
. 
OpenApi  
.  !
Models! '
.' (
SecuritySchemeType( :
.: ;
ApiKey; A
,A B
Scheme 
= 
$str 
, 
BearerFormat 
= 
$str 
, 
In 

= 
	Microsoft 
. 
OpenApi 
. 
Models %
.% &
ParameterLocation& 7
.7 8
Header8 >
,> ?
Description 
= 
$str 5
} 
) 
; 
options 
. "
AddSecurityRequirement "
(" #
new# &&
OpenApiSecurityRequirement' A
{ 
{   	
new!! !
OpenApiSecurityScheme!! %
{!!& '
	Reference!!( 1
=!!2 3
new!!4 7
OpenApiReference!!8 H
{!!I J
Type!!K O
=!!P Q
ReferenceType!!R _
.!!_ `
SecurityScheme!!` n
,!!n o
Id!!p r
=!!s t
$str!!u }
}!!} ~
}!!~ 
,	!! Ä
new
!!Å Ñ
string
!!Ö ã
[
!!ã å
]
!!å ç
{
!!é è
}
!!ê ë
}"" 	
}## 
)## 
;## 
}$$ 
)$$ 
;$$ 
builder&& 
.&& 
Services&& 
.&&  
RegisterDependencies&& %
(&&% &
)&&& '
;&&' (
builder(( 
.(( 
Services(( 
.(( 
AddAuthentication(( "
(((" #
$str((# +
)((+ ,
.)) 
AddJwtBearer)) 
()) 
$str)) 
,)) 
options)) #
=>))$ &
{** 
options++ 
.++ 
	Authority++ 
=++ 
$str++ 4
;++4 5
options,, 
.,, %
TokenValidationParameters,, )
=,,* +
new,,, /%
TokenValidationParameters,,0 I
{-- 	
ValidateAudience.. 
=.. 
false.. $
}// 	
;//	 

}00 
)00 
;00 
builder11 
.11 
Services11 
.11 
AddAuthorization11 !
(11! "
)11" #
;11# $
builder22 
.22 
Services22 
.22 +
AddApplicationInsightsTelemetry22 0
(220 1
options221 8
=>229 ;
{33 
options44 
.44 
ConnectionString44 
=44 
builder44 &
.44& '
Configuration44' 4
[444 5
$str445 \
]44\ ]
;44] ^
}55 
)55 
;55 
var77 
app77 
=77 	
builder77
 
.77 
Build77 
(77 
)77 
;77 
var99 
messagingService99 
=99 
app99 
.99 
Services99 #
.99# $

GetService99$ .
<99. /!
IItemMessagingService99/ D
>99D E
(99E F
)99F G
;99G H
messagingService:: 
?:: 
.:: 
Start:: 
(:: 
):: 
;:: 
if== 
(== 
app== 
.== 
Environment== 
.== 
IsDevelopment== !
(==! "
)==" #
)==# $
{>> 
app?? 
.?? 

UseSwagger?? 
(?? 
)?? 
;?? 
app@@ 
.@@ 
UseSwaggerUI@@ 
(@@ 
)@@ 
;@@ 
}AA 
appCC 
.CC 
UseHttpsRedirectionCC 
(CC 
)CC 
;CC 
appDD 
.DD 
UseAuthenticationDD 
(DD 
)DD 
;DD 
appEE 
.EE 
UseAuthorizationEE 
(EE 
)EE 
;EE 
constGG 
stringGG 

categoriesGG 
=GG 
$strGG '
;GG' (
constHH 
stringHH 
singleCategoryHH 
=HH 

categoriesHH (
+HH) *
$strHH+ 2
;HH2 3
constII 
stringII 
itemsII 
=II 
$strII 
;II 
constJJ 
stringJJ 

singleItemJJ 
=JJ 
itemsJJ 
+JJ  !
$strJJ" )
;JJ) *
appLL 
.LL 
MapGetLL 

(LL
 

categoriesLL 
,LL 
(LL 
ICategoryServiceLL (
categoryServiceLL) 8
)LL8 9
=>LL: <
{MM 
varNN 
resultNN 
=NN 
categoryServiceNN  
.NN  !
GetCategoriesNN! .
(NN. /
)NN/ 0
.NN0 1
SelectNN1 7
(NN7 8
cNN8 9
=>NN: <
newNN= @
{NNA B
CategoryNNC K
=NNL M
cNNN O
,NNO P
hrefNNQ U
=NNV W
getSingleResourceNNX i
(NNi j
cNNj k
.NNk l
IdNNl n
,NNn o
singleCategoryNNp ~
)NN~ 
}
NNÄ Å
)
NNÅ Ç
;
NNÇ É
returnOO 

ResultsOO 
.OO 
OkOO 
(OO 
resultOO 
)OO 
;OO 
}PP 
)PP 
;PP 
appRR 
.RR 
MapPostRR 
(RR 

categoriesRR 
,RR 
[RR 
	AuthorizeRR "
(RR" #
RolesRR# (
=RR) *
RolesRR+ 0
.RR0 1
ManagerRR1 8
)RR8 9
]RR9 :
(RR; <
CategoryRR< D
categoryRRE M
,RRM N
ICategoryServiceRRO _
categoryServiceRR` o
)RRo p
=>RRq s
{SS 
tryTT 
{UU 
varVV 
resultVV 
=VV 
categoryServiceVV $
.VV$ %
AddCategoryVV% 0
(VV0 1
categoryVV1 9
.VV9 :
NameVV: >
,VV> ?
categoryVV@ H
.VVH I
ImageVVI N
,VVN O
categoryVVP X
.VVX Y
ParentCategoryVVY g
)VVg h
;VVh i
varWW 
pathWW 
=WW 
getSingleResourceWW $
(WW$ %
categoryWW% -
.WW- .
IdWW. 0
,WW0 1
singleCategoryWW2 @
)WW@ A
;WWA B
returnXX 
ResultsXX 
.XX 
CreatedXX 
(XX 
pathXX #
,XX# $
resultXX% +
)XX+ ,
;XX, -
}YY 
catchZZ 	
(ZZ	 

	ExceptionZZ
 
eZZ 
)ZZ 
{[[ 
return\\ 
Results\\ 
.\\ 

BadRequest\\ !
(\\! "
e\\" #
)\\# $
;\\$ %
}]] 
}^^ 
)^^ 
;^^ 
app`` 
.`` 
MapPut`` 

(``
 
singleCategory`` 
,`` 
[`` 
	Authorize`` %
(``% &
Roles``& +
=``, -
Roles``. 3
.``3 4
Manager``4 ;
)``; <
]``< =
(``> ?
int``? B
id``C E
,``E F
Category``G O
category``P X
,``X Y
ICategoryService``Z j
categoryService``k z
)``z {
=>``| ~
{aa 
trybb 
{cc 
categoryServicedd 
.dd 
UpdateCategorydd &
(dd& '
iddd' )
,dd) *
categorydd+ 3
.dd3 4
Namedd4 8
,dd8 9
categorydd: B
.ddB C
ImageddC H
,ddH I
categoryddJ R
.ddR S
ParentCategoryddS a
)dda b
;ddb c
returnee 
Resultsee 
.ee 
Okee 
(ee 
)ee 
;ee 
}ff 
catchgg 	
(gg
 
CatalogExceptiongg 
)gg 
{hh 
returnii 
Resultsii 
.ii 
NotFoundii 
(ii  
)ii  !
;ii! "
}jj 
catchkk 	
(kk
 
	Exceptionkk 
ekk 
)kk 
{ll 
returnmm 
Resultsmm 
.mm 

BadRequestmm !
(mm! "
emm" #
)mm# $
;mm$ %
}nn 
}oo 
)oo 
;oo 
appqq 
.qq 
	MapDeleteqq 
(qq 
singleCategoryqq 
,qq 
[qq 
	Authorizeqq (
(qq( )
Rolesqq) .
=qq/ 0
Rolesqq1 6
.qq6 7
Managerqq7 >
)qq> ?
]qq? @
(qqA B
intqqB E
idqqF H
,qqH I
ICategoryServiceqqJ Z
categoryServiceqq[ j
)qqj k
=>qql n
{rr 
tryss 
{tt 
categoryServiceuu 
.uu 
DeleteCategoryuu &
(uu& '
iduu' )
)uu) *
;uu* +
returnvv 
Resultsvv 
.vv 
Okvv 
(vv 
)vv 
;vv 
}ww 
catchxx 	
(xx
 
CatalogExceptionxx 
)xx 
{yy 
returnzz 
Resultszz 
.zz 
NotFoundzz 
(zz  
)zz  !
;zz! "
}{{ 
catch|| 	
(||
 
	Exception|| 
e|| 
)|| 
{}} 
return~~ 
Results~~ 
.~~ 

BadRequest~~ !
(~~! "
e~~" #
)~~# $
;~~$ %
} 
}ÄÄ 
)
ÄÄ 
;
ÄÄ 
appÇÇ 
.
ÇÇ 
MapGet
ÇÇ 

(
ÇÇ
 
items
ÇÇ 
,
ÇÇ 
(
ÇÇ 
IItemService
ÇÇ 
itemService
ÇÇ  +
)
ÇÇ+ ,
=>
ÇÇ- /
{ÉÉ 
var
ÑÑ 
result
ÑÑ 
=
ÑÑ 
itemService
ÑÑ 
.
ÑÑ 
GetItems
ÑÑ %
(
ÑÑ% &
)
ÑÑ& '
.
ÑÑ' (
Select
ÑÑ( .
(
ÑÑ. /
i
ÑÑ/ 0
=>
ÑÑ1 3
new
ÑÑ4 7
{
ÑÑ8 9
Item
ÑÑ: >
=
ÑÑ? @
i
ÑÑA B
,
ÑÑB C
href
ÑÑD H
=
ÑÑI J
getSingleResource
ÑÑK \
(
ÑÑ\ ]
i
ÑÑ] ^
.
ÑÑ^ _
Id
ÑÑ_ a
,
ÑÑa b

singleItem
ÑÑc m
)
ÑÑm n
}
ÑÑo p
)
ÑÑp q
;
ÑÑq r
return
ÖÖ 

Results
ÖÖ 
.
ÖÖ 
Ok
ÖÖ 
(
ÖÖ 
result
ÖÖ 
)
ÖÖ 
;
ÖÖ 
}ÜÜ 
)
ÜÜ 
;
ÜÜ 
appàà 
.
àà 
MapGet
àà 

(
àà
 

singleItem
àà 
+
àà 
$str
àà %
,
àà% &
(
àà' (
int
àà( +
id
àà, .
)
àà. /
=>
àà0 2
{ââ 
var
ää 
result
ää 
=
ää 
new
ää 

Dictionary
ää 
<
ää  
string
ää  &
,
ää& '
string
ää( .
>
ää. /
{
ãã 
{
åå 	
$str
åå
 
,
åå 
$str
åå 
}
åå 
,
åå 
{
çç 	
$str
çç
 
,
çç 
$str
çç 
}
çç 
}
éé 
;
éé 
return
êê 

Results
êê 
.
êê 
Ok
êê 
(
êê 
result
êê 
)
êê 
;
êê 
}ëë 
)
ëë 
;
ëë 
appìì 
.
ìì 
MapPost
ìì 
(
ìì 
items
ìì 
,
ìì 
[
ìì 
	Authorize
ìì 
(
ìì 
Roles
ìì #
=
ìì$ %
Roles
ìì& +
.
ìì+ ,
Manager
ìì, 3
)
ìì3 4
]
ìì4 5
(
ìì6 7
Item
ìì7 ;
item
ìì< @
,
ìì@ A
IItemService
ììB N
itemService
ììO Z
)
ììZ [
=>
ìì\ ^
{îî 
try
ïï 
{
ññ 
var
óó 
result
óó 
=
óó 
itemService
óó  
.
óó  !
AddItem
óó! (
(
óó( )
item
óó) -
.
óó- .
Name
óó. 2
,
óó2 3
item
óó4 8
.
óó8 9
Description
óó9 D
,
óóD E
item
òò 
.
òò 
Image
òò 
,
òò 
item
òò 
.
òò 
Category
òò %
,
òò% &
item
òò' +
.
òò+ ,
Price
òò, 1
,
òò1 2
item
òò3 7
.
òò7 8
Amount
òò8 >
)
òò> ?
;
òò? @
var
ôô 
path
ôô 
=
ôô 
getSingleResource
ôô $
(
ôô$ %
result
ôô% +
.
ôô+ ,
Id
ôô, .
,
ôô. /

singleItem
ôô0 :
)
ôô: ;
;
ôô; <
return
öö 
Results
öö 
.
öö 
Created
öö 
(
öö 
path
öö #
,
öö# $
result
öö% +
)
öö+ ,
;
öö, -
}
õõ 
catch
úú 	
(
úú	 

	Exception
úú
 
e
úú 
)
úú 
{
ùù 
return
ûû 
Results
ûû 
.
ûû 

BadRequest
ûû !
(
ûû! "
e
ûû" #
)
ûû# $
;
ûû$ %
}
üü 
}†† 
)
†† 
;
†† 
app¢¢ 
.
¢¢ 
MapGet
¢¢ 

(
¢¢
 

singleItem
¢¢ 
,
¢¢ 
(
¢¢ 
int
¢¢ 
id
¢¢ 
,
¢¢ 
IItemService
¢¢  ,
itemService
¢¢- 8
)
¢¢8 9
=>
¢¢: <
{££ 
try
§§ 
{
•• 
var
¶¶ 
item
¶¶ 
=
¶¶ 
itemService
¶¶ 
.
¶¶ 
GetItem
¶¶ &
(
¶¶& '
id
¶¶' )
)
¶¶) *
;
¶¶* +
return
ßß 
Results
ßß 
.
ßß 
Ok
ßß 
(
ßß 
item
ßß 
)
ßß 
;
ßß  
}
®® 
catch
©© 	
(
©©
 
CatalogException
©© 
)
©© 
{
™™ 
return
´´ 
Results
´´ 
.
´´ 
NotFound
´´ 
(
´´  
)
´´  !
;
´´! "
}
¨¨ 
catch
≠≠ 	
(
≠≠
 
	Exception
≠≠ 
e
≠≠ 
)
≠≠ 
{
ÆÆ 
return
ØØ 
Results
ØØ 
.
ØØ 

BadRequest
ØØ !
(
ØØ! "
e
ØØ" #
)
ØØ# $
;
ØØ$ %
}
∞∞ 
}±± 
)
±± 
;
±± 
app≥≥ 
.
≥≥ 
MapPut
≥≥ 

(
≥≥
 

singleItem
≥≥ 
,
≥≥ 
(
≥≥ 
[
≥≥ 
	FromRoute
≥≥ "
]
≥≥" #
int
≥≥$ '
id
≥≥( *
,
≥≥* +
[
≥≥, -
FromBody
≥≥- 5
]
≥≥5 6
Item
≥≥7 ;
item
≥≥< @
,
≥≥@ A
HttpRequest
≥≥B M
request
≥≥N U
,
≥≥U V
IItemService
≥≥W c
itemService
≥≥d o
)
≥≥o p
=>
≥≥q s
{¥¥ 
try
µµ 
{
∂∂ 
var
∑∑ 
haveCorrelation
∑∑ 
=
∑∑ 
request
∑∑ %
.
∑∑% &
Headers
∑∑& -
.
∑∑- .
TryGetValue
∑∑. 9
(
∑∑9 :
$str
∑∑: O
,
∑∑O P
out
∑∑Q T
var
∑∑U X
correlation
∑∑Y d
)
∑∑d e
;
∑∑e f
itemService
∏∏ 
.
∏∏ 

UpdateItem
∏∏ 
(
∏∏ 
id
∏∏ !
,
∏∏! "
item
∏∏# '
.
∏∏' (
Name
∏∏( ,
,
∏∏, -
item
∏∏. 2
.
∏∏2 3
Description
∏∏3 >
,
∏∏> ?
item
ππ 
.
ππ 
Image
ππ 
,
ππ 
item
ππ 
.
ππ 
Category
ππ %
,
ππ% &
item
ππ' +
.
ππ+ ,
Price
ππ, 1
,
ππ1 2
item
ππ3 7
.
ππ7 8
Amount
ππ8 >
,
ππ> ?
haveCorrelation
ππ@ O
?
ππP Q
correlation
ππR ]
:
ππ^ _
string
ππ` f
.
ππf g
Empty
ππg l
)
ππl m
;
ππm n
return
∫∫ 
Results
∫∫ 
.
∫∫ 
Ok
∫∫ 
(
∫∫ 
)
∫∫ 
;
∫∫ 
}
ªª 
catch
ºº 	
(
ºº
 
CatalogException
ºº 
)
ºº 
{
ΩΩ 
return
ææ 
Results
ææ 
.
ææ 
NotFound
ææ 
(
ææ  
)
ææ  !
;
ææ! "
}
øø 
catch
¿¿ 	
(
¿¿
 
	Exception
¿¿ 
e
¿¿ 
)
¿¿ 
{
¡¡ 
return
¬¬ 
Results
¬¬ 
.
¬¬ 

BadRequest
¬¬ !
(
¬¬! "
e
¬¬" #
)
¬¬# $
;
¬¬$ %
}
√√ 
}ƒƒ 
)
ƒƒ 
;
ƒƒ 
app∆∆ 
.
∆∆ 
	MapDelete
∆∆ 
(
∆∆ 

singleItem
∆∆ 
,
∆∆ 
[
∆∆ 
	Authorize
∆∆ $
(
∆∆$ %
Roles
∆∆% *
=
∆∆+ ,
Roles
∆∆- 2
.
∆∆2 3
Manager
∆∆3 :
)
∆∆: ;
]
∆∆; <
(
∆∆= >
int
∆∆> A
id
∆∆B D
,
∆∆D E
IItemService
∆∆F R
itemService
∆∆S ^
)
∆∆^ _
=>
∆∆` b
{«« 
try
»» 
{
…… 
itemService
   
.
   

DeleteItem
   
(
   
id
   !
)
  ! "
;
  " #
return
ÀÀ 
Results
ÀÀ 
.
ÀÀ 
Ok
ÀÀ 
(
ÀÀ 
)
ÀÀ 
;
ÀÀ 
}
ÃÃ 
catch
ÕÕ 	
(
ÕÕ
 
CatalogException
ÕÕ 
)
ÕÕ 
{
ŒŒ 
return
œœ 
Results
œœ 
.
œœ 
NotFound
œœ 
(
œœ  
)
œœ  !
;
œœ! "
}
–– 
catch
—— 	
(
——
 
	Exception
—— 
e
—— 
)
—— 
{
““ 
return
”” 
Results
”” 
.
”” 

BadRequest
”” !
(
””! "
e
””" #
)
””# $
;
””$ %
}
‘‘ 
}’’ 
)
’’ 
;
’’ 
app◊◊ 
.
◊◊ 
Run
◊◊ 
(
◊◊ 
)
◊◊ 	
;
◊◊	 
‡
àC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\CatalogService.API\Roles.cs
	namespace 	
CatalogService
 
. 
API 
{ 
public 

static 
class 
Roles 
{ 
public 
const 
string 
Manager #
=$ %
$str& /
;/ 0
public 
const 
string 
Buyer !
=" #
$str$ +
;+ ,
} 
} 