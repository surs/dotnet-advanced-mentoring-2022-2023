¬
ÖC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Config.cs
	namespace 	
IdentityServer
 
{		 
public

 

static

 
class

 
Config

 
{ 
public 
static 
IEnumerable !
<! "
IdentityResource" 2
>2 3
IdentityResources4 E
=>F H
new 
IdentityResource  
[  !
]! "
{ 
new 
IdentityResources %
.% &
OpenId& ,
(, -
)- .
,. /
new 
IdentityResources %
.% &
Profile& -
(- .
). /
,/ 0
} 
; 
public 
static 
IEnumerable !
<! "
ApiScope" *
>* +
	ApiScopes, 5
=>6 8
new 
ApiScope 
[ 
] 
{ 
new 
ApiScope 
( 
$str &
)& '
,' (
} 
; 
public 
static 
IEnumerable !
<! "
Client" (
>( )
Clients* 1
=>2 4
new 
Client 
[ 
] 
{ 
new 
Client 
{ 
ClientId 
= 
$str +
,+ ,

ClientName   
=    
$str  ! <
,  < =
AllowedGrantTypes"" %
=""& '

GrantTypes""( 2
.""2 3
ClientCredentials""3 D
,""D E
ClientSecrets## !
=##" #
{##$ %
new##& )
Secret##* 0
(##0 1
$str##1 W
.##W X
Sha256##X ^
(##^ _
)##_ `
)##` a
}##b c
,##c d
AllowedScopes%% !
=%%" #
{%%$ %
$str%%& .
,%%. /
$str%%0 9
}%%: ;
}&& 
,&& 
new)) 
Client)) 
{** 
ClientId++ 
=++ 
$str++ ,
,++, -
ClientSecrets,, !
=,," #
{,,$ %
new,,& )
Secret,,* 0
(,,0 1
$str,,1 W
.,,W X
Sha256,,X ^
(,,^ _
),,_ `
),,` a
},,b c
,,,c d
AllowedGrantTypes.. %
=..& '

GrantTypes..( 2
...2 3
Code..3 7
,..7 8
RedirectUris00  
=00! "
{00# $
$str00% J
}00K L
,00L M!
FrontChannelLogoutUri11 )
=11* +
$str11, R
,11R S"
PostLogoutRedirectUris22 *
=22+ ,
{22- .
$str22/ ^
}22_ `
,22` a
AllowOfflineAccess44 &
=44' (
true44) -
,44- .
AllowedScopes55 !
=55" #
{55$ %
$str55& .
,55. /
$str550 9
,559 :
$str55; D
}55E F
}66 
,66 
}77 
;77 
}88 
}99 Ú
ÜC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Program.cs
	namespace 	
IdentityServer
 
{ 
public 

class 
Program 
{ 
public 
static 
int 
Main 
( 
string %
[% &
]& '
args( ,
), -
{ 	
Log 
. 
Logger 
= 
new 
LoggerConfiguration 0
(0 1
)1 2
. 
MinimumLevel 
. 
Debug #
(# $
)$ %
. 
MinimumLevel 
. 
Override &
(& '
$str' 2
,2 3
LogEventLevel4 A
.A B
WarningB I
)I J
. 
MinimumLevel 
. 
Override &
(& '
$str' C
,C D
LogEventLevelE R
.R S
InformationS ^
)^ _
. 
MinimumLevel 
. 
Override &
(& '
$str' /
,/ 0
LogEventLevel1 >
.> ?
Warning? F
)F G
. 
MinimumLevel 
. 
Override &
(& '
$str' L
,L M
LogEventLevelN [
.[ \
Information\ g
)g h
. 
Enrich 
. 
FromLogContext &
(& '
)' (
.   
WriteTo   
.   
Console    
(    !
outputTemplate  ! /
:  / 0
$str	  1 ì
,
  ì î
theme
  ï ö
:
  ö õ
AnsiConsoleTheme
  ú ¨
.
  ¨ ≠
Code
  ≠ ±
)
  ± ≤
.!! 
CreateLogger!! 
(!! 
)!! 
;!!  
try## 
{$$ 
Log%% 
.%% 
Information%% 
(%%  
$str%%  2
)%%2 3
;%%3 4
CreateHostBuilder&& !
(&&! "
args&&" &
)&&& '
.&&' (
Build&&( -
(&&- .
)&&. /
.&&/ 0
Run&&0 3
(&&3 4
)&&4 5
;&&5 6
return'' 
$num'' 
;'' 
}(( 
catch)) 
()) 
	Exception)) 
ex)) 
)))  
{** 
Log++ 
.++ 
Fatal++ 
(++ 
ex++ 
,++ 
$str++ =
)++= >
;++> ?
return,, 
$num,, 
;,, 
}-- 
finally.. 
{// 
Log00 
.00 
CloseAndFlush00 !
(00! "
)00" #
;00# $
}11 
}22 	
public44 
static44 
IHostBuilder44 "
CreateHostBuilder44# 4
(444 5
string445 ;
[44; <
]44< =
args44> B
)44B C
=>44D F
Host55 
.55  
CreateDefaultBuilder55 %
(55% &
args55& *
)55* +
.66 

UseSerilog66 
(66 
)66 
.77 $
ConfigureWebHostDefaults77 )
(77) *

webBuilder77* 4
=>775 7
{88 

webBuilder99 
.99 

UseStartup99 )
<99) *
Startup99* 1
>991 2
(992 3
)993 4
;994 5
}:: 
):: 
;:: 
};; 
}<< öœ
£C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Account\AccountController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[ 
SecurityHeaders 
] 
[ 
AllowAnonymous 
] 
public 

class 
AccountController "
:# $

Controller% /
{ 
private   
readonly   
TestUserStore   &
_users  ' -
;  - .
private!! 
readonly!! -
!IIdentityServerInteractionService!! :
_interaction!!; G
;!!G H
private"" 
readonly"" 
IClientStore"" %
_clientStore""& 2
;""2 3
private## 
readonly## )
IAuthenticationSchemeProvider## 6
_schemeProvider##7 F
;##F G
private$$ 
readonly$$ 
IEventService$$ &
_events$$' .
;$$. /
public&& 
AccountController&&  
(&&  !-
!IIdentityServerInteractionService'' -
interaction''. 9
,''9 :
IClientStore(( 
clientStore(( $
,(($ %)
IAuthenticationSchemeProvider)) )
schemeProvider))* 8
,))8 9
IEventService** 
events**  
,**  !
TestUserStore++ 
users++ 
=++  !
null++" &
)++& '
{,, 	
_users// 
=// 
users// 
??// 
new// !
TestUserStore//" /
(/// 0
	TestUsers//0 9
.//9 :
Users//: ?
)//? @
;//@ A
_interaction11 
=11 
interaction11 &
;11& '
_clientStore22 
=22 
clientStore22 &
;22& '
_schemeProvider33 
=33 
schemeProvider33 ,
;33, -
_events44 
=44 
events44 
;44 
}55 	
[:: 	
HttpGet::	 
]:: 
public;; 
async;; 
Task;; 
<;; 
IActionResult;; '
>;;' (
Login;;) .
(;;. /
string;;/ 5
	returnUrl;;6 ?
);;? @
{<< 	
var>> 
vm>> 
=>> 
await>> $
BuildLoginViewModelAsync>> 3
(>>3 4
	returnUrl>>4 =
)>>= >
;>>> ?
if@@ 
(@@ 
vm@@ 
.@@ 
IsExternalLoginOnly@@ &
)@@& '
{AA 
returnCC 
RedirectToActionCC '
(CC' (
$strCC( 3
,CC3 4
$strCC5 ?
,CC? @
newCCA D
{CCE F
schemeCCG M
=CCN O
vmCCP R
.CCR S
ExternalLoginSchemeCCS f
,CCf g
	returnUrlCCh q
}CCr s
)CCs t
;CCt u
}DD 
returnFF 
ViewFF 
(FF 
vmFF 
)FF 
;FF 
}GG 	
[LL 	
HttpPostLL	 
]LL 
[MM 	$
ValidateAntiForgeryTokenMM	 !
]MM! "
publicNN 
asyncNN 
TaskNN 
<NN 
IActionResultNN '
>NN' (
LoginNN) .
(NN. /
LoginInputModelNN/ >
modelNN? D
,NND E
stringNNF L
buttonNNM S
)NNS T
{OO 	
varQQ 
contextQQ 
=QQ 
awaitQQ 
_interactionQQ  ,
.QQ, -(
GetAuthorizationContextAsyncQQ- I
(QQI J
modelQQJ O
.QQO P
	ReturnUrlQQP Y
)QQY Z
;QQZ [
ifTT 
(TT 
buttonTT 
!=TT 
$strTT !
)TT! "
{UU 
ifVV 
(VV 
contextVV 
!=VV 
nullVV #
)VV# $
{WW 
await[[ 
_interaction[[ &
.[[& '"
DenyAuthorizationAsync[[' =
([[= >
context[[> E
,[[E F
AuthorizationError[[G Y
.[[Y Z
AccessDenied[[Z f
)[[f g
;[[g h
if^^ 
(^^ 
context^^ 
.^^  
IsNativeClient^^  .
(^^. /
)^^/ 0
)^^0 1
{__ 
returnbb 
thisbb #
.bb# $
LoadingPagebb$ /
(bb/ 0
$strbb0 :
,bb: ;
modelbb< A
.bbA B
	ReturnUrlbbB K
)bbK L
;bbL M
}cc 
returnee 
Redirectee #
(ee# $
modelee$ )
.ee) *
	ReturnUrlee* 3
)ee3 4
;ee4 5
}ff 
elsegg 
{hh 
returnjj 
Redirectjj #
(jj# $
$strjj$ (
)jj( )
;jj) *
}kk 
}ll 
ifnn 
(nn 

ModelStatenn 
.nn 
IsValidnn "
)nn" #
{oo 
ifqq 
(qq 
_usersqq 
.qq 
ValidateCredentialsqq .
(qq. /
modelqq/ 4
.qq4 5
Usernameqq5 =
,qq= >
modelqq? D
.qqD E
PasswordqqE M
)qqM N
)qqN O
{rr 
varss 
userss 
=ss 
_usersss %
.ss% &
FindByUsernamess& 4
(ss4 5
modelss5 :
.ss: ;
Usernamess; C
)ssC D
;ssD E
awaittt 
_eventstt !
.tt! "

RaiseAsynctt" ,
(tt, -
newtt- 0!
UserLoginSuccessEventtt1 F
(ttF G
userttG K
.ttK L
UsernamettL T
,ttT U
userttV Z
.ttZ [
	SubjectIdtt[ d
,ttd e
userttf j
.ttj k
Usernamettk s
,tts t
clientIdttu }
:tt} ~
context	tt Ü
?
ttÜ á
.
ttá à
Client
ttà é
.
tté è
ClientId
ttè ó
)
ttó ò
)
ttò ô
;
ttô ö$
AuthenticationPropertiesxx ,
propsxx- 2
=xx3 4
nullxx5 9
;xx9 :
ifyy 
(yy 
AccountOptionsyy &
.yy& '
AllowRememberLoginyy' 9
&&yy: <
modelyy= B
.yyB C
RememberLoginyyC P
)yyP Q
{zz 
props{{ 
={{ 
new{{  #$
AuthenticationProperties{{$ <
{|| 
IsPersistent}} (
=}}) *
true}}+ /
,}}/ 0

ExpiresUtc~~ &
=~~' (
DateTimeOffset~~) 7
.~~7 8
UtcNow~~8 >
.~~> ?
Add~~? B
(~~B C
AccountOptions~~C Q
.~~Q R#
RememberMeLoginDuration~~R i
)~~i j
} 
; 
}
ÄÄ 
;
ÄÄ 
var
ÉÉ 
isuser
ÉÉ 
=
ÉÉ  
new
ÉÉ! $ 
IdentityServerUser
ÉÉ% 7
(
ÉÉ7 8
user
ÉÉ8 <
.
ÉÉ< =
	SubjectId
ÉÉ= F
)
ÉÉF G
{
ÑÑ 
DisplayName
ÖÖ #
=
ÖÖ$ %
user
ÖÖ& *
.
ÖÖ* +
Username
ÖÖ+ 3
}
ÜÜ 
;
ÜÜ 
await
àà 
HttpContext
àà %
.
àà% &
SignInAsync
àà& 1
(
àà1 2
isuser
àà2 8
,
àà8 9
props
àà: ?
)
àà? @
;
àà@ A
if
ää 
(
ää 
context
ää 
!=
ää  "
null
ää# '
)
ää' (
{
ãã 
if
åå 
(
åå 
context
åå #
.
åå# $
IsNativeClient
åå$ 2
(
åå2 3
)
åå3 4
)
åå4 5
{
çç 
return
êê "
this
êê# '
.
êê' (
LoadingPage
êê( 3
(
êê3 4
$str
êê4 >
,
êê> ?
model
êê@ E
.
êêE F
	ReturnUrl
êêF O
)
êêO P
;
êêP Q
}
ëë 
return
îî 
Redirect
îî '
(
îî' (
model
îî( -
.
îî- .
	ReturnUrl
îî. 7
)
îî7 8
;
îî8 9
}
ïï 
if
òò 
(
òò 
Url
òò 
.
òò 

IsLocalUrl
òò &
(
òò& '
model
òò' ,
.
òò, -
	ReturnUrl
òò- 6
)
òò6 7
)
òò7 8
{
ôô 
return
öö 
Redirect
öö '
(
öö' (
model
öö( -
.
öö- .
	ReturnUrl
öö. 7
)
öö7 8
;
öö8 9
}
õõ 
else
úú 
if
úú 
(
úú 
string
úú #
.
úú# $
IsNullOrEmpty
úú$ 1
(
úú1 2
model
úú2 7
.
úú7 8
	ReturnUrl
úú8 A
)
úúA B
)
úúB C
{
ùù 
return
ûû 
Redirect
ûû '
(
ûû' (
$str
ûû( ,
)
ûû, -
;
ûû- .
}
üü 
else
†† 
{
°° 
throw
££ 
new
££ !
	Exception
££" +
(
££+ ,
$str
££, @
)
££@ A
;
££A B
}
§§ 
}
•• 
await
ßß 
_events
ßß 
.
ßß 

RaiseAsync
ßß (
(
ßß( )
new
ßß) ,#
UserLoginFailureEvent
ßß- B
(
ßßB C
model
ßßC H
.
ßßH I
Username
ßßI Q
,
ßßQ R
$str
ßßS h
,
ßßh i
clientId
ßßj r
:
ßßr s
context
ßßt {
?
ßß{ |
.
ßß| }
Clientßß} É
.ßßÉ Ñ
ClientIdßßÑ å
)ßßå ç
)ßßç é
;ßßé è

ModelState
®® 
.
®® 
AddModelError
®® (
(
®®( )
string
®®) /
.
®®/ 0
Empty
®®0 5
,
®®5 6
AccountOptions
®®7 E
.
®®E F,
InvalidCredentialsErrorMessage
®®F d
)
®®d e
;
®®e f
}
©© 
var
¨¨ 
vm
¨¨ 
=
¨¨ 
await
¨¨ &
BuildLoginViewModelAsync
¨¨ 3
(
¨¨3 4
model
¨¨4 9
)
¨¨9 :
;
¨¨: ;
return
≠≠ 
View
≠≠ 
(
≠≠ 
vm
≠≠ 
)
≠≠ 
;
≠≠ 
}
ÆÆ 	
[
¥¥ 	
HttpGet
¥¥	 
]
¥¥ 
public
µµ 
async
µµ 
Task
µµ 
<
µµ 
IActionResult
µµ '
>
µµ' (
Logout
µµ) /
(
µµ/ 0
string
µµ0 6
logoutId
µµ7 ?
)
µµ? @
{
∂∂ 	
var
∏∏ 
vm
∏∏ 
=
∏∏ 
await
∏∏ '
BuildLogoutViewModelAsync
∏∏ 4
(
∏∏4 5
logoutId
∏∏5 =
)
∏∏= >
;
∏∏> ?
if
∫∫ 
(
∫∫ 
vm
∫∫ 
.
∫∫ 
ShowLogoutPrompt
∫∫ #
==
∫∫$ &
false
∫∫' ,
)
∫∫, -
{
ªª 
return
ææ 
await
ææ 
Logout
ææ #
(
ææ# $
vm
ææ$ &
)
ææ& '
;
ææ' (
}
øø 
return
¡¡ 
View
¡¡ 
(
¡¡ 
vm
¡¡ 
)
¡¡ 
;
¡¡ 
}
¬¬ 	
[
«« 	
HttpPost
««	 
]
«« 
[
»» 	&
ValidateAntiForgeryToken
»»	 !
]
»»! "
public
…… 
async
…… 
Task
…… 
<
…… 
IActionResult
…… '
>
……' (
Logout
……) /
(
……/ 0
LogoutInputModel
……0 @
model
……A F
)
……F G
{
   	
var
ÃÃ 
vm
ÃÃ 
=
ÃÃ 
await
ÃÃ *
BuildLoggedOutViewModelAsync
ÃÃ 7
(
ÃÃ7 8
model
ÃÃ8 =
.
ÃÃ= >
LogoutId
ÃÃ> F
)
ÃÃF G
;
ÃÃG H
if
ŒŒ 
(
ŒŒ 
User
ŒŒ 
?
ŒŒ 
.
ŒŒ 
Identity
ŒŒ 
.
ŒŒ 
IsAuthenticated
ŒŒ .
==
ŒŒ/ 1
true
ŒŒ2 6
)
ŒŒ6 7
{
œœ 
await
—— 
HttpContext
—— !
.
——! "
SignOutAsync
——" .
(
——. /
)
——/ 0
;
——0 1
await
‘‘ 
_events
‘‘ 
.
‘‘ 

RaiseAsync
‘‘ (
(
‘‘( )
new
‘‘) ,$
UserLogoutSuccessEvent
‘‘- C
(
‘‘C D
User
‘‘D H
.
‘‘H I
GetSubjectId
‘‘I U
(
‘‘U V
)
‘‘V W
,
‘‘W X
User
‘‘Y ]
.
‘‘] ^
GetDisplayName
‘‘^ l
(
‘‘l m
)
‘‘m n
)
‘‘n o
)
‘‘o p
;
‘‘p q
}
’’ 
if
ÿÿ 
(
ÿÿ 
vm
ÿÿ 
.
ÿÿ $
TriggerExternalSignout
ÿÿ )
)
ÿÿ) *
{
ŸŸ 
string
›› 
url
›› 
=
›› 
Url
››  
.
››  !
Action
››! '
(
››' (
$str
››( 0
,
››0 1
new
››2 5
{
››6 7
logoutId
››8 @
=
››A B
vm
››C E
.
››E F
LogoutId
››F N
}
››O P
)
››P Q
;
››Q R
return
‡‡ 
SignOut
‡‡ 
(
‡‡ 
new
‡‡ "&
AuthenticationProperties
‡‡# ;
{
‡‡< =
RedirectUri
‡‡> I
=
‡‡J K
url
‡‡L O
}
‡‡P Q
,
‡‡Q R
vm
‡‡S U
.
‡‡U V*
ExternalAuthenticationScheme
‡‡V r
)
‡‡r s
;
‡‡s t
}
·· 
return
„„ 
View
„„ 
(
„„ 
$str
„„ #
,
„„# $
vm
„„% '
)
„„' (
;
„„( )
}
‰‰ 	
[
ÊÊ 	
HttpGet
ÊÊ	 
]
ÊÊ 
public
ÁÁ 
IActionResult
ÁÁ 
AccessDenied
ÁÁ )
(
ÁÁ) *
)
ÁÁ* +
{
ËË 	
return
ÈÈ 
View
ÈÈ 
(
ÈÈ 
)
ÈÈ 
;
ÈÈ 
}
ÍÍ 	
private
 
async
 
Task
 
<
 
LoginViewModel
 )
>
) *&
BuildLoginViewModelAsync
+ C
(
C D
string
D J
	returnUrl
K T
)
T U
{
ÒÒ 	
var
ÚÚ 
context
ÚÚ 
=
ÚÚ 
await
ÚÚ 
_interaction
ÚÚ  ,
.
ÚÚ, -*
GetAuthorizationContextAsync
ÚÚ- I
(
ÚÚI J
	returnUrl
ÚÚJ S
)
ÚÚS T
;
ÚÚT U
if
ÛÛ 
(
ÛÛ 
context
ÛÛ 
?
ÛÛ 
.
ÛÛ 
IdP
ÛÛ 
!=
ÛÛ 
null
ÛÛ  $
&&
ÛÛ% '
await
ÛÛ( -
_schemeProvider
ÛÛ. =
.
ÛÛ= >
GetSchemeAsync
ÛÛ> L
(
ÛÛL M
context
ÛÛM T
.
ÛÛT U
IdP
ÛÛU X
)
ÛÛX Y
!=
ÛÛZ \
null
ÛÛ] a
)
ÛÛa b
{
ÙÙ 
var
ıı 
local
ıı 
=
ıı 
context
ıı #
.
ıı# $
IdP
ıı$ '
==
ıı( *
IdentityServer4
ıı+ :
.
ıı: ;%
IdentityServerConstants
ıı; R
.
ııR S#
LocalIdentityProvider
ııS h
;
ııh i
var
¯¯ 
vm
¯¯ 
=
¯¯ 
new
¯¯ 
LoginViewModel
¯¯ +
{
˘˘ 
EnableLocalLogin
˙˙ $
=
˙˙% &
local
˙˙' ,
,
˙˙, -
	ReturnUrl
˚˚ 
=
˚˚ 
	returnUrl
˚˚  )
,
˚˚) *
Username
¸¸ 
=
¸¸ 
context
¸¸ &
?
¸¸& '
.
¸¸' (
	LoginHint
¸¸( 1
,
¸¸1 2
}
˝˝ 
;
˝˝ 
if
ˇˇ 
(
ˇˇ 
!
ˇˇ 
local
ˇˇ 
)
ˇˇ 
{
ÄÄ 
vm
ÅÅ 
.
ÅÅ 
ExternalProviders
ÅÅ (
=
ÅÅ) *
new
ÅÅ+ .
[
ÅÅ. /
]
ÅÅ/ 0
{
ÅÅ1 2
new
ÅÅ3 6
ExternalProvider
ÅÅ7 G
{
ÅÅH I"
AuthenticationScheme
ÅÅJ ^
=
ÅÅ_ `
context
ÅÅa h
.
ÅÅh i
IdP
ÅÅi l
}
ÅÅm n
}
ÅÅo p
;
ÅÅp q
}
ÇÇ 
return
ÑÑ 
vm
ÑÑ 
;
ÑÑ 
}
ÖÖ 
var
áá 
schemes
áá 
=
áá 
await
áá 
_schemeProvider
áá  /
.
áá/ 0 
GetAllSchemesAsync
áá0 B
(
ááB C
)
ááC D
;
ááD E
var
ââ 
	providers
ââ 
=
ââ 
schemes
ââ #
.
ää 
Where
ää 
(
ää 
x
ää 
=>
ää 
x
ää 
.
ää 
DisplayName
ää )
!=
ää* ,
null
ää- 1
)
ää1 2
.
ãã 
Select
ãã 
(
ãã 
x
ãã 
=>
ãã 
new
ãã  
ExternalProvider
ãã! 1
{
åå 
DisplayName
çç 
=
çç  !
x
çç" #
.
çç# $
DisplayName
çç$ /
??
çç0 2
x
çç3 4
.
çç4 5
Name
çç5 9
,
çç9 :"
AuthenticationScheme
éé (
=
éé) *
x
éé+ ,
.
éé, -
Name
éé- 1
}
èè 
)
èè 
.
èè 
ToList
èè 
(
èè 
)
èè 
;
èè 
var
ëë 

allowLocal
ëë 
=
ëë 
true
ëë !
;
ëë! "
if
íí 
(
íí 
context
íí 
?
íí 
.
íí 
Client
íí 
.
íí  
ClientId
íí  (
!=
íí) +
null
íí, 0
)
íí0 1
{
ìì 
var
îî 
client
îî 
=
îî 
await
îî "
_clientStore
îî# /
.
îî/ 0(
FindEnabledClientByIdAsync
îî0 J
(
îîJ K
context
îîK R
.
îîR S
Client
îîS Y
.
îîY Z
ClientId
îîZ b
)
îîb c
;
îîc d
if
ïï 
(
ïï 
client
ïï 
!=
ïï 
null
ïï "
)
ïï" #
{
ññ 

allowLocal
óó 
=
óó  
client
óó! '
.
óó' (
EnableLocalLogin
óó( 8
;
óó8 9
if
ôô 
(
ôô 
client
ôô 
.
ôô *
IdentityProviderRestrictions
ôô ;
!=
ôô< >
null
ôô? C
&&
ôôD F
client
ôôG M
.
ôôM N*
IdentityProviderRestrictions
ôôN j
.
ôôj k
Any
ôôk n
(
ôôn o
)
ôôo p
)
ôôp q
{
öö 
	providers
õõ !
=
õõ" #
	providers
õõ$ -
.
õõ- .
Where
õõ. 3
(
õõ3 4
provider
õõ4 <
=>
õõ= ?
client
õõ@ F
.
õõF G*
IdentityProviderRestrictions
õõG c
.
õõc d
Contains
õõd l
(
õõl m
provider
õõm u
.
õõu v#
AuthenticationSchemeõõv ä
)õõä ã
)õõã å
.õõå ç
ToListõõç ì
(õõì î
)õõî ï
;õõï ñ
}
úú 
}
ùù 
}
ûû 
return
†† 
new
†† 
LoginViewModel
†† %
{
°°  
AllowRememberLogin
¢¢ "
=
¢¢# $
AccountOptions
¢¢% 3
.
¢¢3 4 
AllowRememberLogin
¢¢4 F
,
¢¢F G
EnableLocalLogin
££  
=
££! "

allowLocal
££# -
&&
££. 0
AccountOptions
££1 ?
.
££? @
AllowLocalLogin
££@ O
,
££O P
	ReturnUrl
§§ 
=
§§ 
	returnUrl
§§ %
,
§§% &
Username
•• 
=
•• 
context
•• "
?
••" #
.
••# $
	LoginHint
••$ -
,
••- .
ExternalProviders
¶¶ !
=
¶¶" #
	providers
¶¶$ -
.
¶¶- .
ToArray
¶¶. 5
(
¶¶5 6
)
¶¶6 7
}
ßß 
;
ßß 
}
®® 	
private
™™ 
async
™™ 
Task
™™ 
<
™™ 
LoginViewModel
™™ )
>
™™) *&
BuildLoginViewModelAsync
™™+ C
(
™™C D
LoginInputModel
™™D S
model
™™T Y
)
™™Y Z
{
´´ 	
var
¨¨ 
vm
¨¨ 
=
¨¨ 
await
¨¨ &
BuildLoginViewModelAsync
¨¨ 3
(
¨¨3 4
model
¨¨4 9
.
¨¨9 :
	ReturnUrl
¨¨: C
)
¨¨C D
;
¨¨D E
vm
≠≠ 
.
≠≠ 
Username
≠≠ 
=
≠≠ 
model
≠≠ 
.
≠≠  
Username
≠≠  (
;
≠≠( )
vm
ÆÆ 
.
ÆÆ 
RememberLogin
ÆÆ 
=
ÆÆ 
model
ÆÆ $
.
ÆÆ$ %
RememberLogin
ÆÆ% 2
;
ÆÆ2 3
return
ØØ 
vm
ØØ 
;
ØØ 
}
∞∞ 	
private
≤≤ 
async
≤≤ 
Task
≤≤ 
<
≤≤ 
LogoutViewModel
≤≤ *
>
≤≤* +'
BuildLogoutViewModelAsync
≤≤, E
(
≤≤E F
string
≤≤F L
logoutId
≤≤M U
)
≤≤U V
{
≥≥ 	
var
¥¥ 
vm
¥¥ 
=
¥¥ 
new
¥¥ 
LogoutViewModel
¥¥ (
{
¥¥) *
LogoutId
¥¥+ 3
=
¥¥4 5
logoutId
¥¥6 >
,
¥¥> ?
ShowLogoutPrompt
¥¥@ P
=
¥¥Q R
AccountOptions
¥¥S a
.
¥¥a b
ShowLogoutPrompt
¥¥b r
}
¥¥s t
;
¥¥t u
if
∂∂ 
(
∂∂ 
User
∂∂ 
?
∂∂ 
.
∂∂ 
Identity
∂∂ 
.
∂∂ 
IsAuthenticated
∂∂ .
!=
∂∂/ 1
true
∂∂2 6
)
∂∂6 7
{
∑∑ 
vm
ππ 
.
ππ 
ShowLogoutPrompt
ππ #
=
ππ$ %
false
ππ& +
;
ππ+ ,
return
∫∫ 
vm
∫∫ 
;
∫∫ 
}
ªª 
var
ΩΩ 
context
ΩΩ 
=
ΩΩ 
await
ΩΩ 
_interaction
ΩΩ  ,
.
ΩΩ, -#
GetLogoutContextAsync
ΩΩ- B
(
ΩΩB C
logoutId
ΩΩC K
)
ΩΩK L
;
ΩΩL M
if
ææ 
(
ææ 
context
ææ 
?
ææ 
.
ææ 
ShowSignoutPrompt
ææ *
==
ææ+ -
false
ææ. 3
)
ææ3 4
{
øø 
vm
¡¡ 
.
¡¡ 
ShowLogoutPrompt
¡¡ #
=
¡¡$ %
false
¡¡& +
;
¡¡+ ,
return
¬¬ 
vm
¬¬ 
;
¬¬ 
}
√√ 
return
«« 
vm
«« 
;
«« 
}
»» 	
private
   
async
   
Task
   
<
    
LoggedOutViewModel
   -
>
  - .*
BuildLoggedOutViewModelAsync
  / K
(
  K L
string
  L R
logoutId
  S [
)
  [ \
{
ÀÀ 	
var
ÕÕ 
logout
ÕÕ 
=
ÕÕ 
await
ÕÕ 
_interaction
ÕÕ +
.
ÕÕ+ ,#
GetLogoutContextAsync
ÕÕ, A
(
ÕÕA B
logoutId
ÕÕB J
)
ÕÕJ K
;
ÕÕK L
var
œœ 
vm
œœ 
=
œœ 
new
œœ  
LoggedOutViewModel
œœ +
{
–– +
AutomaticRedirectAfterSignOut
—— -
=
——. /
AccountOptions
——0 >
.
——> ?+
AutomaticRedirectAfterSignOut
——? \
,
——\ ]#
PostLogoutRedirectUri
““ %
=
““& '
logout
““( .
?
““. /
.
““/ 0#
PostLogoutRedirectUri
““0 E
,
““E F

ClientName
”” 
=
”” 
string
”” #
.
””# $
IsNullOrEmpty
””$ 1
(
””1 2
logout
””2 8
?
””8 9
.
””9 :

ClientName
””: D
)
””D E
?
””F G
logout
””H N
?
””N O
.
””O P
ClientId
””P X
:
””Y Z
logout
””[ a
?
””a b
.
””b c

ClientName
””c m
,
””m n
SignOutIframeUrl
‘‘  
=
‘‘! "
logout
‘‘# )
?
‘‘) *
.
‘‘* +
SignOutIFrameUrl
‘‘+ ;
,
‘‘; <
LogoutId
’’ 
=
’’ 
logoutId
’’ #
}
÷÷ 
;
÷÷ 
if
ÿÿ 
(
ÿÿ 
User
ÿÿ 
?
ÿÿ 
.
ÿÿ 
Identity
ÿÿ 
.
ÿÿ 
IsAuthenticated
ÿÿ .
==
ÿÿ/ 1
true
ÿÿ2 6
)
ÿÿ6 7
{
ŸŸ 
var
⁄⁄ 
idp
⁄⁄ 
=
⁄⁄ 
User
⁄⁄ 
.
⁄⁄ 
	FindFirst
⁄⁄ (
(
⁄⁄( )
JwtClaimTypes
⁄⁄) 6
.
⁄⁄6 7
IdentityProvider
⁄⁄7 G
)
⁄⁄G H
?
⁄⁄H I
.
⁄⁄I J
Value
⁄⁄J O
;
⁄⁄O P
if
€€ 
(
€€ 
idp
€€ 
!=
€€ 
null
€€ 
&&
€€  "
idp
€€# &
!=
€€' )
IdentityServer4
€€* 9
.
€€9 :%
IdentityServerConstants
€€: Q
.
€€Q R#
LocalIdentityProvider
€€R g
)
€€g h
{
‹‹ 
var
›› %
providerSupportsSignout
›› /
=
››0 1
await
››2 7
HttpContext
››8 C
.
››C D+
GetSchemeSupportsSignOutAsync
››D a
(
››a b
idp
››b e
)
››e f
;
››f g
if
ﬁﬁ 
(
ﬁﬁ %
providerSupportsSignout
ﬁﬁ /
)
ﬁﬁ/ 0
{
ﬂﬂ 
if
‡‡ 
(
‡‡ 
vm
‡‡ 
.
‡‡ 
LogoutId
‡‡ '
==
‡‡( *
null
‡‡+ /
)
‡‡/ 0
{
·· 
vm
ÂÂ 
.
ÂÂ 
LogoutId
ÂÂ '
=
ÂÂ( )
await
ÂÂ* /
_interaction
ÂÂ0 <
.
ÂÂ< =&
CreateLogoutContextAsync
ÂÂ= U
(
ÂÂU V
)
ÂÂV W
;
ÂÂW X
}
ÊÊ 
vm
ËË 
.
ËË *
ExternalAuthenticationScheme
ËË 7
=
ËË8 9
idp
ËË: =
;
ËË= >
}
ÈÈ 
}
ÍÍ 
}
ÎÎ 
return
ÌÌ 
vm
ÌÌ 
;
ÌÌ 
}
ÓÓ 	
}
ÔÔ 
} Ã

†C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Account\AccountOptions.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public		 

class		 
AccountOptions		 
{

 
public 
static 
bool 
AllowLocalLogin *
=+ ,
true- 1
;1 2
public 
static 
bool 
AllowRememberLogin -
=. /
true0 4
;4 5
public 
static 
TimeSpan #
RememberMeLoginDuration 6
=7 8
TimeSpan9 A
.A B
FromDaysB J
(J K
$numK M
)M N
;N O
public 
static 
bool 
ShowLogoutPrompt +
=, -
true. 2
;2 3
public 
static 
bool )
AutomaticRedirectAfterSignOut 8
=9 :
false; @
;@ A
public 
static 
string *
InvalidCredentialsErrorMessage ;
=< =
$str> \
;\ ]
} 
} Óu
§C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Account\ExternalController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[ 
SecurityHeaders 
] 
[ 
AllowAnonymous 
] 
public 

class 
ExternalController #
:$ %

Controller& 0
{ 
private 
readonly 
TestUserStore &
_users' -
;- .
private 
readonly -
!IIdentityServerInteractionService :
_interaction; G
;G H
private 
readonly 
IClientStore %
_clientStore& 2
;2 3
private 
readonly 
ILogger  
<  !
ExternalController! 3
>3 4
_logger5 <
;< =
private 
readonly 
IEventService &
_events' .
;. /
public 
ExternalController !
(! "-
!IIdentityServerInteractionService -
interaction. 9
,9 :
IClientStore   
clientStore   $
,  $ %
IEventService!! 
events!!  
,!!  !
ILogger"" 
<"" 
ExternalController"" &
>""& '
logger""( .
,"". /
TestUserStore## 
users## 
=##  !
null##" &
)##& '
{$$ 	
_users'' 
='' 
users'' 
??'' 
new'' !
TestUserStore''" /
(''/ 0
	TestUsers''0 9
.''9 :
Users'': ?
)''? @
;''@ A
_interaction)) 
=)) 
interaction)) &
;))& '
_clientStore** 
=** 
clientStore** &
;**& '
_logger++ 
=++ 
logger++ 
;++ 
_events,, 
=,, 
events,, 
;,, 
}-- 	
[22 	
HttpGet22	 
]22 
public33 
IActionResult33 
	Challenge33 &
(33& '
string33' -
scheme33. 4
,334 5
string336 <
	returnUrl33= F
)33F G
{44 	
if55 
(55 
string55 
.55 
IsNullOrEmpty55 $
(55$ %
	returnUrl55% .
)55. /
)55/ 0
	returnUrl551 :
=55; <
$str55= A
;55A B
if88 
(88 
Url88 
.88 

IsLocalUrl88 
(88 
	returnUrl88 (
)88( )
==88* ,
false88- 2
&&883 5
_interaction886 B
.88B C
IsValidReturnUrl88C S
(88S T
	returnUrl88T ]
)88] ^
==88_ a
false88b g
)88g h
{99 
throw;; 
new;; 
	Exception;; #
(;;# $
$str;;$ 8
);;8 9
;;;9 :
}<< 
var?? 
props?? 
=?? 
new?? $
AuthenticationProperties?? 4
{@@ 
RedirectUriAA 
=AA 
UrlAA !
.AA! "
ActionAA" (
(AA( )
nameofAA) /
(AA/ 0
CallbackAA0 8
)AA8 9
)AA9 :
,AA: ;
ItemsBB 
=BB 
{CC 
{DD 
$strDD !
,DD! "
	returnUrlDD# ,
}DD- .
,DD. /
{EE 
$strEE 
,EE 
schemeEE  &
}EE' (
,EE( )
}FF 
}GG 
;GG 
returnII 
	ChallengeII 
(II 
propsII "
,II" #
schemeII$ *
)II* +
;II+ ,
}KK 	
[PP 	
HttpGetPP	 
]PP 
publicQQ 
asyncQQ 
TaskQQ 
<QQ 
IActionResultQQ '
>QQ' (
CallbackQQ) 1
(QQ1 2
)QQ2 3
{RR 	
varTT 
resultTT 
=TT 
awaitTT 
HttpContextTT *
.TT* +
AuthenticateAsyncTT+ <
(TT< =#
IdentityServerConstantsTT= T
.TTT U.
"ExternalCookieAuthenticationSchemeTTU w
)TTw x
;TTx y
ifUU 
(UU 
resultUU 
?UU 
.UU 
	SucceededUU !
!=UU" $
trueUU% )
)UU) *
{VV 
throwWW 
newWW 
	ExceptionWW #
(WW# $
$strWW$ C
)WWC D
;WWD E
}XX 
ifZZ 
(ZZ 
_loggerZZ 
.ZZ 
	IsEnabledZZ !
(ZZ! "
LogLevelZZ" *
.ZZ* +
DebugZZ+ 0
)ZZ0 1
)ZZ1 2
{[[ 
var\\ 
externalClaims\\ "
=\\# $
result\\% +
.\\+ ,
	Principal\\, 5
.\\5 6
Claims\\6 <
.\\< =
Select\\= C
(\\C D
c\\D E
=>\\F H
$"\\I K
{\\K L
c\\L M
.\\M N
Type\\N R
}\\R S
$str\\S U
{\\U V
c\\V W
.\\W X
Value\\X ]
}\\] ^
"\\^ _
)\\_ `
;\\` a
_logger]] 
.]] 
LogDebug]]  
(]]  !
$str]]! =
,]]= >
externalClaims]]? M
)]]M N
;]]N O
}^^ 
varaa 
(aa 
useraa 
,aa 
provideraa 
,aa  
providerUserIdaa! /
,aa/ 0
claimsaa1 7
)aa7 8
=aa9 :(
FindUserFromExternalProvideraa; W
(aaW X
resultaaX ^
)aa^ _
;aa_ `
ifbb 
(bb 
userbb 
==bb 
nullbb 
)bb 
{cc 
usergg 
=gg 
AutoProvisionUsergg (
(gg( )
providergg) 1
,gg1 2
providerUserIdgg3 A
,ggA B
claimsggC I
)ggI J
;ggJ K
}hh 
varmm !
additionalLocalClaimsmm %
=mm& '
newmm( +
Listmm, 0
<mm0 1
Claimmm1 6
>mm6 7
(mm7 8
)mm8 9
;mm9 :
varnn 
localSignInPropsnn  
=nn! "
newnn# &$
AuthenticationPropertiesnn' ?
(nn? @
)nn@ A
;nnA B 
ProcessLoginCallbackoo  
(oo  !
resultoo! '
,oo' (!
additionalLocalClaimsoo) >
,oo> ?
localSignInPropsoo@ P
)ooP Q
;ooQ R
varrr 
isuserrr 
=rr 
newrr 
IdentityServerUserrr /
(rr/ 0
userrr0 4
.rr4 5
	SubjectIdrr5 >
)rr> ?
{ss 
DisplayNamett 
=tt 
usertt "
.tt" #
Usernamett# +
,tt+ ,
IdentityProvideruu  
=uu! "
provideruu# +
,uu+ ,
AdditionalClaimsvv  
=vv! "!
additionalLocalClaimsvv# 8
}ww 
;ww 
awaityy 
HttpContextyy 
.yy 
SignInAsyncyy )
(yy) *
isuseryy* 0
,yy0 1
localSignInPropsyy2 B
)yyB C
;yyC D
await|| 
HttpContext|| 
.|| 
SignOutAsync|| *
(||* +#
IdentityServerConstants||+ B
.||B C.
"ExternalCookieAuthenticationScheme||C e
)||e f
;||f g
var 
	returnUrl 
= 
result "
." #

Properties# -
.- .
Items. 3
[3 4
$str4 ?
]? @
??A C
$strD H
;H I
var
ÇÇ 
context
ÇÇ 
=
ÇÇ 
await
ÇÇ 
_interaction
ÇÇ  ,
.
ÇÇ, -*
GetAuthorizationContextAsync
ÇÇ- I
(
ÇÇI J
	returnUrl
ÇÇJ S
)
ÇÇS T
;
ÇÇT U
await
ÉÉ 
_events
ÉÉ 
.
ÉÉ 

RaiseAsync
ÉÉ $
(
ÉÉ$ %
new
ÉÉ% (#
UserLoginSuccessEvent
ÉÉ) >
(
ÉÉ> ?
provider
ÉÉ? G
,
ÉÉG H
providerUserId
ÉÉI W
,
ÉÉW X
user
ÉÉY ]
.
ÉÉ] ^
	SubjectId
ÉÉ^ g
,
ÉÉg h
user
ÉÉi m
.
ÉÉm n
Username
ÉÉn v
,
ÉÉv w
true
ÉÉx |
,
ÉÉ| }
contextÉÉ~ Ö
?ÉÉÖ Ü
.ÉÉÜ á
ClientÉÉá ç
.ÉÉç é
ClientIdÉÉé ñ
)ÉÉñ ó
)ÉÉó ò
;ÉÉò ô
if
ÖÖ 
(
ÖÖ 
context
ÖÖ 
!=
ÖÖ 
null
ÖÖ 
)
ÖÖ  
{
ÜÜ 
if
áá 
(
áá 
context
áá 
.
áá 
IsNativeClient
áá *
(
áá* +
)
áá+ ,
)
áá, -
{
àà 
return
ãã 
this
ãã 
.
ãã  
LoadingPage
ãã  +
(
ãã+ ,
$str
ãã, 6
,
ãã6 7
	returnUrl
ãã8 A
)
ããA B
;
ããB C
}
åå 
}
çç 
return
èè 
Redirect
èè 
(
èè 
	returnUrl
èè %
)
èè% &
;
èè& '
}
êê 	
private
íí 
(
íí 
TestUser
íí 
user
íí 
,
íí 
string
íí  &
provider
íí' /
,
íí/ 0
string
íí1 7
providerUserId
íí8 F
,
ííF G
IEnumerable
ííH S
<
ííS T
Claim
ííT Y
>
ííY Z
claims
íí[ a
)
íía b*
FindUserFromExternalProvider
ííc 
(íí Ä"
AuthenticateResultííÄ í
resultííì ô
)ííô ö
{
ìì 	
var
îî 
externalUser
îî 
=
îî 
result
îî %
.
îî% &
	Principal
îî& /
;
îî/ 0
var
ôô 
userIdClaim
ôô 
=
ôô 
externalUser
ôô *
.
ôô* +
	FindFirst
ôô+ 4
(
ôô4 5
JwtClaimTypes
ôô5 B
.
ôôB C
Subject
ôôC J
)
ôôJ K
??
ôôL N
externalUser
öö *
.
öö* +
	FindFirst
öö+ 4
(
öö4 5

ClaimTypes
öö5 ?
.
öö? @
NameIdentifier
öö@ N
)
ööN O
??
ööP R
throw
õõ #
new
õõ$ '
	Exception
õõ( 1
(
õõ1 2
$str
õõ2 B
)
õõB C
;
õõC D
var
ûû 
claims
ûû 
=
ûû 
externalUser
ûû %
.
ûû% &
Claims
ûû& ,
.
ûû, -
ToList
ûû- 3
(
ûû3 4
)
ûû4 5
;
ûû5 6
claims
üü 
.
üü 
Remove
üü 
(
üü 
userIdClaim
üü %
)
üü% &
;
üü& '
var
°° 
provider
°° 
=
°° 
result
°° !
.
°°! "

Properties
°°" ,
.
°°, -
Items
°°- 2
[
°°2 3
$str
°°3 ;
]
°°; <
;
°°< =
var
¢¢ 
providerUserId
¢¢ 
=
¢¢  
userIdClaim
¢¢! ,
.
¢¢, -
Value
¢¢- 2
;
¢¢2 3
var
•• 
user
•• 
=
•• 
_users
•• 
.
•• $
FindByExternalProvider
•• 4
(
••4 5
provider
••5 =
,
••= >
providerUserId
••? M
)
••M N
;
••N O
return
ßß 
(
ßß 
user
ßß 
,
ßß 
provider
ßß "
,
ßß" #
providerUserId
ßß$ 2
,
ßß2 3
claims
ßß4 :
)
ßß: ;
;
ßß; <
}
®® 	
private
™™ 
TestUser
™™ 
AutoProvisionUser
™™ *
(
™™* +
string
™™+ 1
provider
™™2 :
,
™™: ;
string
™™< B
providerUserId
™™C Q
,
™™Q R
IEnumerable
™™S ^
<
™™^ _
Claim
™™_ d
>
™™d e
claims
™™f l
)
™™l m
{
´´ 	
var
¨¨ 
user
¨¨ 
=
¨¨ 
_users
¨¨ 
.
¨¨ 
AutoProvisionUser
¨¨ /
(
¨¨/ 0
provider
¨¨0 8
,
¨¨8 9
providerUserId
¨¨: H
,
¨¨H I
claims
¨¨J P
.
¨¨P Q
ToList
¨¨Q W
(
¨¨W X
)
¨¨X Y
)
¨¨Y Z
;
¨¨Z [
return
≠≠ 
user
≠≠ 
;
≠≠ 
}
ÆÆ 	
private
≤≤ 
void
≤≤ "
ProcessLoginCallback
≤≤ )
(
≤≤) * 
AuthenticateResult
≤≤* <
externalResult
≤≤= K
,
≤≤K L
List
≤≤M Q
<
≤≤Q R
Claim
≤≤R W
>
≤≤W X
localClaims
≤≤Y d
,
≤≤d e&
AuthenticationProperties
≤≤f ~
localSignInProps≤≤ è
)≤≤è ê
{
≥≥ 	
var
∂∂ 
sid
∂∂ 
=
∂∂ 
externalResult
∂∂ $
.
∂∂$ %
	Principal
∂∂% .
.
∂∂. /
Claims
∂∂/ 5
.
∂∂5 6
FirstOrDefault
∂∂6 D
(
∂∂D E
x
∂∂E F
=>
∂∂G I
x
∂∂J K
.
∂∂K L
Type
∂∂L P
==
∂∂Q S
JwtClaimTypes
∂∂T a
.
∂∂a b
	SessionId
∂∂b k
)
∂∂k l
;
∂∂l m
if
∑∑ 
(
∑∑ 
sid
∑∑ 
!=
∑∑ 
null
∑∑ 
)
∑∑ 
{
∏∏ 
localClaims
ππ 
.
ππ 
Add
ππ 
(
ππ  
new
ππ  #
Claim
ππ$ )
(
ππ) *
JwtClaimTypes
ππ* 7
.
ππ7 8
	SessionId
ππ8 A
,
ππA B
sid
ππC F
.
ππF G
Value
ππG L
)
ππL M
)
ππM N
;
ππN O
}
∫∫ 
var
ΩΩ 
idToken
ΩΩ 
=
ΩΩ 
externalResult
ΩΩ (
.
ΩΩ( )

Properties
ΩΩ) 3
.
ΩΩ3 4
GetTokenValue
ΩΩ4 A
(
ΩΩA B
$str
ΩΩB L
)
ΩΩL M
;
ΩΩM N
if
ææ 
(
ææ 
idToken
ææ 
!=
ææ 
null
ææ 
)
ææ  
{
øø 
localSignInProps
¿¿  
.
¿¿  !
StoreTokens
¿¿! ,
(
¿¿, -
new
¿¿- 0
[
¿¿0 1
]
¿¿1 2
{
¿¿3 4
new
¿¿5 8!
AuthenticationToken
¿¿9 L
{
¿¿M N
Name
¿¿O S
=
¿¿T U
$str
¿¿V `
,
¿¿` a
Value
¿¿b g
=
¿¿h i
idToken
¿¿j q
}
¿¿r s
}
¿¿t u
)
¿¿u v
;
¿¿v w
}
¡¡ 
}
¬¬ 	
}
√√ 
}ƒƒ ‰
¢C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Account\ExternalProvider.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
ExternalProvider !
{ 
public		 
string		 
DisplayName		 !
{		" #
get		$ '
;		' (
set		) ,
;		, -
}		. /
public

 
string

  
AuthenticationScheme

 *
{

+ ,
get

- 0
;

0 1
set

2 5
;

5 6
}

7 8
} 
} º
§C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Account\LoggedOutViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
LoggedOutViewModel #
{ 
public		 
string		 !
PostLogoutRedirectUri		 +
{		, -
get		. 1
;		1 2
set		3 6
;		6 7
}		8 9
public

 
string

 

ClientName

  
{

! "
get

# &
;

& '
set

( +
;

+ ,
}

- .
public 
string 
SignOutIframeUrl &
{' (
get) ,
;, -
set. 1
;1 2
}3 4
public 
bool )
AutomaticRedirectAfterSignOut 1
{2 3
get4 7
;7 8
set9 <
;< =
}> ?
public 
string 
LogoutId 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
bool "
TriggerExternalSignout *
=>+ -(
ExternalAuthenticationScheme. J
!=K M
nullN R
;R S
public 
string (
ExternalAuthenticationScheme 2
{3 4
get5 8
;8 9
set: =
;= >
}? @
} 
} ˜
°C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Account\LoginInputModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public		 

class		 
LoginInputModel		  
{

 
[ 	
Required	 
] 
public 
string 
Username 
{  
get! $
;$ %
set& )
;) *
}+ ,
[ 	
Required	 
] 
public 
string 
Password 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
bool 
RememberLogin !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 
string 
	ReturnUrl 
{  !
get" %
;% &
set' *
;* +
}, -
} 
} °
†C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Account\LoginViewModel.cs
	namespace		 	
IdentityServerHost		
 
.		 

Quickstart		 '
.		' (
UI		( *
{

 
public 

class 
LoginViewModel 
:  !
LoginInputModel" 1
{ 
public 
bool 
AllowRememberLogin &
{' (
get) ,
;, -
set. 1
;1 2
}3 4
=5 6
true7 ;
;; <
public 
bool 
EnableLocalLogin $
{% &
get' *
;* +
set, /
;/ 0
}1 2
=3 4
true5 9
;9 :
public 
IEnumerable 
< 
ExternalProvider +
>+ ,
ExternalProviders- >
{? @
getA D
;D E
setF I
;I J
}K L
=M N

EnumerableO Y
.Y Z
EmptyZ _
<_ `
ExternalProvider` p
>p q
(q r
)r s
;s t
public 
IEnumerable 
< 
ExternalProvider +
>+ ,$
VisibleExternalProviders- E
=>F H
ExternalProvidersI Z
.Z [
Where[ `
(` a
xa b
=>c e
!f g
Stringg m
.m n
IsNullOrWhiteSpace	n Ä
(
Ä Å
x
Å Ç
.
Ç É
DisplayName
É é
)
é è
)
è ê
;
ê ë
public 
bool 
IsExternalLoginOnly '
=>( *
EnableLocalLogin+ ;
==< >
false? D
&&E G
ExternalProvidersH Y
?Y Z
.Z [
Count[ `
(` a
)a b
==c e
$numf g
;g h
public 
string 
ExternalLoginScheme )
=>* ,
IsExternalLoginOnly- @
?A B
ExternalProvidersC T
?T U
.U V
SingleOrDefaultV e
(e f
)f g
?g h
.h i 
AuthenticationSchemei }
:~ 
null
Ä Ñ
;
Ñ Ö
} 
} π
¢C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Account\LogoutInputModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
LogoutInputModel !
{ 
public		 
string		 
LogoutId		 
{		  
get		! $
;		$ %
set		& )
;		) *
}		+ ,
}

 
} ö
°C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Account\LogoutViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
LogoutViewModel  
:! "
LogoutInputModel# 3
{ 
public		 
bool		 
ShowLogoutPrompt		 $
{		% &
get		' *
;		* +
set		, /
;		/ 0
}		1 2
=		3 4
true		5 9
;		9 :
}

 
} æ
£C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Account\RedirectViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
RedirectViewModel "
{		 
public

 
string

 
RedirectUrl

 !
{

" #
get

$ '
;

' (
set

) ,
;

, -
}

. /
} 
} Å™
£C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Consent\ConsentController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[ 
SecurityHeaders 
] 
[ 
	Authorize 
] 
public 

class 
ConsentController "
:# $

Controller% /
{ 
private 
readonly -
!IIdentityServerInteractionService :
_interaction; G
;G H
private 
readonly 
IEventService &
_events' .
;. /
private 
readonly 
ILogger  
<  !
ConsentController! 2
>2 3
_logger4 ;
;; <
public 
ConsentController  
(  !-
!IIdentityServerInteractionService   -
interaction  . 9
,  9 :
IEventService!! 
events!!  
,!!  !
ILogger"" 
<"" 
ConsentController"" %
>""% &
logger""' -
)""- .
{## 	
_interaction$$ 
=$$ 
interaction$$ &
;$$& '
_events%% 
=%% 
events%% 
;%% 
_logger&& 
=&& 
logger&& 
;&& 
}'' 	
[.. 	
HttpGet..	 
].. 
public// 
async// 
Task// 
<// 
IActionResult// '
>//' (
Index//) .
(//. /
string/// 5
	returnUrl//6 ?
)//? @
{00 	
var11 
vm11 
=11 
await11 
BuildViewModelAsync11 .
(11. /
	returnUrl11/ 8
)118 9
;119 :
if22 
(22 
vm22 
!=22 
null22 
)22 
{33 
return44 
View44 
(44 
$str44 #
,44# $
vm44% '
)44' (
;44( )
}55 
return77 
View77 
(77 
$str77 
)77  
;77  !
}88 	
[== 	
HttpPost==	 
]== 
[>> 	$
ValidateAntiForgeryToken>>	 !
]>>! "
public?? 
async?? 
Task?? 
<?? 
IActionResult?? '
>??' (
Index??) .
(??. /
ConsentInputModel??/ @
model??A F
)??F G
{@@ 	
varAA 
resultAA 
=AA 
awaitAA 
ProcessConsentAA -
(AA- .
modelAA. 3
)AA3 4
;AA4 5
ifCC 
(CC 
resultCC 
.CC 

IsRedirectCC !
)CC! "
{DD 
varEE 
contextEE 
=EE 
awaitEE #
_interactionEE$ 0
.EE0 1(
GetAuthorizationContextAsyncEE1 M
(EEM N
modelEEN S
.EES T
	ReturnUrlEET ]
)EE] ^
;EE^ _
ifFF 
(FF 
contextFF 
?FF 
.FF 
IsNativeClientFF +
(FF+ ,
)FF, -
==FF. 0
trueFF1 5
)FF5 6
{GG 
returnJJ 
thisJJ 
.JJ  
LoadingPageJJ  +
(JJ+ ,
$strJJ, 6
,JJ6 7
resultJJ8 >
.JJ> ?
RedirectUriJJ? J
)JJJ K
;JJK L
}KK 
returnMM 
RedirectMM 
(MM  
resultMM  &
.MM& '
RedirectUriMM' 2
)MM2 3
;MM3 4
}NN 
ifPP 
(PP 
resultPP 
.PP 
HasValidationErrorPP )
)PP) *
{QQ 

ModelStateRR 
.RR 
AddModelErrorRR (
(RR( )
stringRR) /
.RR/ 0
EmptyRR0 5
,RR5 6
resultRR7 =
.RR= >
ValidationErrorRR> M
)RRM N
;RRN O
}SS 
ifUU 
(UU 
resultUU 
.UU 
ShowViewUU 
)UU  
{VV 
returnWW 
ViewWW 
(WW 
$strWW #
,WW# $
resultWW% +
.WW+ ,
	ViewModelWW, 5
)WW5 6
;WW6 7
}XX 
returnZZ 
ViewZZ 
(ZZ 
$strZZ 
)ZZ  
;ZZ  !
}[[ 	
private`` 
async`` 
Task`` 
<``  
ProcessConsentResult`` /
>``/ 0
ProcessConsent``1 ?
(``? @
ConsentInputModel``@ Q
model``R W
)``W X
{aa 	
varbb 
resultbb 
=bb 
newbb  
ProcessConsentResultbb 1
(bb1 2
)bb2 3
;bb3 4
varee 
requestee 
=ee 
awaitee 
_interactionee  ,
.ee, -(
GetAuthorizationContextAsyncee- I
(eeI J
modeleeJ O
.eeO P
	ReturnUrleeP Y
)eeY Z
;eeZ [
ifff 
(ff 
requestff 
==ff 
nullff 
)ff  
returnff! '
resultff( .
;ff. /
ConsentResponsehh 
grantedConsenthh *
=hh+ ,
nullhh- 1
;hh1 2
ifkk 
(kk 
modelkk 
?kk 
.kk 
Buttonkk 
==kk  
$strkk! %
)kk% &
{ll 
grantedConsentmm 
=mm  
newmm! $
ConsentResponsemm% 4
{mm5 6
Errormm7 <
=mm= >
AuthorizationErrormm? Q
.mmQ R
AccessDeniedmmR ^
}mm_ `
;mm` a
awaitpp 
_eventspp 
.pp 

RaiseAsyncpp (
(pp( )
newpp) ,
ConsentDeniedEventpp- ?
(pp? @
Userpp@ D
.ppD E
GetSubjectIdppE Q
(ppQ R
)ppR S
,ppS T
requestppU \
.pp\ ]
Clientpp] c
.ppc d
ClientIdppd l
,ppl m
requestppn u
.ppu v
ValidatedResources	ppv à
.
ppà â
RawScopeValues
ppâ ó
)
ppó ò
)
ppò ô
;
ppô ö
}qq 
elsess 
ifss 
(ss 
modelss 
?ss 
.ss 
Buttonss "
==ss# %
$strss& +
)ss+ ,
{tt 
ifvv 
(vv 
modelvv 
.vv 
ScopesConsentedvv )
!=vv* ,
nullvv- 1
&&vv2 4
modelvv5 :
.vv: ;
ScopesConsentedvv; J
.vvJ K
AnyvvK N
(vvN O
)vvO P
)vvP Q
{ww 
varxx 
scopesxx 
=xx  
modelxx! &
.xx& '
ScopesConsentedxx' 6
;xx6 7
ifyy 
(yy 
ConsentOptionsyy &
.yy& '
EnableOfflineAccessyy' :
==yy; =
falseyy> C
)yyC D
{zz 
scopes{{ 
={{  
scopes{{! '
.{{' (
Where{{( -
({{- .
x{{. /
=>{{0 2
x{{3 4
!={{5 7
IdentityServer4{{8 G
.{{G H#
IdentityServerConstants{{H _
.{{_ `
StandardScopes{{` n
.{{n o
OfflineAccess{{o |
){{| }
;{{} ~
}|| 
grantedConsent~~ "
=~~# $
new~~% (
ConsentResponse~~) 8
{ 
RememberConsent
ÄÄ '
=
ÄÄ( )
model
ÄÄ* /
.
ÄÄ/ 0
RememberConsent
ÄÄ0 ?
,
ÄÄ? @#
ScopesValuesConsented
ÅÅ -
=
ÅÅ. /
scopes
ÅÅ0 6
.
ÅÅ6 7
ToArray
ÅÅ7 >
(
ÅÅ> ?
)
ÅÅ? @
,
ÅÅ@ A
Description
ÇÇ #
=
ÇÇ$ %
model
ÇÇ& +
.
ÇÇ+ ,
Description
ÇÇ, 7
}
ÉÉ 
;
ÉÉ 
await
ÜÜ 
_events
ÜÜ !
.
ÜÜ! "

RaiseAsync
ÜÜ" ,
(
ÜÜ, -
new
ÜÜ- 0!
ConsentGrantedEvent
ÜÜ1 D
(
ÜÜD E
User
ÜÜE I
.
ÜÜI J
GetSubjectId
ÜÜJ V
(
ÜÜV W
)
ÜÜW X
,
ÜÜX Y
request
ÜÜZ a
.
ÜÜa b
Client
ÜÜb h
.
ÜÜh i
ClientId
ÜÜi q
,
ÜÜq r
request
ÜÜs z
.
ÜÜz {!
ValidatedResourcesÜÜ{ ç
.ÜÜç é
RawScopeValuesÜÜé ú
,ÜÜú ù
grantedConsentÜÜû ¨
.ÜÜ¨ ≠%
ScopesValuesConsentedÜÜ≠ ¬
,ÜÜ¬ √
grantedConsentÜÜƒ “
.ÜÜ“ ”
RememberConsentÜÜ” ‚
)ÜÜ‚ „
)ÜÜ„ ‰
;ÜÜ‰ Â
}
áá 
else
àà 
{
ââ 
result
ää 
.
ää 
ValidationError
ää *
=
ää+ ,
ConsentOptions
ää- ;
.
ää; <'
MustChooseOneErrorMessage
ää< U
;
ääU V
}
ãã 
}
åå 
else
çç 
{
éé 
result
èè 
.
èè 
ValidationError
èè &
=
èè' (
ConsentOptions
èè) 7
.
èè7 8*
InvalidSelectionErrorMessage
èè8 T
;
èèT U
}
êê 
if
íí 
(
íí 
grantedConsent
íí 
!=
íí !
null
íí" &
)
íí& '
{
ìì 
await
ïï 
_interaction
ïï "
.
ïï" #
GrantConsentAsync
ïï# 4
(
ïï4 5
request
ïï5 <
,
ïï< =
grantedConsent
ïï> L
)
ïïL M
;
ïïM N
result
òò 
.
òò 
RedirectUri
òò "
=
òò# $
model
òò% *
.
òò* +
	ReturnUrl
òò+ 4
;
òò4 5
result
ôô 
.
ôô 
Client
ôô 
=
ôô 
request
ôô  '
.
ôô' (
Client
ôô( .
;
ôô. /
}
öö 
else
õõ 
{
úú 
result
ûû 
.
ûû 
	ViewModel
ûû  
=
ûû! "
await
ûû# (!
BuildViewModelAsync
ûû) <
(
ûû< =
model
ûû= B
.
ûûB C
	ReturnUrl
ûûC L
,
ûûL M
model
ûûN S
)
ûûS T
;
ûûT U
}
üü 
return
°° 
result
°° 
;
°° 
}
¢¢ 	
private
§§ 
async
§§ 
Task
§§ 
<
§§ 
ConsentViewModel
§§ +
>
§§+ ,!
BuildViewModelAsync
§§- @
(
§§@ A
string
§§A G
	returnUrl
§§H Q
,
§§Q R
ConsentInputModel
§§S d
model
§§e j
=
§§k l
null
§§m q
)
§§q r
{
•• 	
var
¶¶ 
request
¶¶ 
=
¶¶ 
await
¶¶ 
_interaction
¶¶  ,
.
¶¶, -*
GetAuthorizationContextAsync
¶¶- I
(
¶¶I J
	returnUrl
¶¶J S
)
¶¶S T
;
¶¶T U
if
ßß 
(
ßß 
request
ßß 
!=
ßß 
null
ßß 
)
ßß  
{
®® 
return
©© $
CreateConsentViewModel
©© -
(
©©- .
model
©©. 3
,
©©3 4
	returnUrl
©©5 >
,
©©> ?
request
©©@ G
)
©©G H
;
©©H I
}
™™ 
else
´´ 
{
¨¨ 
_logger
≠≠ 
.
≠≠ 
LogError
≠≠  
(
≠≠  !
$str
≠≠! K
,
≠≠K L
	returnUrl
≠≠M V
)
≠≠V W
;
≠≠W X
}
ÆÆ 
return
∞∞ 
null
∞∞ 
;
∞∞ 
}
±± 	
private
≥≥ 
ConsentViewModel
≥≥  $
CreateConsentViewModel
≥≥! 7
(
≥≥7 8
ConsentInputModel
¥¥ 
model
¥¥ #
,
¥¥# $
string
¥¥% +
	returnUrl
¥¥, 5
,
¥¥5 6"
AuthorizationRequest
µµ  
request
µµ! (
)
µµ( )
{
∂∂ 	
var
∑∑ 
vm
∑∑ 
=
∑∑ 
new
∑∑ 
ConsentViewModel
∑∑ )
{
∏∏ 
RememberConsent
ππ 
=
ππ  !
model
ππ" '
?
ππ' (
.
ππ( )
RememberConsent
ππ) 8
??
ππ9 ;
true
ππ< @
,
ππ@ A
ScopesConsented
∫∫ 
=
∫∫  !
model
∫∫" '
?
∫∫' (
.
∫∫( )
ScopesConsented
∫∫) 8
??
∫∫9 ;

Enumerable
∫∫< F
.
∫∫F G
Empty
∫∫G L
<
∫∫L M
string
∫∫M S
>
∫∫S T
(
∫∫T U
)
∫∫U V
,
∫∫V W
Description
ªª 
=
ªª 
model
ªª #
?
ªª# $
.
ªª$ %
Description
ªª% 0
,
ªª0 1
	ReturnUrl
ΩΩ 
=
ΩΩ 
	returnUrl
ΩΩ %
,
ΩΩ% &

ClientName
øø 
=
øø 
request
øø $
.
øø$ %
Client
øø% +
.
øø+ ,

ClientName
øø, 6
??
øø7 9
request
øø: A
.
øøA B
Client
øøB H
.
øøH I
ClientId
øøI Q
,
øøQ R
	ClientUrl
¿¿ 
=
¿¿ 
request
¿¿ #
.
¿¿# $
Client
¿¿$ *
.
¿¿* +
	ClientUri
¿¿+ 4
,
¿¿4 5
ClientLogoUrl
¡¡ 
=
¡¡ 
request
¡¡  '
.
¡¡' (
Client
¡¡( .
.
¡¡. /
LogoUri
¡¡/ 6
,
¡¡6 7"
AllowRememberConsent
¬¬ $
=
¬¬% &
request
¬¬' .
.
¬¬. /
Client
¬¬/ 5
.
¬¬5 6"
AllowRememberConsent
¬¬6 J
}
√√ 
;
√√ 
vm
≈≈ 
.
≈≈ 
IdentityScopes
≈≈ 
=
≈≈ 
request
≈≈  '
.
≈≈' ( 
ValidatedResources
≈≈( :
.
≈≈: ;
	Resources
≈≈; D
.
≈≈D E
IdentityResources
≈≈E V
.
≈≈V W
Select
≈≈W ]
(
≈≈] ^
x
≈≈^ _
=>
≈≈` b"
CreateScopeViewModel
≈≈c w
(
≈≈w x
x
≈≈x y
,
≈≈y z
vm
≈≈{ }
.
≈≈} ~
ScopesConsented≈≈~ ç
.≈≈ç é
Contains≈≈é ñ
(≈≈ñ ó
x≈≈ó ò
.≈≈ò ô
Name≈≈ô ù
)≈≈ù û
||≈≈ü °
model≈≈¢ ß
==≈≈® ™
null≈≈´ Ø
)≈≈Ø ∞
)≈≈∞ ±
.≈≈± ≤
ToArray≈≈≤ π
(≈≈π ∫
)≈≈∫ ª
;≈≈ª º
var
«« 
	apiScopes
«« 
=
«« 
new
«« 
List
««  $
<
««$ %
ScopeViewModel
««% 3
>
««3 4
(
««4 5
)
««5 6
;
««6 7
foreach
»» 
(
»» 
var
»» 
parsedScope
»» $
in
»»% '
request
»»( /
.
»»/ 0 
ValidatedResources
»»0 B
.
»»B C
ParsedScopes
»»C O
)
»»O P
{
…… 
var
   
apiScope
   
=
   
request
   &
.
  & ' 
ValidatedResources
  ' 9
.
  9 :
	Resources
  : C
.
  C D
FindApiScope
  D P
(
  P Q
parsedScope
  Q \
.
  \ ]

ParsedName
  ] g
)
  g h
;
  h i
if
ÀÀ 
(
ÀÀ 
apiScope
ÀÀ 
!=
ÀÀ 
null
ÀÀ  $
)
ÀÀ$ %
{
ÃÃ 
var
ÕÕ 
scopeVm
ÕÕ 
=
ÕÕ  !"
CreateScopeViewModel
ÕÕ" 6
(
ÕÕ6 7
parsedScope
ÕÕ7 B
,
ÕÕB C
apiScope
ÕÕD L
,
ÕÕL M
vm
ÕÕN P
.
ÕÕP Q
ScopesConsented
ÕÕQ `
.
ÕÕ` a
Contains
ÕÕa i
(
ÕÕi j
parsedScope
ÕÕj u
.
ÕÕu v
RawValue
ÕÕv ~
)
ÕÕ~ 
||ÕÕÄ Ç
modelÕÕÉ à
==ÕÕâ ã
nullÕÕå ê
)ÕÕê ë
;ÕÕë í
	apiScopes
ŒŒ 
.
ŒŒ 
Add
ŒŒ !
(
ŒŒ! "
scopeVm
ŒŒ" )
)
ŒŒ) *
;
ŒŒ* +
}
œœ 
}
–– 
if
—— 
(
—— 
ConsentOptions
—— 
.
—— !
EnableOfflineAccess
—— 2
&&
——3 5
request
——6 =
.
——= > 
ValidatedResources
——> P
.
——P Q
	Resources
——Q Z
.
——Z [
OfflineAccess
——[ h
)
——h i
{
““ 
	apiScopes
”” 
.
”” 
Add
”” 
(
”” #
GetOfflineAccessScope
”” 3
(
””3 4
vm
””4 6
.
””6 7
ScopesConsented
””7 F
.
””F G
Contains
””G O
(
””O P
IdentityServer4
””P _
.
””_ `%
IdentityServerConstants
””` w
.
””w x
StandardScopes””x Ü
.””Ü á
OfflineAccess””á î
)””î ï
||””ñ ò
model””ô û
==””ü °
null””¢ ¶
)””¶ ß
)””ß ®
;””® ©
}
‘‘ 
vm
’’ 
.
’’ 
	ApiScopes
’’ 
=
’’ 
	apiScopes
’’ $
;
’’$ %
return
◊◊ 
vm
◊◊ 
;
◊◊ 
}
ÿÿ 	
private
⁄⁄ 
ScopeViewModel
⁄⁄ "
CreateScopeViewModel
⁄⁄ 3
(
⁄⁄3 4
IdentityResource
⁄⁄4 D
identity
⁄⁄E M
,
⁄⁄M N
bool
⁄⁄O S
check
⁄⁄T Y
)
⁄⁄Y Z
{
€€ 	
return
‹‹ 
new
‹‹ 
ScopeViewModel
‹‹ %
{
›› 
Value
ﬁﬁ 
=
ﬁﬁ 
identity
ﬁﬁ  
.
ﬁﬁ  !
Name
ﬁﬁ! %
,
ﬁﬁ% &
DisplayName
ﬂﬂ 
=
ﬂﬂ 
identity
ﬂﬂ &
.
ﬂﬂ& '
DisplayName
ﬂﬂ' 2
??
ﬂﬂ3 5
identity
ﬂﬂ6 >
.
ﬂﬂ> ?
Name
ﬂﬂ? C
,
ﬂﬂC D
Description
‡‡ 
=
‡‡ 
identity
‡‡ &
.
‡‡& '
Description
‡‡' 2
,
‡‡2 3
	Emphasize
·· 
=
·· 
identity
·· $
.
··$ %
	Emphasize
··% .
,
··. /
Required
‚‚ 
=
‚‚ 
identity
‚‚ #
.
‚‚# $
Required
‚‚$ ,
,
‚‚, -
Checked
„„ 
=
„„ 
check
„„ 
||
„„  "
identity
„„# +
.
„„+ ,
Required
„„, 4
}
‰‰ 
;
‰‰ 
}
ÂÂ 	
public
ÁÁ 
ScopeViewModel
ÁÁ "
CreateScopeViewModel
ÁÁ 2
(
ÁÁ2 3
ParsedScopeValue
ÁÁ3 C
parsedScopeValue
ÁÁD T
,
ÁÁT U
ApiScope
ÁÁV ^
apiScope
ÁÁ_ g
,
ÁÁg h
bool
ÁÁi m
check
ÁÁn s
)
ÁÁs t
{
ËË 	
var
ÈÈ 
displayName
ÈÈ 
=
ÈÈ 
apiScope
ÈÈ &
.
ÈÈ& '
DisplayName
ÈÈ' 2
??
ÈÈ3 5
apiScope
ÈÈ6 >
.
ÈÈ> ?
Name
ÈÈ? C
;
ÈÈC D
if
ÍÍ 
(
ÍÍ 
!
ÍÍ 
String
ÍÍ 
.
ÍÍ  
IsNullOrWhiteSpace
ÍÍ *
(
ÍÍ* +
parsedScopeValue
ÍÍ+ ;
.
ÍÍ; <
ParsedParameter
ÍÍ< K
)
ÍÍK L
)
ÍÍL M
{
ÎÎ 
displayName
ÏÏ 
+=
ÏÏ 
$str
ÏÏ "
+
ÏÏ# $
parsedScopeValue
ÏÏ% 5
.
ÏÏ5 6
ParsedParameter
ÏÏ6 E
;
ÏÏE F
}
ÌÌ 
return
ÔÔ 
new
ÔÔ 
ScopeViewModel
ÔÔ %
{
 
Value
ÒÒ 
=
ÒÒ 
parsedScopeValue
ÒÒ (
.
ÒÒ( )
RawValue
ÒÒ) 1
,
ÒÒ1 2
DisplayName
ÚÚ 
=
ÚÚ 
displayName
ÚÚ )
,
ÚÚ) *
Description
ÛÛ 
=
ÛÛ 
apiScope
ÛÛ &
.
ÛÛ& '
Description
ÛÛ' 2
,
ÛÛ2 3
	Emphasize
ÙÙ 
=
ÙÙ 
apiScope
ÙÙ $
.
ÙÙ$ %
	Emphasize
ÙÙ% .
,
ÙÙ. /
Required
ıı 
=
ıı 
apiScope
ıı #
.
ıı# $
Required
ıı$ ,
,
ıı, -
Checked
ˆˆ 
=
ˆˆ 
check
ˆˆ 
||
ˆˆ  "
apiScope
ˆˆ# +
.
ˆˆ+ ,
Required
ˆˆ, 4
}
˜˜ 
;
˜˜ 
}
¯¯ 	
private
˙˙ 
ScopeViewModel
˙˙ #
GetOfflineAccessScope
˙˙ 4
(
˙˙4 5
bool
˙˙5 9
check
˙˙: ?
)
˙˙? @
{
˚˚ 	
return
¸¸ 
new
¸¸ 
ScopeViewModel
¸¸ %
{
˝˝ 
Value
˛˛ 
=
˛˛ 
IdentityServer4
˛˛ '
.
˛˛' (%
IdentityServerConstants
˛˛( ?
.
˛˛? @
StandardScopes
˛˛@ N
.
˛˛N O
OfflineAccess
˛˛O \
,
˛˛\ ]
DisplayName
ˇˇ 
=
ˇˇ 
ConsentOptions
ˇˇ ,
.
ˇˇ, -&
OfflineAccessDisplayName
ˇˇ- E
,
ˇˇE F
Description
ÄÄ 
=
ÄÄ 
ConsentOptions
ÄÄ ,
.
ÄÄ, -&
OfflineAccessDescription
ÄÄ- E
,
ÄÄE F
	Emphasize
ÅÅ 
=
ÅÅ 
true
ÅÅ  
,
ÅÅ  !
Checked
ÇÇ 
=
ÇÇ 
check
ÇÇ 
}
ÉÉ 
;
ÉÉ 
}
ÑÑ 	
}
ÖÖ 
}ÜÜ 	
£C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Consent\ConsentInputModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public		 

class		 
ConsentInputModel		 "
{

 
public 
string 
Button 
{ 
get "
;" #
set$ '
;' (
}) *
public 
IEnumerable 
< 
string !
>! "
ScopesConsented# 2
{3 4
get5 8
;8 9
set: =
;= >
}? @
public 
bool 
RememberConsent #
{$ %
get& )
;) *
set+ .
;. /
}0 1
public 
string 
	ReturnUrl 
{  !
get" %
;% &
set' *
;* +
}, -
public 
string 
Description !
{" #
get$ '
;' (
set) ,
;, -
}. /
} 
} ù	
†C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Consent\ConsentOptions.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
ConsentOptions 
{ 
public		 
static		 
bool		 
EnableOfflineAccess		 .
=		/ 0
true		1 5
;		5 6
public

 
static

 
string

 $
OfflineAccessDisplayName

 5
=

6 7
$str

8 H
;

H I
public 
static 
string $
OfflineAccessDescription 5
=6 7
$str8 ~
;~ 
public 
static 
readonly 
string %%
MustChooseOneErrorMessage& ?
=@ A
$strB i
;i j
public 
static 
readonly 
string %(
InvalidSelectionErrorMessage& B
=C D
$strE X
;X Y
} 
} ä
¢C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Consent\ConsentViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public		 

class		 
ConsentViewModel		 !
:		" #
ConsentInputModel		$ 5
{

 
public 
string 

ClientName  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
string 
	ClientUrl 
{  !
get" %
;% &
set' *
;* +
}, -
public 
string 
ClientLogoUrl #
{$ %
get& )
;) *
set+ .
;. /
}0 1
public 
bool  
AllowRememberConsent (
{) *
get+ .
;. /
set0 3
;3 4
}5 6
public 
IEnumerable 
< 
ScopeViewModel )
>) *
IdentityScopes+ 9
{: ;
get< ?
;? @
setA D
;D E
}F G
public 
IEnumerable 
< 
ScopeViewModel )
>) *
	ApiScopes+ 4
{5 6
get7 :
;: ;
set< ?
;? @
}A B
} 
} ¯
¶C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Consent\ProcessConsentResult.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public		 

class		  
ProcessConsentResult		 %
{

 
public 
bool 

IsRedirect 
=> !
RedirectUri" -
!=. 0
null1 5
;5 6
public 
string 
RedirectUri !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 
Client 
Client 
{ 
get "
;" #
set$ '
;' (
}) *
public 
bool 
ShowView 
=> 
	ViewModel  )
!=* ,
null- 1
;1 2
public 
ConsentViewModel 
	ViewModel  )
{* +
get, /
;/ 0
set1 4
;4 5
}6 7
public 
bool 
HasValidationError &
=>' )
ValidationError* 9
!=: <
null= A
;A B
public 
string 
ValidationError %
{& '
get( +
;+ ,
set- 0
;0 1
}2 3
} 
} æ

†C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Consent\ScopeViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
ScopeViewModel 
{ 
public		 
string		 
Value		 
{		 
get		 !
;		! "
set		# &
;		& '
}		( )
public

 
string

 
DisplayName

 !
{

" #
get

$ '
;

' (
set

) ,
;

, -
}

. /
public 
string 
Description !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 
bool 
	Emphasize 
{ 
get  #
;# $
set% (
;( )
}* +
public 
bool 
Required 
{ 
get "
;" #
set$ '
;' (
}) *
public 
bool 
Checked 
{ 
get !
;! "
set# &
;& '
}( )
} 
} Ä
ÆC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Device\DeviceAuthorizationInputModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class )
DeviceAuthorizationInputModel .
:/ 0
ConsentInputModel1 B
{ 
public		 
string		 
UserCode		 
{		  
get		! $
;		$ %
set		& )
;		) *
}		+ ,
}

 
} û
≠C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Device\DeviceAuthorizationViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class (
DeviceAuthorizationViewModel -
:. /
ConsentViewModel0 @
{ 
public		 
string		 
UserCode		 
{		  
get		! $
;		$ %
set		& )
;		) *
}		+ ,
public

 
bool

 
ConfirmUserCode

 #
{

$ %
get

& )
;

) *
set

+ .
;

. /
}

0 1
} 
} ∏©
°C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Device\DeviceController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[ 
	Authorize 
] 
[ 
SecurityHeaders 
] 
public 

class 
DeviceController !
:" #

Controller$ .
{ 
private 
readonly )
IDeviceFlowInteractionService 6
_interaction7 C
;C D
private 
readonly 
IEventService &
_events' .
;. /
private 
readonly 
IOptions !
<! "!
IdentityServerOptions" 7
>7 8
_options9 A
;A B
private 
readonly 
ILogger  
<  !
DeviceController! 1
>1 2
_logger3 :
;: ;
public 
DeviceController 
(  )
IDeviceFlowInteractionService   )
interaction  * 5
,  5 6
IEventService!! 
eventService!! &
,!!& '
IOptions"" 
<"" !
IdentityServerOptions"" *
>""* +
options"", 3
,""3 4
ILogger## 
<## 
DeviceController## $
>##$ %
logger##& ,
)##, -
{$$ 	
_interaction%% 
=%% 
interaction%% &
;%%& '
_events&& 
=&& 
eventService&& "
;&&" #
_options'' 
='' 
options'' 
;'' 
_logger(( 
=(( 
logger(( 
;(( 
})) 	
[++ 	
HttpGet++	 
]++ 
public,, 
async,, 
Task,, 
<,, 
IActionResult,, '
>,,' (
Index,,) .
(,,. /
),,/ 0
{-- 	
string.. 
userCodeParamName.. $
=..% &
_options..' /
.../ 0
Value..0 5
...5 6
UserInteraction..6 E
...E F/
#DeviceVerificationUserCodeParameter..F i
;..i j
string// 
userCode// 
=// 
Request// %
.//% &
Query//& +
[//+ ,
userCodeParamName//, =
]//= >
;//> ?
if00 
(00 
string00 
.00 
IsNullOrWhiteSpace00 )
(00) *
userCode00* 2
)002 3
)003 4
return005 ;
View00< @
(00@ A
$str00A R
)00R S
;00S T
var22 
vm22 
=22 
await22 
BuildViewModelAsync22 .
(22. /
userCode22/ 7
)227 8
;228 9
if33 
(33 
vm33 
==33 
null33 
)33 
return33 "
View33# '
(33' (
$str33( /
)33/ 0
;330 1
vm55 
.55 
ConfirmUserCode55 
=55  
true55! %
;55% &
return66 
View66 
(66 
$str66 .
,66. /
vm660 2
)662 3
;663 4
}77 	
[99 	
HttpPost99	 
]99 
[:: 	$
ValidateAntiForgeryToken::	 !
]::! "
public;; 
async;; 
Task;; 
<;; 
IActionResult;; '
>;;' (
UserCodeCapture;;) 8
(;;8 9
string;;9 ?
userCode;;@ H
);;H I
{<< 	
var== 
vm== 
=== 
await== 
BuildViewModelAsync== .
(==. /
userCode==/ 7
)==7 8
;==8 9
if>> 
(>> 
vm>> 
==>> 
null>> 
)>> 
return>> "
View>># '
(>>' (
$str>>( /
)>>/ 0
;>>0 1
return@@ 
View@@ 
(@@ 
$str@@ .
,@@. /
vm@@0 2
)@@2 3
;@@3 4
}AA 	
[CC 	
HttpPostCC	 
]CC 
[DD 	$
ValidateAntiForgeryTokenDD	 !
]DD! "
publicEE 
asyncEE 
TaskEE 
<EE 
IActionResultEE '
>EE' (
CallbackEE) 1
(EE1 2)
DeviceAuthorizationInputModelEE2 O
modelEEP U
)EEU V
{FF 	
ifGG 
(GG 
modelGG 
==GG 
nullGG 
)GG 
throwGG $
newGG% (!
ArgumentNullExceptionGG) >
(GG> ?
nameofGG? E
(GGE F
modelGGF K
)GGK L
)GGL M
;GGM N
varII 
resultII 
=II 
awaitII 
ProcessConsentII -
(II- .
modelII. 3
)II3 4
;II4 5
ifJJ 
(JJ 
resultJJ 
.JJ 
HasValidationErrorJJ )
)JJ) *
returnJJ+ 1
ViewJJ2 6
(JJ6 7
$strJJ7 >
)JJ> ?
;JJ? @
returnLL 
ViewLL 
(LL 
$strLL !
)LL! "
;LL" #
}MM 	
privateOO 
asyncOO 
TaskOO 
<OO  
ProcessConsentResultOO /
>OO/ 0
ProcessConsentOO1 ?
(OO? @)
DeviceAuthorizationInputModelOO@ ]
modelOO^ c
)OOc d
{PP 	
varQQ 
resultQQ 
=QQ 
newQQ  
ProcessConsentResultQQ 1
(QQ1 2
)QQ2 3
;QQ3 4
varSS 
requestSS 
=SS 
awaitSS 
_interactionSS  ,
.SS, -(
GetAuthorizationContextAsyncSS- I
(SSI J
modelSSJ O
.SSO P
UserCodeSSP X
)SSX Y
;SSY Z
ifTT 
(TT 
requestTT 
==TT 
nullTT 
)TT  
returnTT! '
resultTT( .
;TT. /
ConsentResponseVV 
grantedConsentVV *
=VV+ ,
nullVV- 1
;VV1 2
ifYY 
(YY 
modelYY 
.YY 
ButtonYY 
==YY 
$strYY  $
)YY$ %
{ZZ 
grantedConsent[[ 
=[[  
new[[! $
ConsentResponse[[% 4
{[[5 6
Error[[7 <
=[[= >
AuthorizationError[[? Q
.[[Q R
AccessDenied[[R ^
}[[_ `
;[[` a
await^^ 
_events^^ 
.^^ 

RaiseAsync^^ (
(^^( )
new^^) ,
ConsentDeniedEvent^^- ?
(^^? @
User^^@ D
.^^D E
GetSubjectId^^E Q
(^^Q R
)^^R S
,^^S T
request^^U \
.^^\ ]
Client^^] c
.^^c d
ClientId^^d l
,^^l m
request^^n u
.^^u v
ValidatedResources	^^v à
.
^^à â
RawScopeValues
^^â ó
)
^^ó ò
)
^^ò ô
;
^^ô ö
}__ 
elseaa 
ifaa 
(aa 
modelaa 
.aa 
Buttonaa !
==aa" $
$straa% *
)aa* +
{bb 
ifdd 
(dd 
modeldd 
.dd 
ScopesConsenteddd )
!=dd* ,
nulldd- 1
&&dd2 4
modeldd5 :
.dd: ;
ScopesConsenteddd; J
.ddJ K
AnyddK N
(ddN O
)ddO P
)ddP Q
{ee 
varff 
scopesff 
=ff  
modelff! &
.ff& '
ScopesConsentedff' 6
;ff6 7
ifgg 
(gg 
ConsentOptionsgg &
.gg& '
EnableOfflineAccessgg' :
==gg; =
falsegg> C
)ggC D
{hh 
scopesii 
=ii  
scopesii! '
.ii' (
Whereii( -
(ii- .
xii. /
=>ii0 2
xii3 4
!=ii5 7
IdentityServer4ii8 G
.iiG H#
IdentityServerConstantsiiH _
.ii_ `
StandardScopesii` n
.iin o
OfflineAccessiio |
)ii| }
;ii} ~
}jj 
grantedConsentll "
=ll# $
newll% (
ConsentResponsell) 8
{mm 
RememberConsentnn '
=nn( )
modelnn* /
.nn/ 0
RememberConsentnn0 ?
,nn? @!
ScopesValuesConsentedoo -
=oo. /
scopesoo0 6
.oo6 7
ToArrayoo7 >
(oo> ?
)oo? @
,oo@ A
Descriptionpp #
=pp$ %
modelpp& +
.pp+ ,
Descriptionpp, 7
}qq 
;qq 
awaittt 
_eventstt !
.tt! "

RaiseAsynctt" ,
(tt, -
newtt- 0
ConsentGrantedEventtt1 D
(ttD E
UserttE I
.ttI J
GetSubjectIdttJ V
(ttV W
)ttW X
,ttX Y
requestttZ a
.tta b
Clientttb h
.tth i
ClientIdtti q
,ttq r
requesttts z
.ttz {
ValidatedResources	tt{ ç
.
ttç é
RawScopeValues
tté ú
,
ttú ù
grantedConsent
ttû ¨
.
tt¨ ≠#
ScopesValuesConsented
tt≠ ¬
,
tt¬ √
grantedConsent
ttƒ “
.
tt“ ”
RememberConsent
tt” ‚
)
tt‚ „
)
tt„ ‰
;
tt‰ Â
}uu 
elsevv 
{ww 
resultxx 
.xx 
ValidationErrorxx *
=xx+ ,
ConsentOptionsxx- ;
.xx; <%
MustChooseOneErrorMessagexx< U
;xxU V
}yy 
}zz 
else{{ 
{|| 
result}} 
.}} 
ValidationError}} &
=}}' (
ConsentOptions}}) 7
.}}7 8(
InvalidSelectionErrorMessage}}8 T
;}}T U
}~~ 
if
ÄÄ 
(
ÄÄ 
grantedConsent
ÄÄ 
!=
ÄÄ !
null
ÄÄ" &
)
ÄÄ& '
{
ÅÅ 
await
ÉÉ 
_interaction
ÉÉ "
.
ÉÉ" # 
HandleRequestAsync
ÉÉ# 5
(
ÉÉ5 6
model
ÉÉ6 ;
.
ÉÉ; <
UserCode
ÉÉ< D
,
ÉÉD E
grantedConsent
ÉÉF T
)
ÉÉT U
;
ÉÉU V
result
ÜÜ 
.
ÜÜ 
RedirectUri
ÜÜ "
=
ÜÜ# $
model
ÜÜ% *
.
ÜÜ* +
	ReturnUrl
ÜÜ+ 4
;
ÜÜ4 5
result
áá 
.
áá 
Client
áá 
=
áá 
request
áá  '
.
áá' (
Client
áá( .
;
áá. /
}
àà 
else
ââ 
{
ää 
result
åå 
.
åå 
	ViewModel
åå  
=
åå! "
await
åå# (!
BuildViewModelAsync
åå) <
(
åå< =
model
åå= B
.
ååB C
UserCode
ååC K
,
ååK L
model
ååM R
)
ååR S
;
ååS T
}
çç 
return
èè 
result
èè 
;
èè 
}
êê 	
private
íí 
async
íí 
Task
íí 
<
íí *
DeviceAuthorizationViewModel
íí 7
>
íí7 8!
BuildViewModelAsync
íí9 L
(
ííL M
string
ííM S
userCode
ííT \
,
íí\ ]+
DeviceAuthorizationInputModel
íí^ {
modelíí| Å
=ííÇ É
nullííÑ à
)ííà â
{
ìì 	
var
îî 
request
îî 
=
îî 
await
îî 
_interaction
îî  ,
.
îî, -*
GetAuthorizationContextAsync
îî- I
(
îîI J
userCode
îîJ R
)
îîR S
;
îîS T
if
ïï 
(
ïï 
request
ïï 
!=
ïï 
null
ïï 
)
ïï  
{
ññ 
return
óó $
CreateConsentViewModel
óó -
(
óó- .
userCode
óó. 6
,
óó6 7
model
óó8 =
,
óó= >
request
óó? F
)
óóF G
;
óóG H
}
òò 
return
öö 
null
öö 
;
öö 
}
õõ 	
private
ùù *
DeviceAuthorizationViewModel
ùù ,$
CreateConsentViewModel
ùù- C
(
ùùC D
string
ùùD J
userCode
ùùK S
,
ùùS T+
DeviceAuthorizationInputModel
ùùU r
model
ùùs x
,
ùùx y-
DeviceFlowAuthorizationRequestùùz ò
requestùùô †
)ùù† °
{
ûû 	
var
üü 
vm
üü 
=
üü 
new
üü *
DeviceAuthorizationViewModel
üü 5
{
†† 
UserCode
°° 
=
°° 
userCode
°° #
,
°°# $
Description
¢¢ 
=
¢¢ 
model
¢¢ #
?
¢¢# $
.
¢¢$ %
Description
¢¢% 0
,
¢¢0 1
RememberConsent
§§ 
=
§§  !
model
§§" '
?
§§' (
.
§§( )
RememberConsent
§§) 8
??
§§9 ;
true
§§< @
,
§§@ A
ScopesConsented
•• 
=
••  !
model
••" '
?
••' (
.
••( )
ScopesConsented
••) 8
??
••9 ;

Enumerable
••< F
.
••F G
Empty
••G L
<
••L M
string
••M S
>
••S T
(
••T U
)
••U V
,
••V W

ClientName
ßß 
=
ßß 
request
ßß $
.
ßß$ %
Client
ßß% +
.
ßß+ ,

ClientName
ßß, 6
??
ßß7 9
request
ßß: A
.
ßßA B
Client
ßßB H
.
ßßH I
ClientId
ßßI Q
,
ßßQ R
	ClientUrl
®® 
=
®® 
request
®® #
.
®®# $
Client
®®$ *
.
®®* +
	ClientUri
®®+ 4
,
®®4 5
ClientLogoUrl
©© 
=
©© 
request
©©  '
.
©©' (
Client
©©( .
.
©©. /
LogoUri
©©/ 6
,
©©6 7"
AllowRememberConsent
™™ $
=
™™% &
request
™™' .
.
™™. /
Client
™™/ 5
.
™™5 6"
AllowRememberConsent
™™6 J
}
´´ 
;
´´ 
vm
≠≠ 
.
≠≠ 
IdentityScopes
≠≠ 
=
≠≠ 
request
≠≠  '
.
≠≠' ( 
ValidatedResources
≠≠( :
.
≠≠: ;
	Resources
≠≠; D
.
≠≠D E
IdentityResources
≠≠E V
.
≠≠V W
Select
≠≠W ]
(
≠≠] ^
x
≠≠^ _
=>
≠≠` b"
CreateScopeViewModel
≠≠c w
(
≠≠w x
x
≠≠x y
,
≠≠y z
vm
≠≠{ }
.
≠≠} ~
ScopesConsented≠≠~ ç
.≠≠ç é
Contains≠≠é ñ
(≠≠ñ ó
x≠≠ó ò
.≠≠ò ô
Name≠≠ô ù
)≠≠ù û
||≠≠ü °
model≠≠¢ ß
==≠≠® ™
null≠≠´ Ø
)≠≠Ø ∞
)≠≠∞ ±
.≠≠± ≤
ToArray≠≠≤ π
(≠≠π ∫
)≠≠∫ ª
;≠≠ª º
var
ØØ 
	apiScopes
ØØ 
=
ØØ 
new
ØØ 
List
ØØ  $
<
ØØ$ %
ScopeViewModel
ØØ% 3
>
ØØ3 4
(
ØØ4 5
)
ØØ5 6
;
ØØ6 7
foreach
∞∞ 
(
∞∞ 
var
∞∞ 
parsedScope
∞∞ $
in
∞∞% '
request
∞∞( /
.
∞∞/ 0 
ValidatedResources
∞∞0 B
.
∞∞B C
ParsedScopes
∞∞C O
)
∞∞O P
{
±± 
var
≤≤ 
apiScope
≤≤ 
=
≤≤ 
request
≤≤ &
.
≤≤& ' 
ValidatedResources
≤≤' 9
.
≤≤9 :
	Resources
≤≤: C
.
≤≤C D
FindApiScope
≤≤D P
(
≤≤P Q
parsedScope
≤≤Q \
.
≤≤\ ]

ParsedName
≤≤] g
)
≤≤g h
;
≤≤h i
if
≥≥ 
(
≥≥ 
apiScope
≥≥ 
!=
≥≥ 
null
≥≥  $
)
≥≥$ %
{
¥¥ 
var
µµ 
scopeVm
µµ 
=
µµ  !"
CreateScopeViewModel
µµ" 6
(
µµ6 7
parsedScope
µµ7 B
,
µµB C
apiScope
µµD L
,
µµL M
vm
µµN P
.
µµP Q
ScopesConsented
µµQ `
.
µµ` a
Contains
µµa i
(
µµi j
parsedScope
µµj u
.
µµu v
RawValue
µµv ~
)
µµ~ 
||µµÄ Ç
modelµµÉ à
==µµâ ã
nullµµå ê
)µµê ë
;µµë í
	apiScopes
∂∂ 
.
∂∂ 
Add
∂∂ !
(
∂∂! "
scopeVm
∂∂" )
)
∂∂) *
;
∂∂* +
}
∑∑ 
}
∏∏ 
if
ππ 
(
ππ 
ConsentOptions
ππ 
.
ππ !
EnableOfflineAccess
ππ 2
&&
ππ3 5
request
ππ6 =
.
ππ= > 
ValidatedResources
ππ> P
.
ππP Q
	Resources
ππQ Z
.
ππZ [
OfflineAccess
ππ[ h
)
ππh i
{
∫∫ 
	apiScopes
ªª 
.
ªª 
Add
ªª 
(
ªª #
GetOfflineAccessScope
ªª 3
(
ªª3 4
vm
ªª4 6
.
ªª6 7
ScopesConsented
ªª7 F
.
ªªF G
Contains
ªªG O
(
ªªO P
IdentityServer4
ªªP _
.
ªª_ `%
IdentityServerConstants
ªª` w
.
ªªw x
StandardScopesªªx Ü
.ªªÜ á
OfflineAccessªªá î
)ªªî ï
||ªªñ ò
modelªªô û
==ªªü °
nullªª¢ ¶
)ªª¶ ß
)ªªß ®
;ªª® ©
}
ºº 
vm
ΩΩ 
.
ΩΩ 
	ApiScopes
ΩΩ 
=
ΩΩ 
	apiScopes
ΩΩ $
;
ΩΩ$ %
return
øø 
vm
øø 
;
øø 
}
¿¿ 	
private
¬¬ 
ScopeViewModel
¬¬ "
CreateScopeViewModel
¬¬ 3
(
¬¬3 4
IdentityResource
¬¬4 D
identity
¬¬E M
,
¬¬M N
bool
¬¬O S
check
¬¬T Y
)
¬¬Y Z
{
√√ 	
return
ƒƒ 
new
ƒƒ 
ScopeViewModel
ƒƒ %
{
≈≈ 
Value
∆∆ 
=
∆∆ 
identity
∆∆  
.
∆∆  !
Name
∆∆! %
,
∆∆% &
DisplayName
«« 
=
«« 
identity
«« &
.
««& '
DisplayName
««' 2
??
««3 5
identity
««6 >
.
««> ?
Name
««? C
,
««C D
Description
»» 
=
»» 
identity
»» &
.
»»& '
Description
»»' 2
,
»»2 3
	Emphasize
…… 
=
…… 
identity
…… $
.
……$ %
	Emphasize
……% .
,
……. /
Required
   
=
   
identity
   #
.
  # $
Required
  $ ,
,
  , -
Checked
ÀÀ 
=
ÀÀ 
check
ÀÀ 
||
ÀÀ  "
identity
ÀÀ# +
.
ÀÀ+ ,
Required
ÀÀ, 4
}
ÃÃ 
;
ÃÃ 
}
ÕÕ 	
public
œœ 
ScopeViewModel
œœ "
CreateScopeViewModel
œœ 2
(
œœ2 3
ParsedScopeValue
œœ3 C
parsedScopeValue
œœD T
,
œœT U
ApiScope
œœV ^
apiScope
œœ_ g
,
œœg h
bool
œœi m
check
œœn s
)
œœs t
{
–– 	
return
—— 
new
—— 
ScopeViewModel
—— %
{
““ 
Value
”” 
=
”” 
parsedScopeValue
”” (
.
””( )
RawValue
””) 1
,
””1 2
DisplayName
’’ 
=
’’ 
apiScope
’’ &
.
’’& '
DisplayName
’’' 2
??
’’3 5
apiScope
’’6 >
.
’’> ?
Name
’’? C
,
’’C D
Description
÷÷ 
=
÷÷ 
apiScope
÷÷ &
.
÷÷& '
Description
÷÷' 2
,
÷÷2 3
	Emphasize
◊◊ 
=
◊◊ 
apiScope
◊◊ $
.
◊◊$ %
	Emphasize
◊◊% .
,
◊◊. /
Required
ÿÿ 
=
ÿÿ 
apiScope
ÿÿ #
.
ÿÿ# $
Required
ÿÿ$ ,
,
ÿÿ, -
Checked
ŸŸ 
=
ŸŸ 
check
ŸŸ 
||
ŸŸ  "
apiScope
ŸŸ# +
.
ŸŸ+ ,
Required
ŸŸ, 4
}
⁄⁄ 
;
⁄⁄ 
}
€€ 	
private
‹‹ 
ScopeViewModel
‹‹ #
GetOfflineAccessScope
‹‹ 4
(
‹‹4 5
bool
‹‹5 9
check
‹‹: ?
)
‹‹? @
{
›› 	
return
ﬁﬁ 
new
ﬁﬁ 
ScopeViewModel
ﬁﬁ %
{
ﬂﬂ 
Value
‡‡ 
=
‡‡ 
IdentityServer4
‡‡ '
.
‡‡' (%
IdentityServerConstants
‡‡( ?
.
‡‡? @
StandardScopes
‡‡@ N
.
‡‡N O
OfflineAccess
‡‡O \
,
‡‡\ ]
DisplayName
·· 
=
·· 
ConsentOptions
·· ,
.
··, -&
OfflineAccessDisplayName
··- E
,
··E F
Description
‚‚ 
=
‚‚ 
ConsentOptions
‚‚ ,
.
‚‚, -&
OfflineAccessDescription
‚‚- E
,
‚‚E F
	Emphasize
„„ 
=
„„ 
true
„„  
,
„„  !
Checked
‰‰ 
=
‰‰ 
check
‰‰ 
}
ÂÂ 
;
ÂÂ 
}
ÊÊ 	
}
ÁÁ 
}ËË –
´C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Diagnostics\DiagnosticsController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[ 
SecurityHeaders 
] 
[ 
	Authorize 
] 
public 

class !
DiagnosticsController &
:' (

Controller) 3
{ 
public 
async 
Task 
< 
IActionResult '
>' (
Index) .
(. /
)/ 0
{ 	
var 
localAddresses 
=  
new! $
string% +
[+ ,
], -
{. /
$str0 ;
,; <
$str= B
,B C
HttpContextD O
.O P

ConnectionP Z
.Z [
LocalIpAddress[ i
.i j
ToStringj r
(r s
)s t
}u v
;v w
if 
( 
! 
localAddresses 
.  
Contains  (
(( )
HttpContext) 4
.4 5

Connection5 ?
.? @
RemoteIpAddress@ O
.O P
ToStringP X
(X Y
)Y Z
)Z [
)[ \
{ 
return 
NotFound 
(  
)  !
;! "
} 
var 
model 
= 
new  
DiagnosticsViewModel 0
(0 1
await1 6
HttpContext7 B
.B C
AuthenticateAsyncC T
(T U
)U V
)V W
;W X
return 
View 
( 
model 
) 
; 
} 	
} 
} ¬
™C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Diagnostics\DiagnosticsViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class  
DiagnosticsViewModel %
{ 
public  
DiagnosticsViewModel #
(# $
AuthenticateResult$ 6
result7 =
)= >
{ 	
AuthenticateResult 
=  
result! '
;' (
if 
( 
result 
. 

Properties !
.! "
Items" '
.' (
ContainsKey( 3
(3 4
$str4 A
)A B
)B C
{ 
var 
encoded 
= 
result $
.$ %

Properties% /
./ 0
Items0 5
[5 6
$str6 C
]C D
;D E
var 
bytes 
= 
	Base64Url %
.% &
Decode& ,
(, -
encoded- 4
)4 5
;5 6
var 
value 
= 
Encoding $
.$ %
UTF8% )
.) *
	GetString* 3
(3 4
bytes4 9
)9 :
;: ;
Clients 
= 
JsonConvert %
.% &
DeserializeObject& 7
<7 8
string8 >
[> ?
]? @
>@ A
(A B
valueB G
)G H
;H I
} 
} 	
public 
AuthenticateResult !
AuthenticateResult" 4
{5 6
get7 :
;: ;
}< =
public 
IEnumerable 
< 
string !
>! "
Clients# *
{+ ,
get- 0
;0 1
}2 3
=4 5
new6 9
List: >
<> ?
string? E
>E F
(F G
)G H
;H I
} 
}   µ
îC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Extensions.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

static 
class 

Extensions "
{ 
public 
static 
bool 
IsNativeClient )
() *
this* . 
AuthorizationRequest/ C
contextD K
)K L
{ 	
return 
! 
context 
. 
RedirectUri '
.' (

StartsWith( 2
(2 3
$str3 :
,: ;
StringComparison< L
.L M
OrdinalM T
)T U
&& 
! 
context 
. 
RedirectUri &
.& '

StartsWith' 1
(1 2
$str2 8
,8 9
StringComparison: J
.J K
OrdinalK R
)R S
;S T
} 	
public 
static 
IActionResult #
LoadingPage$ /
(/ 0
this0 4

Controller5 ?

controller@ J
,J K
stringL R
viewNameS [
,[ \
string] c
redirectUrid o
)o p
{ 	

controller 
. 
HttpContext "
." #
Response# +
.+ ,

StatusCode, 6
=7 8
$num9 <
;< =

controller 
. 
HttpContext "
." #
Response# +
.+ ,
Headers, 3
[3 4
$str4 >
]> ?
=@ A
$strB D
;D E
return 

controller 
. 
View "
(" #
viewName# +
,+ ,
new- 0
RedirectViewModel1 B
{C D
RedirectUrlE P
=Q R
redirectUriS ^
}_ `
)` a
;a b
} 	
} 
} õ3
°C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Grants\GrantsController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[ 
SecurityHeaders 
] 
[ 
	Authorize 
] 
public 

class 
GrantsController !
:" #

Controller$ .
{ 
private 
readonly -
!IIdentityServerInteractionService :
_interaction; G
;G H
private 
readonly 
IClientStore %
_clients& .
;. /
private 
readonly 
IResourceStore '

_resources( 2
;2 3
private 
readonly 
IEventService &
_events' .
;. /
public 
GrantsController 
(  -
!IIdentityServerInteractionService  A
interactionB M
,M N
IClientStore 
clients  
,  !
IResourceStore 
	resources $
,$ %
IEventService   
events    
)    !
{!! 	
_interaction"" 
="" 
interaction"" &
;""& '
_clients## 
=## 
clients## 
;## 

_resources$$ 
=$$ 
	resources$$ "
;$$" #
_events%% 
=%% 
events%% 
;%% 
}&& 	
[++ 	
HttpGet++	 
]++ 
public,, 
async,, 
Task,, 
<,, 
IActionResult,, '
>,,' (
Index,,) .
(,,. /
),,/ 0
{-- 	
return.. 
View.. 
(.. 
$str.. 
,..  
await..! &
BuildViewModelAsync..' :
(..: ;
)..; <
)..< =
;..= >
}// 	
[44 	
HttpPost44	 
]44 
[55 	$
ValidateAntiForgeryToken55	 !
]55! "
public66 
async66 
Task66 
<66 
IActionResult66 '
>66' (
Revoke66) /
(66/ 0
string660 6
clientId667 ?
)66? @
{77 	
await88 
_interaction88 
.88 "
RevokeUserConsentAsync88 5
(885 6
clientId886 >
)88> ?
;88? @
await99 
_events99 
.99 

RaiseAsync99 $
(99$ %
new99% (
GrantsRevokedEvent99) ;
(99; <
User99< @
.99@ A
GetSubjectId99A M
(99M N
)99N O
,99O P
clientId99Q Y
)99Y Z
)99Z [
;99[ \
return;; 
RedirectToAction;; #
(;;# $
$str;;$ +
);;+ ,
;;;, -
}<< 	
private>> 
async>> 
Task>> 
<>> 
GrantsViewModel>> *
>>>* +
BuildViewModelAsync>>, ?
(>>? @
)>>@ A
{?? 	
var@@ 
grants@@ 
=@@ 
await@@ 
_interaction@@ +
.@@+ ,!
GetAllUserGrantsAsync@@, A
(@@A B
)@@B C
;@@C D
varBB 
listBB 
=BB 
newBB 
ListBB 
<BB  
GrantViewModelBB  .
>BB. /
(BB/ 0
)BB0 1
;BB1 2
foreachCC 
(CC 
varCC 
grantCC 
inCC !
grantsCC" (
)CC( )
{DD 
varEE 
clientEE 
=EE 
awaitEE "
_clientsEE# +
.EE+ ,
FindClientByIdAsyncEE, ?
(EE? @
grantEE@ E
.EEE F
ClientIdEEF N
)EEN O
;EEO P
ifFF 
(FF 
clientFF 
!=FF 
nullFF "
)FF" #
{GG 
varHH 
	resourcesHH !
=HH" #
awaitHH$ )

_resourcesHH* 4
.HH4 5%
FindResourcesByScopeAsyncHH5 N
(HHN O
grantHHO T
.HHT U
ScopesHHU [
)HH[ \
;HH\ ]
varJJ 
itemJJ 
=JJ 
newJJ "
GrantViewModelJJ# 1
(JJ1 2
)JJ2 3
{KK 
ClientIdLL  
=LL! "
clientLL# )
.LL) *
ClientIdLL* 2
,LL2 3

ClientNameMM "
=MM# $
clientMM% +
.MM+ ,

ClientNameMM, 6
??MM7 9
clientMM: @
.MM@ A
ClientIdMMA I
,MMI J
ClientLogoUrlNN %
=NN& '
clientNN( .
.NN. /
LogoUriNN/ 6
,NN6 7
	ClientUrlOO !
=OO" #
clientOO$ *
.OO* +
	ClientUriOO+ 4
,OO4 5
DescriptionPP #
=PP$ %
grantPP& +
.PP+ ,
DescriptionPP, 7
,PP7 8
CreatedQQ 
=QQ  !
grantQQ" '
.QQ' (
CreationTimeQQ( 4
,QQ4 5
ExpiresRR 
=RR  !
grantRR" '
.RR' (

ExpirationRR( 2
,RR2 3
IdentityGrantNamesSS *
=SS+ ,
	resourcesSS- 6
.SS6 7
IdentityResourcesSS7 H
.SSH I
SelectSSI O
(SSO P
xSSP Q
=>SSR T
xSSU V
.SSV W
DisplayNameSSW b
??SSc e
xSSf g
.SSg h
NameSSh l
)SSl m
.SSm n
ToArraySSn u
(SSu v
)SSv w
,SSw x
ApiGrantNamesTT %
=TT& '
	resourcesTT( 1
.TT1 2
	ApiScopesTT2 ;
.TT; <
SelectTT< B
(TTB C
xTTC D
=>TTE G
xTTH I
.TTI J
DisplayNameTTJ U
??TTV X
xTTY Z
.TTZ [
NameTT[ _
)TT_ `
.TT` a
ToArrayTTa h
(TTh i
)TTi j
}UU 
;UU 
listWW 
.WW 
AddWW 
(WW 
itemWW !
)WW! "
;WW" #
}XX 
}YY 
return[[ 
new[[ 
GrantsViewModel[[ &
{\\ 
Grants]] 
=]] 
list]] 
}^^ 
;^^ 
}__ 	
}`` 
}aa È
†C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Grants\GrantsViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{		 
public

 

class

 
GrantsViewModel

  
{ 
public 
IEnumerable 
< 
GrantViewModel )
>) *
Grants+ 1
{2 3
get4 7
;7 8
set9 <
;< =
}> ?
} 
public 

class 
GrantViewModel 
{ 
public 
string 
ClientId 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
string 

ClientName  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
string 
	ClientUrl 
{  !
get" %
;% &
set' *
;* +
}, -
public 
string 
ClientLogoUrl #
{$ %
get& )
;) *
set+ .
;. /
}0 1
public 
string 
Description !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 
DateTime 
Created 
{  !
get" %
;% &
set' *
;* +
}, -
public 
DateTime 
? 
Expires  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
IEnumerable 
< 
string !
>! "
IdentityGrantNames# 5
{6 7
get8 ;
;; <
set= @
;@ A
}B C
public 
IEnumerable 
< 
string !
>! "
ApiGrantNames# 0
{1 2
get3 6
;6 7
set8 ;
;; <
}= >
} 
} „
ùC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Home\ErrorViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public		 

class		 
ErrorViewModel		 
{

 
public 
ErrorViewModel 
( 
) 
{ 	
} 	
public 
ErrorViewModel 
( 
string $
error% *
)* +
{ 	
Error 
= 
new 
ErrorMessage $
{% &
Error' ,
=- .
error/ 4
}5 6
;6 7
} 	
public 
ErrorMessage 
Error !
{" #
get$ '
;' (
set) ,
;, -
}. /
} 
} ¶
ùC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Home\HomeController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[ 
SecurityHeaders 
] 
[ 
AllowAnonymous 
] 
public 

class 
HomeController 
:  !

Controller" ,
{ 
private 
readonly -
!IIdentityServerInteractionService :
_interaction; G
;G H
private 
readonly 
IWebHostEnvironment ,
_environment- 9
;9 :
private 
readonly 
ILogger  
_logger! (
;( )
public 
HomeController 
( -
!IIdentityServerInteractionService ?
interaction@ K
,K L
IWebHostEnvironmentM `
environmenta l
,l m
ILoggern u
<u v
HomeController	v Ñ
>
Ñ Ö
logger
Ü å
)
å ç
{ 	
_interaction 
= 
interaction &
;& '
_environment 
= 
environment &
;& '
_logger 
= 
logger 
; 
} 	
public 
IActionResult 
Index "
(" #
)# $
{ 	
if   
(   
_environment   
.   
IsDevelopment   *
(  * +
)  + ,
)  , -
{!! 
return## 
View## 
(## 
)## 
;## 
}$$ 
_logger&& 
.&& 
LogInformation&& "
(&&" #
$str&&# W
)&&W X
;&&X Y
return'' 
NotFound'' 
('' 
)'' 
;'' 
}(( 	
public-- 
async-- 
Task-- 
<-- 
IActionResult-- '
>--' (
Error--) .
(--. /
string--/ 5
errorId--6 =
)--= >
{.. 	
var// 
vm// 
=// 
new// 
ErrorViewModel// '
(//' (
)//( )
;//) *
var22 
message22 
=22 
await22 
_interaction22  ,
.22, - 
GetErrorContextAsync22- A
(22A B
errorId22B I
)22I J
;22J K
if33 
(33 
message33 
!=33 
null33 
)33  
{44 
vm55 
.55 
Error55 
=55 
message55 "
;55" #
if77 
(77 
!77 
_environment77 !
.77! "
IsDevelopment77" /
(77/ 0
)770 1
)771 2
{88 
message:: 
.:: 
ErrorDescription:: ,
=::- .
null::/ 3
;::3 4
};; 
}<< 
return>> 
View>> 
(>> 
$str>> 
,>>  
vm>>! #
)>># $
;>>$ %
}?? 	
}@@ 
}AA °
¢C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\SecurityHeadersAttribute.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{		 
public

 

class

 $
SecurityHeadersAttribute

 )
:

* +!
ActionFilterAttribute

, A
{ 
public 
override 
void 
OnResultExecuting .
(. /"
ResultExecutingContext/ E
contextF M
)M N
{ 	
var 
result 
= 
context  
.  !
Result! '
;' (
if 
( 
result 
is 

ViewResult $
)$ %
{ 
if 
( 
! 
context 
. 
HttpContext (
.( )
Response) 1
.1 2
Headers2 9
.9 :
ContainsKey: E
(E F
$strF ^
)^ _
)_ `
{ 
context 
. 
HttpContext '
.' (
Response( 0
.0 1
Headers1 8
.8 9
Add9 <
(< =
$str= U
,U V
$strW `
)` a
;a b
} 
if 
( 
! 
context 
. 
HttpContext (
.( )
Response) 1
.1 2
Headers2 9
.9 :
ContainsKey: E
(E F
$strF W
)W X
)X Y
{ 
context 
. 
HttpContext '
.' (
Response( 0
.0 1
Headers1 8
.8 9
Add9 <
(< =
$str= N
,N O
$strP \
)\ ]
;] ^
} 
var 
csp 
= 
$str	 †
;
† °
if%% 
(%% 
!%% 
context%% 
.%% 
HttpContext%% (
.%%( )
Response%%) 1
.%%1 2
Headers%%2 9
.%%9 :
ContainsKey%%: E
(%%E F
$str%%F _
)%%_ `
)%%` a
{&& 
context'' 
.'' 
HttpContext'' '
.''' (
Response''( 0
.''0 1
Headers''1 8
.''8 9
Add''9 <
(''< =
$str''= V
,''V W
csp''X [
)''[ \
;''\ ]
}(( 
if** 
(** 
!** 
context** 
.** 
HttpContext** (
.**( )
Response**) 1
.**1 2
Headers**2 9
.**9 :
ContainsKey**: E
(**E F
$str**F a
)**a b
)**b c
{++ 
context,, 
.,, 
HttpContext,, '
.,,' (
Response,,( 0
.,,0 1
Headers,,1 8
.,,8 9
Add,,9 <
(,,< =
$str,,= X
,,,X Y
csp,,Z ]
),,] ^
;,,^ _
}-- 
var00 
referrer_policy00 #
=00$ %
$str00& 3
;003 4
if11 
(11 
!11 
context11 
.11 
HttpContext11 (
.11( )
Response11) 1
.111 2
Headers112 9
.119 :
ContainsKey11: E
(11E F
$str11F W
)11W X
)11X Y
{22 
context33 
.33 
HttpContext33 '
.33' (
Response33( 0
.330 1
Headers331 8
.338 9
Add339 <
(33< =
$str33= N
,33N O
referrer_policy33P _
)33_ `
;33` a
}44 
}55 
}66 	
}77 
}88 â
òC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Specific\Class.cs
	namespace 	
IdentityServer
 
. 

Quickstart #
.# $
Specific$ ,
{ 
public 

enum 

Permission 
{ 
Read 
, 
Create 
, 
Update 
, 
Delete 
}		 
}

 Õ
óC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Specific\Role.cs
	namespace 	
IdentityServer
 
. 

Quickstart #
.# $
Specific$ ,
{ 
public 

enum 
Role 
{ 
Buyer 
, 
Manager 
, 
} 
} É
°C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Specific\RolePermission.cs
	namespace 	
IdentityServer
 
. 

Quickstart #
.# $
Specific$ ,
{ 
public 

static 
class 
RolePermission &
{ 
private 
static 

Dictionary !
<! "
Role" &
,& '

Permission( 2
[2 3
]3 4
>4 5
_rolePermissions6 F
=G H
newI L

DictionaryM W
<W X
RoleX \
,\ ]

Permission^ h
[h i
]i j
>j k
{ 	
{		 
Role		 
.		 
Buyer		 
,		 
new		 

Permission		 (
[		( )
]		) *
{		+ ,

Permission		- 7
.		7 8
Read		8 <
}		= >
}		? @
,		@ A
{

 
Role

 
.

 
Manager

 
,

 
new

 

Permission

  *
[

* +
]

+ ,
{

- .

Permission

/ 9
.

9 :
Read

: >
,

> ?

Permission

@ J
.

J K
Create

K Q
,

Q R

Permission

S ]
.

] ^
Update

^ d
,

d e

Permission

f p
.

p q
Delete

q w
}

x y
}

z {
,

{ |
} 	
;	 

public 
static 

Permission  
[  !
]! "
GetPermissions# 1
(1 2
Role2 6
role7 ;
); <
=>= ?
_rolePermissions@ P
[P Q
roleQ U
]U V
;V W
} 
} *
ìC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\TestUsers.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
	TestUsers 
{ 
public 
static 
List 
< 
TestUser #
># $
Users% *
{ 	
get 
{ 
var 
address 
= 
new !
{ 
street_address "
=# $
$str% 5
,5 6
locality 
= 
$str +
,+ ,
postal_code 
=  !
$num" '
,' (
country 
= 
$str '
} 
; 
return 
new 
List 
<  
TestUser  (
>( )
{ 
new 
TestUser  
{   
	SubjectId!! !
=!!" #
$str!!$ ,
,!!, -
Username""  
=""! "
$str""# *
,""* +
Password##  
=##! "
$str### *
,##* +
Claims$$ 
=$$  
{%% 
new&& 
Claim&&  %
(&&% &
JwtClaimTypes&&& 3
.&&3 4
Name&&4 8
,&&8 9
$str&&: G
)&&G H
,&&H I
new'' 
Claim''  %
(''% &
JwtClaimTypes''& 3
.''3 4
	GivenName''4 =
,''= >
$str''? F
)''F G
,''G H
new(( 
Claim((  %
(((% &
JwtClaimTypes((& 3
.((3 4

FamilyName((4 >
,((> ?
$str((@ G
)((G H
,((H I
new)) 
Claim))  %
())% &
JwtClaimTypes))& 3
.))3 4
Email))4 9
,))9 :
$str)); Q
)))Q R
,))R S
new** 
Claim**  %
(**% &
JwtClaimTypes**& 3
.**3 4
EmailVerified**4 A
,**A B
$str**C I
,**I J
ClaimValueTypes**K Z
.**Z [
Boolean**[ b
)**b c
,**c d
new++ 
Claim++  %
(++% &
JwtClaimTypes++& 3
.++3 4
WebSite++4 ;
,++; <
$str++= O
)++O P
,++P Q
new,, 
Claim,,  %
(,,% &
JwtClaimTypes,,& 3
.,,3 4
Address,,4 ;
,,,; <
JsonSerializer,,= K
.,,K L
	Serialize,,L U
(,,U V
address,,V ]
),,] ^
,,,^ _#
IdentityServerConstants,,` w
.,,w x
ClaimValueTypes	,,x á
.
,,á à
Json
,,à å
)
,,å ç
,
,,ç é
new-- 
Claim--  %
(--% &
JwtClaimTypes--& 3
.--3 4
Role--4 8
,--8 9
Role--: >
.--> ?
Manager--? F
.--F G
ToString--G O
(--O P
)--P Q
)--Q R
}.. 
}// 
,// 
new00 
TestUser00  
{11 
	SubjectId22 !
=22" #
$str22$ .
,22. /
Username33  
=33! "
$str33# (
,33( )
Password44  
=44! "
$str44# (
,44( )
Claims55 
=55  
{66 
new77 
Claim77  %
(77% &
JwtClaimTypes77& 3
.773 4
Name774 8
,778 9
$str77: E
)77E F
,77F G
new88 
Claim88  %
(88% &
JwtClaimTypes88& 3
.883 4
	GivenName884 =
,88= >
$str88? D
)88D E
,88E F
new99 
Claim99  %
(99% &
JwtClaimTypes99& 3
.993 4

FamilyName994 >
,99> ?
$str99@ G
)99G H
,99H I
new:: 
Claim::  %
(::% &
JwtClaimTypes::& 3
.::3 4
Email::4 9
,::9 :
$str::; O
)::O P
,::P Q
new;; 
Claim;;  %
(;;% &
JwtClaimTypes;;& 3
.;;3 4
EmailVerified;;4 A
,;;A B
$str;;C I
,;;I J
ClaimValueTypes;;K Z
.;;Z [
Boolean;;[ b
);;b c
,;;c d
new<< 
Claim<<  %
(<<% &
JwtClaimTypes<<& 3
.<<3 4
WebSite<<4 ;
,<<; <
$str<<= M
)<<M N
,<<N O
new== 
Claim==  %
(==% &
JwtClaimTypes==& 3
.==3 4
Address==4 ;
,==; <
JsonSerializer=== K
.==K L
	Serialize==L U
(==U V
address==V ]
)==] ^
,==^ _#
IdentityServerConstants==` w
.==w x
ClaimValueTypes	==x á
.
==á à
Json
==à å
)
==å ç
,
==ç é
new>> 
Claim>>  %
(>>% &
JwtClaimTypes>>& 3
.>>3 4
Role>>4 8
,>>8 9
Role>>: >
.>>> ?
Buyer>>? D
.>>D E
ToString>>E M
(>>M N
)>>N O
)>>O P
}?? 
}@@ 
}AA 
;AA 
}BB 
}CC 	
}DD 
}EE %
ÜC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Startup.cs
	namespace 	
IdentityServer
 
{ 
public 

class 
Startup 
{ 
public 
IWebHostEnvironment "
Environment# .
{/ 0
get1 4
;4 5
}6 7
public 
IConfiguration 
Configuration +
{, -
get. 1
;1 2
}3 4
public 
Startup 
( 
IWebHostEnvironment *
environment+ 6
,6 7
IConfiguration8 F
configurationG T
)T U
{ 	
Environment 
= 
environment %
;% &
Configuration 
= 
configuration )
;) *
} 	
public 
void 
ConfigureServices %
(% &
IServiceCollection& 8
services9 A
)A B
{ 	
services 
. #
AddControllersWithViews ,
(, -
)- .
;. /
var 
builder 
= 
services "
." #
AddIdentityServer# 4
(4 5
options5 <
=>= ?
{ 
options   
.   
Events   
.   
RaiseErrorEvents   /
=  0 1
true  2 6
;  6 7
options!! 
.!! 
Events!! 
.!! "
RaiseInformationEvents!! 5
=!!6 7
true!!8 <
;!!< =
options"" 
."" 
Events"" 
."" 
RaiseFailureEvents"" 1
=""2 3
true""4 8
;""8 9
options## 
.## 
Events## 
.## 
RaiseSuccessEvents## 1
=##2 3
true##4 8
;##8 9
options&& 
.&& #
EmitStaticAudienceClaim&& /
=&&0 1
true&&2 6
;&&6 7
}'' 
)'' 
.(( 
AddTestUsers(( 
((( 
	TestUsers(( '
.((' (
Users((( -
)((- .
;((. /
builder++ 
.++ (
AddInMemoryIdentityResources++ 0
(++0 1
Config++1 7
.++7 8
IdentityResources++8 I
)++I J
;++J K
builder,, 
.,,  
AddInMemoryApiScopes,, (
(,,( )
Config,,) /
.,,/ 0
	ApiScopes,,0 9
),,9 :
;,,: ;
builder-- 
.-- 
AddInMemoryClients-- &
(--& '
Config--' -
.--- .
Clients--. 5
)--5 6
;--6 7
builder00 
.00 )
AddDeveloperSigningCredential00 1
(001 2
)002 3
;003 4
services22 
.22 
AddAuthentication22 &
(22& '
)22' (
.33 
	AddGoogle33 
(33 
options33 "
=>33# %
{44 
options55 
.55 
SignInScheme55 (
=55) *#
IdentityServerConstants55+ B
.55B C.
"ExternalCookieAuthenticationScheme55C e
;55e f
options:: 
.:: 
ClientId:: $
=::% &
$str::' H
;::H I
options;; 
.;; 
ClientSecret;; (
=;;) *
$str;;+ P
;;;P Q
}<< 
)<< 
;<< 
}== 	
public?? 
void?? 
	Configure?? 
(?? 
IApplicationBuilder?? 1
app??2 5
)??5 6
{@@ 	
ifAA 
(AA 
EnvironmentAA 
.AA 
IsDevelopmentAA )
(AA) *
)AA* +
)AA+ ,
{BB 
appCC 
.CC %
UseDeveloperExceptionPageCC -
(CC- .
)CC. /
;CC/ 0
}DD 
appFF 
.FF 
UseStaticFilesFF 
(FF 
)FF  
;FF  !
appHH 
.HH 

UseRoutingHH 
(HH 
)HH 
;HH 
appII 
.II 
UseIdentityServerII !
(II! "
)II" #
;II# $
appJJ 
.JJ 
UseAuthorizationJJ  
(JJ  !
)JJ! "
;JJ" #
appKK 
.KK 
UseEndpointsKK 
(KK 
	endpointsKK &
=>KK' )
{LL 
	endpointsMM 
.MM %
MapDefaultControllerRouteMM 3
(MM3 4
)MM4 5
;MM5 6
}NN 
)NN 
;NN 
}OO 	
}PP 
}QQ 