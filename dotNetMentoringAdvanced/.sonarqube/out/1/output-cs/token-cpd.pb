¬
ÖC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Config.cs
	namespace 	
IdentityServer
 
{		 
public

 

static

 
class

 
Config

 
{ 
public 
static 
IEnumerable !
<! "
IdentityResource" 2
>2 3
IdentityResources4 E
=>F H
new 
IdentityResource  
[  !
]! "
{ 
new 
IdentityResources %
.% &
OpenId& ,
(, -
)- .
,. /
new 
IdentityResources %
.% &
Profile& -
(- .
). /
,/ 0
} 
; 
public 
static 
IEnumerable !
<! "
ApiScope" *
>* +
	ApiScopes, 5
=>6 8
new 
ApiScope 
[ 
] 
{ 
new 
ApiScope 
( 
$str &
)& '
,' (
} 
; 
public 
static 
IEnumerable !
<! "
Client" (
>( )
Clients* 1
=>2 4
new 
Client 
[ 
] 
{ 
new 
Client 
{ 
ClientId 
= 
$str +
,+ ,

ClientName   
=    
$str  ! <
,  < =
AllowedGrantTypes"" %
=""& '

GrantTypes""( 2
.""2 3
ClientCredentials""3 D
,""D E
ClientSecrets## !
=##" #
{##$ %
new##& )
Secret##* 0
(##0 1
$str##1 W
.##W X
Sha256##X ^
(##^ _
)##_ `
)##` a
}##b c
,##c d
AllowedScopes%% !
=%%" #
{%%$ %
$str%%& .
,%%. /
$str%%0 9
}%%: ;
}&& 
,&& 
new)) 
Client)) 
{** 
ClientId++ 
=++ 
$str++ ,
,++, -
ClientSecrets,, !
=,," #
{,,$ %
new,,& )
Secret,,* 0
(,,0 1
$str,,1 W
.,,W X
Sha256,,X ^
(,,^ _
),,_ `
),,` a
},,b c
,,,c d
AllowedGrantTypes.. %
=..& '

GrantTypes..( 2
...2 3
Code..3 7
,..7 8
RedirectUris00  
=00! "
{00# $
$str00% J
}00K L
,00L M!
FrontChannelLogoutUri11 )
=11* +
$str11, R
,11R S"
PostLogoutRedirectUris22 *
=22+ ,
{22- .
$str22/ ^
}22_ `
,22` a
AllowOfflineAccess44 &
=44' (
true44) -
,44- .
AllowedScopes55 !
=55" #
{55$ %
$str55& .
,55. /
$str550 9
,559 :
$str55; D
}55E F
}66 
,66 
}77 
;77 
}88 
}99 Ü
ÜC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Program.cs
	namespace 	
IdentityServer
 
{ 
public 

static 
class 
Program 
{ 
public 
static 
int 
Main 
( 
string %
[% &
]& '
args( ,
), -
{ 	
Log 
. 
Logger 
= 
new 
LoggerConfiguration 0
(0 1
)1 2
. 
MinimumLevel 
. 
Debug #
(# $
)$ %
. 
MinimumLevel 
. 
Override &
(& '
$str' 2
,2 3
LogEventLevel4 A
.A B
WarningB I
)I J
. 
MinimumLevel 
. 
Override &
(& '
$str' C
,C D
LogEventLevelE R
.R S
InformationS ^
)^ _
. 
MinimumLevel 
. 
Override &
(& '
$str' /
,/ 0
LogEventLevel1 >
.> ?
Warning? F
)F G
. 
MinimumLevel 
. 
Override &
(& '
$str' L
,L M
LogEventLevelN [
.[ \
Information\ g
)g h
. 
Enrich 
. 
FromLogContext &
(& '
)' (
.   
WriteTo   
.   
Console    
(    !
outputTemplate  ! /
:  / 0
$str	  1 ì
,
  ì î
theme
  ï ö
:
  ö õ
AnsiConsoleTheme
  ú ¨
.
  ¨ ≠
Code
  ≠ ±
)
  ± ≤
.!! 
CreateLogger!! 
(!! 
)!! 
;!!  
try## 
{$$ 
Log%% 
.%% 
Information%% 
(%%  
$str%%  2
)%%2 3
;%%3 4
CreateHostBuilder&& !
(&&! "
args&&" &
)&&& '
.&&' (
Build&&( -
(&&- .
)&&. /
.&&/ 0
Run&&0 3
(&&3 4
)&&4 5
;&&5 6
return'' 
$num'' 
;'' 
}(( 
catch)) 
()) 
	Exception)) 
ex)) 
)))  
{** 
Log++ 
.++ 
Fatal++ 
(++ 
ex++ 
,++ 
$str++ =
)++= >
;++> ?
return,, 
$num,, 
;,, 
}-- 
finally.. 
{// 
Log00 
.00 
CloseAndFlush00 !
(00! "
)00" #
;00# $
}11 
}22 	
public44 
static44 
IHostBuilder44 "
CreateHostBuilder44# 4
(444 5
string445 ;
[44; <
]44< =
args44> B
)44B C
=>44D F
Host55 
.55  
CreateDefaultBuilder55 %
(55% &
args55& *
)55* +
.66 

UseSerilog66 
(66 
)66 
.77 $
ConfigureWebHostDefaults77 )
(77) *

webBuilder77* 4
=>775 7
{88 

webBuilder99 
.99 

UseStartup99 )
<99) *
Startup99* 1
>991 2
(992 3
)993 4
;994 5
}:: 
):: 
;:: 
};; 
}<< ¢œ
£C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Account\AccountController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[ 
SecurityHeaders 
] 
[ 
AllowAnonymous 
] 
public 

class 
AccountController "
:# $

Controller% /
{ 
private   
readonly   
TestUserStore   &
_users  ' -
;  - .
private!! 
readonly!! -
!IIdentityServerInteractionService!! :
_interaction!!; G
;!!G H
private"" 
readonly"" 
IClientStore"" %
_clientStore""& 2
;""2 3
private## 
readonly## )
IAuthenticationSchemeProvider## 6
_schemeProvider##7 F
;##F G
private$$ 
readonly$$ 
IEventService$$ &
_events$$' .
;$$. /
public&& 
AccountController&&  
(&&  !-
!IIdentityServerInteractionService'' -
interaction''. 9
,''9 :
IClientStore(( 
clientStore(( $
,(($ %)
IAuthenticationSchemeProvider)) )
schemeProvider))* 8
,))8 9
IEventService** 
events**  
,**  !
TestUserStore++ 
users++ 
=++  !
null++" &
)++& '
{,, 	
_users// 
=// 
users// 
??// 
new// !
TestUserStore//" /
(/// 0
	TestUsers//0 9
.//9 :
Users//: ?
)//? @
;//@ A
_interaction11 
=11 
interaction11 &
;11& '
_clientStore22 
=22 
clientStore22 &
;22& '
_schemeProvider33 
=33 
schemeProvider33 ,
;33, -
_events44 
=44 
events44 
;44 
}55 	
[:: 	
HttpGet::	 
]:: 
public;; 
async;; 
Task;; 
<;; 
IActionResult;; '
>;;' (
Login;;) .
(;;. /
string;;/ 5
	returnUrl;;6 ?
);;? @
{<< 	
var>> 
vm>> 
=>> 
await>> $
BuildLoginViewModelAsync>> 3
(>>3 4
	returnUrl>>4 =
)>>= >
;>>> ?
if@@ 
(@@ 
vm@@ 
.@@ 
IsExternalLoginOnly@@ &
)@@& '
{AA 
returnCC 
RedirectToActionCC '
(CC' (
$strCC( 3
,CC3 4
$strCC5 ?
,CC? @
newCCA D
{CCE F
schemeCCG M
=CCN O
vmCCP R
.CCR S
ExternalLoginSchemeCCS f
,CCf g
	returnUrlCCh q
}CCr s
)CCs t
;CCt u
}DD 
returnFF 
ViewFF 
(FF 
vmFF 
)FF 
;FF 
}GG 	
[LL 	
HttpPostLL	 
]LL 
[MM 	$
ValidateAntiForgeryTokenMM	 !
]MM! "
publicNN 
asyncNN 
TaskNN 
<NN 
IActionResultNN '
>NN' (
LoginNN) .
(NN. /
LoginInputModelNN/ >
modelNN? D
,NND E
stringNNF L
buttonNNM S
)NNS T
{OO 	
varQQ 
contextQQ 
=QQ 
awaitQQ 
_interactionQQ  ,
.QQ, -(
GetAuthorizationContextAsyncQQ- I
(QQI J
modelQQJ O
.QQO P
	ReturnUrlQQP Y
)QQY Z
;QQZ [
ifTT 
(TT 
buttonTT 
!=TT 
$strTT !
)TT! "
{UU 
ifVV 
(VV 
contextVV 
!=VV 
nullVV #
)VV# $
{WW 
await[[ 
_interaction[[ &
.[[& '"
DenyAuthorizationAsync[[' =
([[= >
context[[> E
,[[E F
AuthorizationError[[G Y
.[[Y Z
AccessDenied[[Z f
)[[f g
;[[g h
if^^ 
(^^ 
context^^ 
.^^  
IsNativeClient^^  .
(^^. /
)^^/ 0
)^^0 1
{__ 
returnbb 
thisbb #
.bb# $
LoadingPagebb$ /
(bb/ 0
$strbb0 :
,bb: ;
modelbb< A
.bbA B
	ReturnUrlbbB K
)bbK L
;bbL M
}cc 
returnee 
Redirectee #
(ee# $
modelee$ )
.ee) *
	ReturnUrlee* 3
)ee3 4
;ee4 5
}ff 
elsegg 
{hh 
returnjj 
Redirectjj #
(jj# $
$strjj$ (
)jj( )
;jj) *
}kk 
}ll 
ifnn 
(nn 

ModelStatenn 
.nn 
IsValidnn "
)nn" #
{oo 
ifqq 
(qq 
_usersqq 
.qq 
ValidateCredentialsqq .
(qq. /
modelqq/ 4
.qq4 5
Usernameqq5 =
,qq= >
modelqq? D
.qqD E
PasswordqqE M
)qqM N
)qqN O
{rr 
varss 
userss 
=ss 
_usersss %
.ss% &
FindByUsernamess& 4
(ss4 5
modelss5 :
.ss: ;
Usernamess; C
)ssC D
;ssD E
awaittt 
_eventstt !
.tt! "

RaiseAsynctt" ,
(tt, -
newtt- 0!
UserLoginSuccessEventtt1 F
(ttF G
userttG K
.ttK L
UsernamettL T
,ttT U
userttV Z
.ttZ [
	SubjectIdtt[ d
,ttd e
userttf j
.ttj k
Usernamettk s
,tts t
clientIdttu }
:tt} ~
context	tt Ü
?
ttÜ á
.
ttá à
Client
ttà é
.
tté è
ClientId
ttè ó
)
ttó ò
)
ttò ô
;
ttô ö$
AuthenticationPropertiesxx ,
propsxx- 2
=xx3 4
nullxx5 9
;xx9 :
ifyy 
(yy 
AccountOptionsyy &
.yy& '
AllowRememberLoginyy' 9
&&yy: <
modelyy= B
.yyB C
RememberLoginyyC P
)yyP Q
{zz 
props{{ 
={{ 
new{{  #$
AuthenticationProperties{{$ <
{|| 
IsPersistent}} (
=}}) *
true}}+ /
,}}/ 0

ExpiresUtc~~ &
=~~' (
DateTimeOffset~~) 7
.~~7 8
UtcNow~~8 >
.~~> ?
Add~~? B
(~~B C
AccountOptions~~C Q
.~~Q R#
RememberMeLoginDuration~~R i
)~~i j
} 
; 
}
ÄÄ 
;
ÄÄ 
var
ÉÉ 
isuser
ÉÉ 
=
ÉÉ  
new
ÉÉ! $ 
IdentityServerUser
ÉÉ% 7
(
ÉÉ7 8
user
ÉÉ8 <
.
ÉÉ< =
	SubjectId
ÉÉ= F
)
ÉÉF G
{
ÑÑ 
DisplayName
ÖÖ #
=
ÖÖ$ %
user
ÖÖ& *
.
ÖÖ* +
Username
ÖÖ+ 3
}
ÜÜ 
;
ÜÜ 
await
àà 
HttpContext
àà %
.
àà% &
SignInAsync
àà& 1
(
àà1 2
isuser
àà2 8
,
àà8 9
props
àà: ?
)
àà? @
;
àà@ A
if
ää 
(
ää 
context
ää 
!=
ää  "
null
ää# '
)
ää' (
{
ãã 
if
åå 
(
åå 
context
åå #
.
åå# $
IsNativeClient
åå$ 2
(
åå2 3
)
åå3 4
)
åå4 5
{
çç 
return
êê "
this
êê# '
.
êê' (
LoadingPage
êê( 3
(
êê3 4
$str
êê4 >
,
êê> ?
model
êê@ E
.
êêE F
	ReturnUrl
êêF O
)
êêO P
;
êêP Q
}
ëë 
return
îî 
Redirect
îî '
(
îî' (
model
îî( -
.
îî- .
	ReturnUrl
îî. 7
)
îî7 8
;
îî8 9
}
ïï 
if
òò 
(
òò 
Url
òò 
.
òò 

IsLocalUrl
òò &
(
òò& '
model
òò' ,
.
òò, -
	ReturnUrl
òò- 6
)
òò6 7
)
òò7 8
{
ôô 
return
öö 
Redirect
öö '
(
öö' (
model
öö( -
.
öö- .
	ReturnUrl
öö. 7
)
öö7 8
;
öö8 9
}
õõ 
else
úú 
if
úú 
(
úú 
string
úú #
.
úú# $
IsNullOrEmpty
úú$ 1
(
úú1 2
model
úú2 7
.
úú7 8
	ReturnUrl
úú8 A
)
úúA B
)
úúB C
{
ùù 
return
ûû 
Redirect
ûû '
(
ûû' (
$str
ûû( ,
)
ûû, -
;
ûû- .
}
üü 
else
†† 
{
°° 
throw
££ 
new
££ !
ArgumentException
££" 3
(
££3 4
$str
££4 H
)
££H I
;
££I J
}
§§ 
}
•• 
await
ßß 
_events
ßß 
.
ßß 

RaiseAsync
ßß (
(
ßß( )
new
ßß) ,#
UserLoginFailureEvent
ßß- B
(
ßßB C
model
ßßC H
.
ßßH I
Username
ßßI Q
,
ßßQ R
$str
ßßS h
,
ßßh i
clientId
ßßj r
:
ßßr s
context
ßßt {
?
ßß{ |
.
ßß| }
Clientßß} É
.ßßÉ Ñ
ClientIdßßÑ å
)ßßå ç
)ßßç é
;ßßé è

ModelState
®® 
.
®® 
AddModelError
®® (
(
®®( )
string
®®) /
.
®®/ 0
Empty
®®0 5
,
®®5 6
AccountOptions
®®7 E
.
®®E F,
InvalidCredentialsErrorMessage
®®F d
)
®®d e
;
®®e f
}
©© 
var
¨¨ 
vm
¨¨ 
=
¨¨ 
await
¨¨ &
BuildLoginViewModelAsync
¨¨ 3
(
¨¨3 4
model
¨¨4 9
)
¨¨9 :
;
¨¨: ;
return
≠≠ 
View
≠≠ 
(
≠≠ 
vm
≠≠ 
)
≠≠ 
;
≠≠ 
}
ÆÆ 	
[
≥≥ 	
HttpGet
≥≥	 
]
≥≥ 
public
¥¥ 
async
¥¥ 
Task
¥¥ 
<
¥¥ 
IActionResult
¥¥ '
>
¥¥' (
Logout
¥¥) /
(
¥¥/ 0
string
¥¥0 6
logoutId
¥¥7 ?
)
¥¥? @
{
µµ 	
var
∑∑ 
vm
∑∑ 
=
∑∑ 
await
∑∑ '
BuildLogoutViewModelAsync
∑∑ 4
(
∑∑4 5
logoutId
∑∑5 =
)
∑∑= >
;
∑∑> ?
if
ππ 
(
ππ 
vm
ππ 
.
ππ 
ShowLogoutPrompt
ππ #
==
ππ$ &
false
ππ' ,
)
ππ, -
{
∫∫ 
return
ΩΩ 
await
ΩΩ 
Logout
ΩΩ #
(
ΩΩ# $
vm
ΩΩ$ &
)
ΩΩ& '
;
ΩΩ' (
}
ææ 
return
¿¿ 
View
¿¿ 
(
¿¿ 
vm
¿¿ 
)
¿¿ 
;
¿¿ 
}
¡¡ 	
[
∆∆ 	
HttpPost
∆∆	 
]
∆∆ 
[
«« 	&
ValidateAntiForgeryToken
««	 !
]
««! "
public
»» 
async
»» 
Task
»» 
<
»» 
IActionResult
»» '
>
»»' (
Logout
»») /
(
»»/ 0
LogoutInputModel
»»0 @
model
»»A F
)
»»F G
{
…… 	
var
ÀÀ 
vm
ÀÀ 
=
ÀÀ 
await
ÀÀ *
BuildLoggedOutViewModelAsync
ÀÀ 7
(
ÀÀ7 8
model
ÀÀ8 =
.
ÀÀ= >
LogoutId
ÀÀ> F
)
ÀÀF G
;
ÀÀG H
if
ÕÕ 
(
ÕÕ 
User
ÕÕ 
?
ÕÕ 
.
ÕÕ 
Identity
ÕÕ 
.
ÕÕ 
IsAuthenticated
ÕÕ .
==
ÕÕ/ 1
true
ÕÕ2 6
)
ÕÕ6 7
{
ŒŒ 
await
–– 
HttpContext
–– !
.
––! "
SignOutAsync
––" .
(
––. /
)
––/ 0
;
––0 1
await
”” 
_events
”” 
.
”” 

RaiseAsync
”” (
(
””( )
new
””) ,$
UserLogoutSuccessEvent
””- C
(
””C D
User
””D H
.
””H I
GetSubjectId
””I U
(
””U V
)
””V W
,
””W X
User
””Y ]
.
””] ^
GetDisplayName
””^ l
(
””l m
)
””m n
)
””n o
)
””o p
;
””p q
}
‘‘ 
if
◊◊ 
(
◊◊ 
vm
◊◊ 
.
◊◊ $
TriggerExternalSignout
◊◊ )
)
◊◊) *
{
ÿÿ 
string
‹‹ 
url
‹‹ 
=
‹‹ 
Url
‹‹  
.
‹‹  !
Action
‹‹! '
(
‹‹' (
$str
‹‹( 0
,
‹‹0 1
new
‹‹2 5
{
‹‹6 7
logoutId
‹‹8 @
=
‹‹A B
vm
‹‹C E
.
‹‹E F
LogoutId
‹‹F N
}
‹‹O P
)
‹‹P Q
;
‹‹Q R
return
ﬂﬂ 
SignOut
ﬂﬂ 
(
ﬂﬂ 
new
ﬂﬂ "&
AuthenticationProperties
ﬂﬂ# ;
{
ﬂﬂ< =
RedirectUri
ﬂﬂ> I
=
ﬂﬂJ K
url
ﬂﬂL O
}
ﬂﬂP Q
,
ﬂﬂQ R
vm
ﬂﬂS U
.
ﬂﬂU V*
ExternalAuthenticationScheme
ﬂﬂV r
)
ﬂﬂr s
;
ﬂﬂs t
}
‡‡ 
return
‚‚ 
View
‚‚ 
(
‚‚ 
$str
‚‚ #
,
‚‚# $
vm
‚‚% '
)
‚‚' (
;
‚‚( )
}
„„ 	
[
ÂÂ 	
HttpGet
ÂÂ	 
]
ÂÂ 
public
ÊÊ 
IActionResult
ÊÊ 
AccessDenied
ÊÊ )
(
ÊÊ) *
)
ÊÊ* +
{
ÁÁ 	
return
ËË 
View
ËË 
(
ËË 
)
ËË 
;
ËË 
}
ÈÈ 	
private
ÔÔ 
async
ÔÔ 
Task
ÔÔ 
<
ÔÔ 
LoginViewModel
ÔÔ )
>
ÔÔ) *&
BuildLoginViewModelAsync
ÔÔ+ C
(
ÔÔC D
string
ÔÔD J
	returnUrl
ÔÔK T
)
ÔÔT U
{
 	
var
ÒÒ 
context
ÒÒ 
=
ÒÒ 
await
ÒÒ 
_interaction
ÒÒ  ,
.
ÒÒ, -*
GetAuthorizationContextAsync
ÒÒ- I
(
ÒÒI J
	returnUrl
ÒÒJ S
)
ÒÒS T
;
ÒÒT U
if
ÚÚ 
(
ÚÚ 
context
ÚÚ 
?
ÚÚ 
.
ÚÚ 
IdP
ÚÚ 
!=
ÚÚ 
null
ÚÚ  $
&&
ÚÚ% '
await
ÚÚ( -
_schemeProvider
ÚÚ. =
.
ÚÚ= >
GetSchemeAsync
ÚÚ> L
(
ÚÚL M
context
ÚÚM T
.
ÚÚT U
IdP
ÚÚU X
)
ÚÚX Y
!=
ÚÚZ \
null
ÚÚ] a
)
ÚÚa b
{
ÛÛ 
var
ÙÙ 
local
ÙÙ 
=
ÙÙ 
context
ÙÙ #
.
ÙÙ# $
IdP
ÙÙ$ '
==
ÙÙ( *
IdentityServer4
ÙÙ+ :
.
ÙÙ: ;%
IdentityServerConstants
ÙÙ; R
.
ÙÙR S#
LocalIdentityProvider
ÙÙS h
;
ÙÙh i
var
˜˜ 
vm
˜˜ 
=
˜˜ 
new
˜˜ 
LoginViewModel
˜˜ +
{
¯¯ 
EnableLocalLogin
˘˘ $
=
˘˘% &
local
˘˘' ,
,
˘˘, -
	ReturnUrl
˙˙ 
=
˙˙ 
	returnUrl
˙˙  )
,
˙˙) *
Username
˚˚ 
=
˚˚ 
context
˚˚ &
?
˚˚& '
.
˚˚' (
	LoginHint
˚˚( 1
,
˚˚1 2
}
¸¸ 
;
¸¸ 
if
˛˛ 
(
˛˛ 
!
˛˛ 
local
˛˛ 
)
˛˛ 
{
ˇˇ 
vm
ÄÄ 
.
ÄÄ 
ExternalProviders
ÄÄ (
=
ÄÄ) *
new
ÄÄ+ .
[
ÄÄ. /
]
ÄÄ/ 0
{
ÄÄ1 2
new
ÄÄ3 6
ExternalProvider
ÄÄ7 G
{
ÄÄH I"
AuthenticationScheme
ÄÄJ ^
=
ÄÄ_ `
context
ÄÄa h
.
ÄÄh i
IdP
ÄÄi l
}
ÄÄm n
}
ÄÄo p
;
ÄÄp q
}
ÅÅ 
return
ÉÉ 
vm
ÉÉ 
;
ÉÉ 
}
ÑÑ 
var
ÜÜ 
schemes
ÜÜ 
=
ÜÜ 
await
ÜÜ 
_schemeProvider
ÜÜ  /
.
ÜÜ/ 0 
GetAllSchemesAsync
ÜÜ0 B
(
ÜÜB C
)
ÜÜC D
;
ÜÜD E
var
àà 
	providers
àà 
=
àà 
schemes
àà #
.
ââ 
Where
ââ 
(
ââ 
x
ââ 
=>
ââ 
x
ââ 
.
ââ 
DisplayName
ââ )
!=
ââ* ,
null
ââ- 1
)
ââ1 2
.
ää 
Select
ää 
(
ää 
x
ää 
=>
ää 
new
ää  
ExternalProvider
ää! 1
{
ãã 
DisplayName
åå 
=
åå  !
x
åå" #
.
åå# $
DisplayName
åå$ /
??
åå0 2
x
åå3 4
.
åå4 5
Name
åå5 9
,
åå9 :"
AuthenticationScheme
çç (
=
çç) *
x
çç+ ,
.
çç, -
Name
çç- 1
}
éé 
)
éé 
.
éé 
ToList
éé 
(
éé 
)
éé 
;
éé 
var
êê 

allowLocal
êê 
=
êê 
true
êê !
;
êê! "
if
ëë 
(
ëë 
context
ëë 
?
ëë 
.
ëë 
Client
ëë 
.
ëë  
ClientId
ëë  (
!=
ëë) +
null
ëë, 0
)
ëë0 1
{
íí 
var
ìì 
client
ìì 
=
ìì 
await
ìì "
_clientStore
ìì# /
.
ìì/ 0(
FindEnabledClientByIdAsync
ìì0 J
(
ììJ K
context
ììK R
.
ììR S
Client
ììS Y
.
ììY Z
ClientId
ììZ b
)
ììb c
;
ììc d
if
îî 
(
îî 
client
îî 
!=
îî 
null
îî "
)
îî" #
{
ïï 

allowLocal
ññ 
=
ññ  
client
ññ! '
.
ññ' (
EnableLocalLogin
ññ( 8
;
ññ8 9
if
òò 
(
òò 
client
òò 
.
òò *
IdentityProviderRestrictions
òò ;
!=
òò< >
null
òò? C
&&
òòD F
client
òòG M
.
òòM N*
IdentityProviderRestrictions
òòN j
.
òòj k
Any
òòk n
(
òòn o
)
òòo p
)
òòp q
{
ôô 
	providers
öö !
=
öö" #
	providers
öö$ -
.
öö- .
Where
öö. 3
(
öö3 4
provider
öö4 <
=>
öö= ?
client
öö@ F
.
ööF G*
IdentityProviderRestrictions
ööG c
.
ööc d
Contains
ööd l
(
ööl m
provider
ööm u
.
ööu v#
AuthenticationSchemeööv ä
)ööä ã
)ööã å
.ööå ç
ToListööç ì
(ööì î
)ööî ï
;ööï ñ
}
õõ 
}
úú 
}
ùù 
return
üü 
new
üü 
LoginViewModel
üü %
{
††  
AllowRememberLogin
°° "
=
°°# $
AccountOptions
°°% 3
.
°°3 4 
AllowRememberLogin
°°4 F
,
°°F G
EnableLocalLogin
¢¢  
=
¢¢! "

allowLocal
¢¢# -
&&
¢¢. 0
AccountOptions
¢¢1 ?
.
¢¢? @
AllowLocalLogin
¢¢@ O
,
¢¢O P
	ReturnUrl
££ 
=
££ 
	returnUrl
££ %
,
££% &
Username
§§ 
=
§§ 
context
§§ "
?
§§" #
.
§§# $
	LoginHint
§§$ -
,
§§- .
ExternalProviders
•• !
=
••" #
	providers
••$ -
.
••- .
ToArray
••. 5
(
••5 6
)
••6 7
}
¶¶ 
;
¶¶ 
}
ßß 	
private
©© 
async
©© 
Task
©© 
<
©© 
LoginViewModel
©© )
>
©©) *&
BuildLoginViewModelAsync
©©+ C
(
©©C D
LoginInputModel
©©D S
model
©©T Y
)
©©Y Z
{
™™ 	
var
´´ 
vm
´´ 
=
´´ 
await
´´ &
BuildLoginViewModelAsync
´´ 3
(
´´3 4
model
´´4 9
.
´´9 :
	ReturnUrl
´´: C
)
´´C D
;
´´D E
vm
¨¨ 
.
¨¨ 
Username
¨¨ 
=
¨¨ 
model
¨¨ 
.
¨¨  
Username
¨¨  (
;
¨¨( )
vm
≠≠ 
.
≠≠ 
RememberLogin
≠≠ 
=
≠≠ 
model
≠≠ $
.
≠≠$ %
RememberLogin
≠≠% 2
;
≠≠2 3
return
ÆÆ 
vm
ÆÆ 
;
ÆÆ 
}
ØØ 	
private
±± 
async
±± 
Task
±± 
<
±± 
LogoutViewModel
±± *
>
±±* +'
BuildLogoutViewModelAsync
±±, E
(
±±E F
string
±±F L
logoutId
±±M U
)
±±U V
{
≤≤ 	
var
≥≥ 
vm
≥≥ 
=
≥≥ 
new
≥≥ 
LogoutViewModel
≥≥ (
{
≥≥) *
LogoutId
≥≥+ 3
=
≥≥4 5
logoutId
≥≥6 >
,
≥≥> ?
ShowLogoutPrompt
≥≥@ P
=
≥≥Q R
AccountOptions
≥≥S a
.
≥≥a b
ShowLogoutPrompt
≥≥b r
}
≥≥s t
;
≥≥t u
if
µµ 
(
µµ 
User
µµ 
?
µµ 
.
µµ 
Identity
µµ 
.
µµ 
IsAuthenticated
µµ .
!=
µµ/ 1
true
µµ2 6
)
µµ6 7
{
∂∂ 
vm
∏∏ 
.
∏∏ 
ShowLogoutPrompt
∏∏ #
=
∏∏$ %
false
∏∏& +
;
∏∏+ ,
return
ππ 
vm
ππ 
;
ππ 
}
∫∫ 
var
ºº 
context
ºº 
=
ºº 
await
ºº 
_interaction
ºº  ,
.
ºº, -#
GetLogoutContextAsync
ºº- B
(
ººB C
logoutId
ººC K
)
ººK L
;
ººL M
if
ΩΩ 
(
ΩΩ 
context
ΩΩ 
?
ΩΩ 
.
ΩΩ 
ShowSignoutPrompt
ΩΩ *
==
ΩΩ+ -
false
ΩΩ. 3
)
ΩΩ3 4
{
ææ 
vm
¿¿ 
.
¿¿ 
ShowLogoutPrompt
¿¿ #
=
¿¿$ %
false
¿¿& +
;
¿¿+ ,
return
¡¡ 
vm
¡¡ 
;
¡¡ 
}
¬¬ 
return
∆∆ 
vm
∆∆ 
;
∆∆ 
}
«« 	
private
…… 
async
…… 
Task
…… 
<
……  
LoggedOutViewModel
…… -
>
……- .*
BuildLoggedOutViewModelAsync
……/ K
(
……K L
string
……L R
logoutId
……S [
)
……[ \
{
   	
var
ÃÃ 
logout
ÃÃ 
=
ÃÃ 
await
ÃÃ 
_interaction
ÃÃ +
.
ÃÃ+ ,#
GetLogoutContextAsync
ÃÃ, A
(
ÃÃA B
logoutId
ÃÃB J
)
ÃÃJ K
;
ÃÃK L
var
ŒŒ 
vm
ŒŒ 
=
ŒŒ 
new
ŒŒ  
LoggedOutViewModel
ŒŒ +
{
œœ +
AutomaticRedirectAfterSignOut
–– -
=
––. /
AccountOptions
––0 >
.
––> ?+
AutomaticRedirectAfterSignOut
––? \
,
––\ ]#
PostLogoutRedirectUri
—— %
=
——& '
logout
——( .
?
——. /
.
——/ 0#
PostLogoutRedirectUri
——0 E
,
——E F

ClientName
““ 
=
““ 
string
““ #
.
““# $
IsNullOrEmpty
““$ 1
(
““1 2
logout
““2 8
?
““8 9
.
““9 :

ClientName
““: D
)
““D E
?
““F G
logout
““H N
?
““N O
.
““O P
ClientId
““P X
:
““Y Z
logout
““[ a
?
““a b
.
““b c

ClientName
““c m
,
““m n
SignOutIframeUrl
””  
=
””! "
logout
””# )
?
””) *
.
””* +
SignOutIFrameUrl
””+ ;
,
””; <
LogoutId
‘‘ 
=
‘‘ 
logoutId
‘‘ #
}
’’ 
;
’’ 
if
◊◊ 
(
◊◊ 
User
◊◊ 
?
◊◊ 
.
◊◊ 
Identity
◊◊ 
.
◊◊ 
IsAuthenticated
◊◊ .
==
◊◊/ 1
true
◊◊2 6
)
◊◊6 7
{
ÿÿ 
var
ŸŸ 
idp
ŸŸ 
=
ŸŸ 
User
ŸŸ 
.
ŸŸ 
	FindFirst
ŸŸ (
(
ŸŸ( )
JwtClaimTypes
ŸŸ) 6
.
ŸŸ6 7
IdentityProvider
ŸŸ7 G
)
ŸŸG H
?
ŸŸH I
.
ŸŸI J
Value
ŸŸJ O
;
ŸŸO P
if
⁄⁄ 
(
⁄⁄ 
idp
⁄⁄ 
!=
⁄⁄ 
null
⁄⁄ 
&&
⁄⁄  "
idp
⁄⁄# &
!=
⁄⁄' )
IdentityServer4
⁄⁄* 9
.
⁄⁄9 :%
IdentityServerConstants
⁄⁄: Q
.
⁄⁄Q R#
LocalIdentityProvider
⁄⁄R g
)
⁄⁄g h
{
€€ 
var
‹‹ %
providerSupportsSignout
‹‹ /
=
‹‹0 1
await
‹‹2 7
HttpContext
‹‹8 C
.
‹‹C D+
GetSchemeSupportsSignOutAsync
‹‹D a
(
‹‹a b
idp
‹‹b e
)
‹‹e f
;
‹‹f g
if
›› 
(
›› %
providerSupportsSignout
›› /
)
››/ 0
{
ﬁﬁ 
if
ﬂﬂ 
(
ﬂﬂ 
vm
ﬂﬂ 
.
ﬂﬂ 
LogoutId
ﬂﬂ '
==
ﬂﬂ( *
null
ﬂﬂ+ /
)
ﬂﬂ/ 0
{
‡‡ 
vm
‰‰ 
.
‰‰ 
LogoutId
‰‰ '
=
‰‰( )
await
‰‰* /
_interaction
‰‰0 <
.
‰‰< =&
CreateLogoutContextAsync
‰‰= U
(
‰‰U V
)
‰‰V W
;
‰‰W X
}
ÂÂ 
vm
ÁÁ 
.
ÁÁ *
ExternalAuthenticationScheme
ÁÁ 7
=
ÁÁ8 9
idp
ÁÁ: =
;
ÁÁ= >
}
ËË 
}
ÈÈ 
}
ÍÍ 
return
ÏÏ 
vm
ÏÏ 
;
ÏÏ 
}
ÌÌ 	
}
ÓÓ 
}ÔÔ ‡

†C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Account\AccountOptions.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public		 

static		 
class		 
AccountOptions		 &
{

 
public 
static 
bool 
AllowLocalLogin *
=+ ,
true- 1
;1 2
public 
static 
bool 
AllowRememberLogin -
=. /
true0 4
;4 5
public 
static 
TimeSpan #
RememberMeLoginDuration 6
=7 8
TimeSpan9 A
.A B
FromDaysB J
(J K
$numK M
)M N
;N O
public 
static 
bool 
ShowLogoutPrompt +
=, -
true. 2
;2 3
public 
static 
bool )
AutomaticRedirectAfterSignOut 8
=9 :
false; @
;@ A
public 
static 
string *
InvalidCredentialsErrorMessage ;
=< =
$str> \
;\ ]
} 
} öu
§C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Account\ExternalController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[ 
SecurityHeaders 
] 
[ 
AllowAnonymous 
] 
public 

class 
ExternalController #
:$ %

Controller& 0
{ 
private 
readonly 
TestUserStore &
_users' -
;- .
private 
readonly -
!IIdentityServerInteractionService :
_interaction; G
;G H
private 
readonly 
IClientStore %
_clientStore& 2
;2 3
private 
readonly 
ILogger  
<  !
ExternalController! 3
>3 4
_logger5 <
;< =
private 
readonly 
IEventService &
_events' .
;. /
public 
ExternalController !
(! "-
!IIdentityServerInteractionService -
interaction. 9
,9 :
IClientStore   
clientStore   $
,  $ %
IEventService!! 
events!!  
,!!  !
ILogger"" 
<"" 
ExternalController"" &
>""& '
logger""( .
,"". /
TestUserStore## 
users## 
=##  !
null##" &
)##& '
{$$ 	
_users'' 
='' 
users'' 
??'' 
new'' !
TestUserStore''" /
(''/ 0
	TestUsers''0 9
.''9 :
Users'': ?
)''? @
;''@ A
_interaction)) 
=)) 
interaction)) &
;))& '
_clientStore** 
=** 
clientStore** &
;**& '
_logger++ 
=++ 
logger++ 
;++ 
_events,, 
=,, 
events,, 
;,, 
}-- 	
[22 	
HttpGet22	 
]22 
public33 
IActionResult33 
	Challenge33 &
(33& '
string33' -
scheme33. 4
,334 5
string336 <
	returnUrl33= F
)33F G
{44 	
if55 
(55 
string55 
.55 
IsNullOrEmpty55 $
(55$ %
	returnUrl55% .
)55. /
)55/ 0
	returnUrl551 :
=55; <
$str55= A
;55A B
if88 
(88 
Url88 
.88 

IsLocalUrl88 
(88 
	returnUrl88 (
)88( )
==88* ,
false88- 2
&&883 5
_interaction886 B
.88B C
IsValidReturnUrl88C S
(88S T
	returnUrl88T ]
)88] ^
==88_ a
false88b g
)88g h
{99 
throw;; 
new;; 
ArgumentException;; +
(;;+ ,
$str;;, @
);;@ A
;;;A B
}<< 
var?? 
props?? 
=?? 
new?? $
AuthenticationProperties?? 4
{@@ 
RedirectUriAA 
=AA 
UrlAA !
.AA! "
ActionAA" (
(AA( )
nameofAA) /
(AA/ 0
CallbackAA0 8
)AA8 9
)AA9 :
,AA: ;
ItemsBB 
=BB 
{CC 
{DD 
$strDD !
,DD! "
	returnUrlDD# ,
}DD- .
,DD. /
{EE 
$strEE 
,EE 
schemeEE  &
}EE' (
,EE( )
}FF 
}GG 
;GG 
returnII 
	ChallengeII 
(II 
propsII "
,II" #
schemeII$ *
)II* +
;II+ ,
}KK 	
[PP 	
HttpGetPP	 
]PP 
publicQQ 
asyncQQ 
TaskQQ 
<QQ 
IActionResultQQ '
>QQ' (
CallbackQQ) 1
(QQ1 2
)QQ2 3
{RR 	
varTT 
resultTT 
=TT 
awaitTT 
HttpContextTT *
.TT* +
AuthenticateAsyncTT+ <
(TT< =#
IdentityServerConstantsTT= T
.TTT U.
"ExternalCookieAuthenticationSchemeTTU w
)TTw x
;TTx y
ifUU 
(UU 
resultUU 
?UU 
.UU 
	SucceededUU !
!=UU" $
trueUU% )
)UU) *
{VV 
throwWW 
newWW 
	ExceptionWW #
(WW# $
$strWW$ C
)WWC D
;WWD E
}XX 
ifZZ 
(ZZ 
_loggerZZ 
.ZZ 
	IsEnabledZZ !
(ZZ! "
LogLevelZZ" *
.ZZ* +
DebugZZ+ 0
)ZZ0 1
)ZZ1 2
{[[ 
var\\ 
externalClaims\\ "
=\\# $
result\\% +
.\\+ ,
	Principal\\, 5
.\\5 6
Claims\\6 <
.\\< =
Select\\= C
(\\C D
c\\D E
=>\\F H
$"\\I K
{\\K L
c\\L M
.\\M N
Type\\N R
}\\R S
$str\\S U
{\\U V
c\\V W
.\\W X
Value\\X ]
}\\] ^
"\\^ _
)\\_ `
;\\` a
_logger]] 
.]] 
LogDebug]]  
(]]  !
$str]]! =
,]]= >
externalClaims]]? M
)]]M N
;]]N O
}^^ 
varaa 
(aa 
useraa 
,aa 
provideraa 
,aa  
providerUserIdaa! /
,aa/ 0
claimsaa1 7
)aa7 8
=aa9 :(
FindUserFromExternalProvideraa; W
(aaW X
resultaaX ^
)aa^ _
;aa_ `
ifbb 
(bb 
userbb 
==bb 
nullbb 
)bb 
{cc 
usergg 
=gg 
AutoProvisionUsergg (
(gg( )
providergg) 1
,gg1 2
providerUserIdgg3 A
,ggA B
claimsggC I
)ggI J
;ggJ K
}hh 
varmm !
additionalLocalClaimsmm %
=mm& '
newmm( +
Listmm, 0
<mm0 1
Claimmm1 6
>mm6 7
(mm7 8
)mm8 9
;mm9 :
varnn 
localSignInPropsnn  
=nn! "
newnn# &$
AuthenticationPropertiesnn' ?
(nn? @
)nn@ A
;nnA B 
ProcessLoginCallbackoo  
(oo  !
resultoo! '
,oo' (!
additionalLocalClaimsoo) >
,oo> ?
localSignInPropsoo@ P
)ooP Q
;ooQ R
varrr 
isuserrr 
=rr 
newrr 
IdentityServerUserrr /
(rr/ 0
userrr0 4
.rr4 5
	SubjectIdrr5 >
)rr> ?
{ss 
DisplayNamett 
=tt 
usertt "
.tt" #
Usernamett# +
,tt+ ,
IdentityProvideruu  
=uu! "
provideruu# +
,uu+ ,
AdditionalClaimsvv  
=vv! "!
additionalLocalClaimsvv# 8
}ww 
;ww 
awaityy 
HttpContextyy 
.yy 
SignInAsyncyy )
(yy) *
isuseryy* 0
,yy0 1
localSignInPropsyy2 B
)yyB C
;yyC D
await|| 
HttpContext|| 
.|| 
SignOutAsync|| *
(||* +#
IdentityServerConstants||+ B
.||B C.
"ExternalCookieAuthenticationScheme||C e
)||e f
;||f g
var 
	returnUrl 
= 
result "
." #

Properties# -
.- .
Items. 3
[3 4
$str4 ?
]? @
??A C
$strD H
;H I
var
ÇÇ 
context
ÇÇ 
=
ÇÇ 
await
ÇÇ 
_interaction
ÇÇ  ,
.
ÇÇ, -*
GetAuthorizationContextAsync
ÇÇ- I
(
ÇÇI J
	returnUrl
ÇÇJ S
)
ÇÇS T
;
ÇÇT U
await
ÉÉ 
_events
ÉÉ 
.
ÉÉ 

RaiseAsync
ÉÉ $
(
ÉÉ$ %
new
ÉÉ% (#
UserLoginSuccessEvent
ÉÉ) >
(
ÉÉ> ?
provider
ÉÉ? G
,
ÉÉG H
providerUserId
ÉÉI W
,
ÉÉW X
user
ÉÉY ]
.
ÉÉ] ^
	SubjectId
ÉÉ^ g
,
ÉÉg h
user
ÉÉi m
.
ÉÉm n
Username
ÉÉn v
,
ÉÉv w
true
ÉÉx |
,
ÉÉ| }
contextÉÉ~ Ö
?ÉÉÖ Ü
.ÉÉÜ á
ClientÉÉá ç
.ÉÉç é
ClientIdÉÉé ñ
)ÉÉñ ó
)ÉÉó ò
;ÉÉò ô
if
ÖÖ 
(
ÖÖ 
context
ÖÖ 
?
ÖÖ 
.
ÖÖ 
IsNativeClient
ÖÖ '
(
ÖÖ' (
)
ÖÖ( )
==
ÖÖ* ,
true
ÖÖ- 1
)
ÖÖ1 2
{
ÜÜ 
return
ââ 
this
ââ 
.
ââ 
LoadingPage
ââ '
(
ââ' (
$str
ââ( 2
,
ââ2 3
	returnUrl
ââ4 =
)
ââ= >
;
ââ> ?
}
ää 
return
åå 
Redirect
åå 
(
åå 
	returnUrl
åå %
)
åå% &
;
åå& '
}
çç 	
private
èè 
(
èè 
TestUser
èè 
user
èè 
,
èè 
string
èè  &
provider
èè' /
,
èè/ 0
string
èè1 7
providerUserId
èè8 F
,
èèF G
IEnumerable
èèH S
<
èèS T
Claim
èèT Y
>
èèY Z
claims
èè[ a
)
èèa b*
FindUserFromExternalProvider
èèc 
(èè Ä"
AuthenticateResultèèÄ í
resultèèì ô
)èèô ö
{
êê 	
var
ëë 
externalUser
ëë 
=
ëë 
result
ëë %
.
ëë% &
	Principal
ëë& /
;
ëë/ 0
var
ññ 
userIdClaim
ññ 
=
ññ 
externalUser
ññ *
.
ññ* +
	FindFirst
ññ+ 4
(
ññ4 5
JwtClaimTypes
ññ5 B
.
ññB C
Subject
ññC J
)
ññJ K
??
ññL N
externalUser
óó *
.
óó* +
	FindFirst
óó+ 4
(
óó4 5

ClaimTypes
óó5 ?
.
óó? @
NameIdentifier
óó@ N
)
óóN O
??
óóP R
throw
òò #
new
òò$ '
	Exception
òò( 1
(
òò1 2
$str
òò2 B
)
òòB C
;
òòC D
var
õõ 
claims
õõ 
=
õõ 
externalUser
õõ %
.
õõ% &
Claims
õõ& ,
.
õõ, -
ToList
õõ- 3
(
õõ3 4
)
õõ4 5
;
õõ5 6
claims
úú 
.
úú 
Remove
úú 
(
úú 
userIdClaim
úú %
)
úú% &
;
úú& '
var
ûû 
provider
ûû 
=
ûû 
result
ûû !
.
ûû! "

Properties
ûû" ,
.
ûû, -
Items
ûû- 2
[
ûû2 3
$str
ûû3 ;
]
ûû; <
;
ûû< =
var
üü 
providerUserId
üü 
=
üü  
userIdClaim
üü! ,
.
üü, -
Value
üü- 2
;
üü2 3
var
¢¢ 
user
¢¢ 
=
¢¢ 
_users
¢¢ 
.
¢¢ $
FindByExternalProvider
¢¢ 4
(
¢¢4 5
provider
¢¢5 =
,
¢¢= >
providerUserId
¢¢? M
)
¢¢M N
;
¢¢N O
return
§§ 
(
§§ 
user
§§ 
,
§§ 
provider
§§ "
,
§§" #
providerUserId
§§$ 2
,
§§2 3
claims
§§4 :
)
§§: ;
;
§§; <
}
•• 	
private
ßß 
TestUser
ßß 
AutoProvisionUser
ßß *
(
ßß* +
string
ßß+ 1
provider
ßß2 :
,
ßß: ;
string
ßß< B
providerUserId
ßßC Q
,
ßßQ R
IEnumerable
ßßS ^
<
ßß^ _
Claim
ßß_ d
>
ßßd e
claims
ßßf l
)
ßßl m
{
®® 	
var
©© 
user
©© 
=
©© 
_users
©© 
.
©© 
AutoProvisionUser
©© /
(
©©/ 0
provider
©©0 8
,
©©8 9
providerUserId
©©: H
,
©©H I
claims
©©J P
.
©©P Q
ToList
©©Q W
(
©©W X
)
©©X Y
)
©©Y Z
;
©©Z [
return
™™ 
user
™™ 
;
™™ 
}
´´ 	
private
ØØ 
void
ØØ "
ProcessLoginCallback
ØØ )
(
ØØ) * 
AuthenticateResult
ØØ* <
externalResult
ØØ= K
,
ØØK L
List
ØØM Q
<
ØØQ R
Claim
ØØR W
>
ØØW X
localClaims
ØØY d
,
ØØd e&
AuthenticationProperties
ØØf ~
localSignInPropsØØ è
)ØØè ê
{
∞∞ 	
var
≥≥ 
sid
≥≥ 
=
≥≥ 
externalResult
≥≥ $
.
≥≥$ %
	Principal
≥≥% .
.
≥≥. /
Claims
≥≥/ 5
.
≥≥5 6
FirstOrDefault
≥≥6 D
(
≥≥D E
x
≥≥E F
=>
≥≥G I
x
≥≥J K
.
≥≥K L
Type
≥≥L P
==
≥≥Q S
JwtClaimTypes
≥≥T a
.
≥≥a b
	SessionId
≥≥b k
)
≥≥k l
;
≥≥l m
if
¥¥ 
(
¥¥ 
sid
¥¥ 
!=
¥¥ 
null
¥¥ 
)
¥¥ 
{
µµ 
localClaims
∂∂ 
.
∂∂ 
Add
∂∂ 
(
∂∂  
new
∂∂  #
Claim
∂∂$ )
(
∂∂) *
JwtClaimTypes
∂∂* 7
.
∂∂7 8
	SessionId
∂∂8 A
,
∂∂A B
sid
∂∂C F
.
∂∂F G
Value
∂∂G L
)
∂∂L M
)
∂∂M N
;
∂∂N O
}
∑∑ 
var
∫∫ 
idToken
∫∫ 
=
∫∫ 
externalResult
∫∫ (
.
∫∫( )

Properties
∫∫) 3
.
∫∫3 4
GetTokenValue
∫∫4 A
(
∫∫A B
$str
∫∫B L
)
∫∫L M
;
∫∫M N
if
ªª 
(
ªª 
idToken
ªª 
!=
ªª 
null
ªª 
)
ªª  
{
ºº 
localSignInProps
ΩΩ  
.
ΩΩ  !
StoreTokens
ΩΩ! ,
(
ΩΩ, -
new
ΩΩ- 0
[
ΩΩ0 1
]
ΩΩ1 2
{
ΩΩ3 4
new
ΩΩ5 8!
AuthenticationToken
ΩΩ9 L
{
ΩΩM N
Name
ΩΩO S
=
ΩΩT U
$str
ΩΩV `
,
ΩΩ` a
Value
ΩΩb g
=
ΩΩh i
idToken
ΩΩj q
}
ΩΩr s
}
ΩΩt u
)
ΩΩu v
;
ΩΩv w
}
ææ 
}
øø 	
}
¿¿ 
}¡¡ ‰
¢C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Account\ExternalProvider.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
ExternalProvider !
{ 
public		 
string		 
DisplayName		 !
{		" #
get		$ '
;		' (
set		) ,
;		, -
}		. /
public

 
string

  
AuthenticationScheme

 *
{

+ ,
get

- 0
;

0 1
set

2 5
;

5 6
}

7 8
} 
} º
§C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Account\LoggedOutViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
LoggedOutViewModel #
{ 
public		 
string		 !
PostLogoutRedirectUri		 +
{		, -
get		. 1
;		1 2
set		3 6
;		6 7
}		8 9
public

 
string

 

ClientName

  
{

! "
get

# &
;

& '
set

( +
;

+ ,
}

- .
public 
string 
SignOutIframeUrl &
{' (
get) ,
;, -
set. 1
;1 2
}3 4
public 
bool )
AutomaticRedirectAfterSignOut 1
{2 3
get4 7
;7 8
set9 <
;< =
}> ?
public 
string 
LogoutId 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
bool "
TriggerExternalSignout *
=>+ -(
ExternalAuthenticationScheme. J
!=K M
nullN R
;R S
public 
string (
ExternalAuthenticationScheme 2
{3 4
get5 8
;8 9
set: =
;= >
}? @
} 
} ˜
°C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Account\LoginInputModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public		 

class		 
LoginInputModel		  
{

 
[ 	
Required	 
] 
public 
string 
Username 
{  
get! $
;$ %
set& )
;) *
}+ ,
[ 	
Required	 
] 
public 
string 
Password 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
bool 
RememberLogin !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 
string 
	ReturnUrl 
{  !
get" %
;% &
set' *
;* +
}, -
} 
} °
†C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Account\LoginViewModel.cs
	namespace		 	
IdentityServerHost		
 
.		 

Quickstart		 '
.		' (
UI		( *
{

 
public 

class 
LoginViewModel 
:  !
LoginInputModel" 1
{ 
public 
bool 
AllowRememberLogin &
{' (
get) ,
;, -
set. 1
;1 2
}3 4
=5 6
true7 ;
;; <
public 
bool 
EnableLocalLogin $
{% &
get' *
;* +
set, /
;/ 0
}1 2
=3 4
true5 9
;9 :
public 
IEnumerable 
< 
ExternalProvider +
>+ ,
ExternalProviders- >
{? @
getA D
;D E
setF I
;I J
}K L
=M N

EnumerableO Y
.Y Z
EmptyZ _
<_ `
ExternalProvider` p
>p q
(q r
)r s
;s t
public 
IEnumerable 
< 
ExternalProvider +
>+ ,$
VisibleExternalProviders- E
=>F H
ExternalProvidersI Z
.Z [
Where[ `
(` a
xa b
=>c e
!f g
Stringg m
.m n
IsNullOrWhiteSpace	n Ä
(
Ä Å
x
Å Ç
.
Ç É
DisplayName
É é
)
é è
)
è ê
;
ê ë
public 
bool 
IsExternalLoginOnly '
=>( *
EnableLocalLogin+ ;
==< >
false? D
&&E G
ExternalProvidersH Y
?Y Z
.Z [
Count[ `
(` a
)a b
==c e
$numf g
;g h
public 
string 
ExternalLoginScheme )
=>* ,
IsExternalLoginOnly- @
?A B
ExternalProvidersC T
?T U
.U V
SingleOrDefaultV e
(e f
)f g
?g h
.h i 
AuthenticationSchemei }
:~ 
null
Ä Ñ
;
Ñ Ö
} 
} π
¢C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Account\LogoutInputModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
LogoutInputModel !
{ 
public		 
string		 
LogoutId		 
{		  
get		! $
;		$ %
set		& )
;		) *
}		+ ,
}

 
} ö
°C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Account\LogoutViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
LogoutViewModel  
:! "
LogoutInputModel# 3
{ 
public		 
bool		 
ShowLogoutPrompt		 $
{		% &
get		' *
;		* +
set		, /
;		/ 0
}		1 2
=		3 4
true		5 9
;		9 :
}

 
} æ
£C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Account\RedirectViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
RedirectViewModel "
{		 
public

 
string

 
RedirectUrl

 !
{

" #
get

$ '
;

' (
set

) ,
;

, -
}

. /
} 
} Å™
£C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Consent\ConsentController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[ 
SecurityHeaders 
] 
[ 
	Authorize 
] 
public 

class 
ConsentController "
:# $

Controller% /
{ 
private 
readonly -
!IIdentityServerInteractionService :
_interaction; G
;G H
private 
readonly 
IEventService &
_events' .
;. /
private 
readonly 
ILogger  
<  !
ConsentController! 2
>2 3
_logger4 ;
;; <
public 
ConsentController  
(  !-
!IIdentityServerInteractionService   -
interaction  . 9
,  9 :
IEventService!! 
events!!  
,!!  !
ILogger"" 
<"" 
ConsentController"" %
>""% &
logger""' -
)""- .
{## 	
_interaction$$ 
=$$ 
interaction$$ &
;$$& '
_events%% 
=%% 
events%% 
;%% 
_logger&& 
=&& 
logger&& 
;&& 
}'' 	
[.. 	
HttpGet..	 
].. 
public// 
async// 
Task// 
<// 
IActionResult// '
>//' (
Index//) .
(//. /
string/// 5
	returnUrl//6 ?
)//? @
{00 	
var11 
vm11 
=11 
await11 
BuildViewModelAsync11 .
(11. /
	returnUrl11/ 8
)118 9
;119 :
if22 
(22 
vm22 
!=22 
null22 
)22 
{33 
return44 
View44 
(44 
$str44 #
,44# $
vm44% '
)44' (
;44( )
}55 
return77 
View77 
(77 
$str77 
)77  
;77  !
}88 	
[== 	
HttpPost==	 
]== 
[>> 	$
ValidateAntiForgeryToken>>	 !
]>>! "
public?? 
async?? 
Task?? 
<?? 
IActionResult?? '
>??' (
Index??) .
(??. /
ConsentInputModel??/ @
model??A F
)??F G
{@@ 	
varAA 
resultAA 
=AA 
awaitAA 
ProcessConsentAA -
(AA- .
modelAA. 3
)AA3 4
;AA4 5
ifCC 
(CC 
resultCC 
.CC 

IsRedirectCC !
)CC! "
{DD 
varEE 
contextEE 
=EE 
awaitEE #
_interactionEE$ 0
.EE0 1(
GetAuthorizationContextAsyncEE1 M
(EEM N
modelEEN S
.EES T
	ReturnUrlEET ]
)EE] ^
;EE^ _
ifFF 
(FF 
contextFF 
?FF 
.FF 
IsNativeClientFF +
(FF+ ,
)FF, -
==FF. 0
trueFF1 5
)FF5 6
{GG 
returnJJ 
thisJJ 
.JJ  
LoadingPageJJ  +
(JJ+ ,
$strJJ, 6
,JJ6 7
resultJJ8 >
.JJ> ?
RedirectUriJJ? J
)JJJ K
;JJK L
}KK 
returnMM 
RedirectMM 
(MM  
resultMM  &
.MM& '
RedirectUriMM' 2
)MM2 3
;MM3 4
}NN 
ifPP 
(PP 
resultPP 
.PP 
HasValidationErrorPP )
)PP) *
{QQ 

ModelStateRR 
.RR 
AddModelErrorRR (
(RR( )
stringRR) /
.RR/ 0
EmptyRR0 5
,RR5 6
resultRR7 =
.RR= >
ValidationErrorRR> M
)RRM N
;RRN O
}SS 
ifUU 
(UU 
resultUU 
.UU 
ShowViewUU 
)UU  
{VV 
returnWW 
ViewWW 
(WW 
$strWW #
,WW# $
resultWW% +
.WW+ ,
	ViewModelWW, 5
)WW5 6
;WW6 7
}XX 
returnZZ 
ViewZZ 
(ZZ 
$strZZ 
)ZZ  
;ZZ  !
}[[ 	
private`` 
async`` 
Task`` 
<``  
ProcessConsentResult`` /
>``/ 0
ProcessConsent``1 ?
(``? @
ConsentInputModel``@ Q
model``R W
)``W X
{aa 	
varbb 
resultbb 
=bb 
newbb  
ProcessConsentResultbb 1
(bb1 2
)bb2 3
;bb3 4
varee 
requestee 
=ee 
awaitee 
_interactionee  ,
.ee, -(
GetAuthorizationContextAsyncee- I
(eeI J
modeleeJ O
.eeO P
	ReturnUrleeP Y
)eeY Z
;eeZ [
ifff 
(ff 
requestff 
==ff 
nullff 
)ff  
returnff! '
resultff( .
;ff. /
ConsentResponsehh 
grantedConsenthh *
=hh+ ,
nullhh- 1
;hh1 2
ifkk 
(kk 
modelkk 
?kk 
.kk 
Buttonkk 
==kk  
$strkk! %
)kk% &
{ll 
grantedConsentmm 
=mm  
newmm! $
ConsentResponsemm% 4
{mm5 6
Errormm7 <
=mm= >
AuthorizationErrormm? Q
.mmQ R
AccessDeniedmmR ^
}mm_ `
;mm` a
awaitpp 
_eventspp 
.pp 

RaiseAsyncpp (
(pp( )
newpp) ,
ConsentDeniedEventpp- ?
(pp? @
Userpp@ D
.ppD E
GetSubjectIdppE Q
(ppQ R
)ppR S
,ppS T
requestppU \
.pp\ ]
Clientpp] c
.ppc d
ClientIdppd l
,ppl m
requestppn u
.ppu v
ValidatedResources	ppv à
.
ppà â
RawScopeValues
ppâ ó
)
ppó ò
)
ppò ô
;
ppô ö
}qq 
elsess 
ifss 
(ss 
modelss 
?ss 
.ss 
Buttonss "
==ss# %
$strss& +
)ss+ ,
{tt 
ifvv 
(vv 
modelvv 
.vv 
ScopesConsentedvv )
!=vv* ,
nullvv- 1
&&vv2 4
modelvv5 :
.vv: ;
ScopesConsentedvv; J
.vvJ K
AnyvvK N
(vvN O
)vvO P
)vvP Q
{ww 
varxx 
scopesxx 
=xx  
modelxx! &
.xx& '
ScopesConsentedxx' 6
;xx6 7
ifyy 
(yy 
ConsentOptionsyy &
.yy& '
EnableOfflineAccessyy' :
==yy; =
falseyy> C
)yyC D
{zz 
scopes{{ 
={{  
scopes{{! '
.{{' (
Where{{( -
({{- .
x{{. /
=>{{0 2
x{{3 4
!={{5 7
IdentityServer4{{8 G
.{{G H#
IdentityServerConstants{{H _
.{{_ `
StandardScopes{{` n
.{{n o
OfflineAccess{{o |
){{| }
;{{} ~
}|| 
grantedConsent~~ "
=~~# $
new~~% (
ConsentResponse~~) 8
{ 
RememberConsent
ÄÄ '
=
ÄÄ( )
model
ÄÄ* /
.
ÄÄ/ 0
RememberConsent
ÄÄ0 ?
,
ÄÄ? @#
ScopesValuesConsented
ÅÅ -
=
ÅÅ. /
scopes
ÅÅ0 6
.
ÅÅ6 7
ToArray
ÅÅ7 >
(
ÅÅ> ?
)
ÅÅ? @
,
ÅÅ@ A
Description
ÇÇ #
=
ÇÇ$ %
model
ÇÇ& +
.
ÇÇ+ ,
Description
ÇÇ, 7
}
ÉÉ 
;
ÉÉ 
await
ÜÜ 
_events
ÜÜ !
.
ÜÜ! "

RaiseAsync
ÜÜ" ,
(
ÜÜ, -
new
ÜÜ- 0!
ConsentGrantedEvent
ÜÜ1 D
(
ÜÜD E
User
ÜÜE I
.
ÜÜI J
GetSubjectId
ÜÜJ V
(
ÜÜV W
)
ÜÜW X
,
ÜÜX Y
request
ÜÜZ a
.
ÜÜa b
Client
ÜÜb h
.
ÜÜh i
ClientId
ÜÜi q
,
ÜÜq r
request
ÜÜs z
.
ÜÜz {!
ValidatedResourcesÜÜ{ ç
.ÜÜç é
RawScopeValuesÜÜé ú
,ÜÜú ù
grantedConsentÜÜû ¨
.ÜÜ¨ ≠%
ScopesValuesConsentedÜÜ≠ ¬
,ÜÜ¬ √
grantedConsentÜÜƒ “
.ÜÜ“ ”
RememberConsentÜÜ” ‚
)ÜÜ‚ „
)ÜÜ„ ‰
;ÜÜ‰ Â
}
áá 
else
àà 
{
ââ 
result
ää 
.
ää 
ValidationError
ää *
=
ää+ ,
ConsentOptions
ää- ;
.
ää; <'
MustChooseOneErrorMessage
ää< U
;
ääU V
}
ãã 
}
åå 
else
çç 
{
éé 
result
èè 
.
èè 
ValidationError
èè &
=
èè' (
ConsentOptions
èè) 7
.
èè7 8*
InvalidSelectionErrorMessage
èè8 T
;
èèT U
}
êê 
if
íí 
(
íí 
grantedConsent
íí 
!=
íí !
null
íí" &
)
íí& '
{
ìì 
await
ïï 
_interaction
ïï "
.
ïï" #
GrantConsentAsync
ïï# 4
(
ïï4 5
request
ïï5 <
,
ïï< =
grantedConsent
ïï> L
)
ïïL M
;
ïïM N
result
òò 
.
òò 
RedirectUri
òò "
=
òò# $
model
òò% *
.
òò* +
	ReturnUrl
òò+ 4
;
òò4 5
result
ôô 
.
ôô 
Client
ôô 
=
ôô 
request
ôô  '
.
ôô' (
Client
ôô( .
;
ôô. /
}
öö 
else
õõ 
{
úú 
result
ûû 
.
ûû 
	ViewModel
ûû  
=
ûû! "
await
ûû# (!
BuildViewModelAsync
ûû) <
(
ûû< =
model
ûû= B
.
ûûB C
	ReturnUrl
ûûC L
,
ûûL M
model
ûûN S
)
ûûS T
;
ûûT U
}
üü 
return
°° 
result
°° 
;
°° 
}
¢¢ 	
private
§§ 
async
§§ 
Task
§§ 
<
§§ 
ConsentViewModel
§§ +
>
§§+ ,!
BuildViewModelAsync
§§- @
(
§§@ A
string
§§A G
	returnUrl
§§H Q
,
§§Q R
ConsentInputModel
§§S d
model
§§e j
=
§§k l
null
§§m q
)
§§q r
{
•• 	
var
¶¶ 
request
¶¶ 
=
¶¶ 
await
¶¶ 
_interaction
¶¶  ,
.
¶¶, -*
GetAuthorizationContextAsync
¶¶- I
(
¶¶I J
	returnUrl
¶¶J S
)
¶¶S T
;
¶¶T U
if
ßß 
(
ßß 
request
ßß 
!=
ßß 
null
ßß 
)
ßß  
{
®® 
return
©© $
CreateConsentViewModel
©© -
(
©©- .
model
©©. 3
,
©©3 4
	returnUrl
©©5 >
,
©©> ?
request
©©@ G
)
©©G H
;
©©H I
}
™™ 
else
´´ 
{
¨¨ 
_logger
≠≠ 
.
≠≠ 
LogError
≠≠  
(
≠≠  !
$str
≠≠! K
,
≠≠K L
	returnUrl
≠≠M V
)
≠≠V W
;
≠≠W X
}
ÆÆ 
return
∞∞ 
null
∞∞ 
;
∞∞ 
}
±± 	
private
≥≥ 
ConsentViewModel
≥≥  $
CreateConsentViewModel
≥≥! 7
(
≥≥7 8
ConsentInputModel
¥¥ 
model
¥¥ #
,
¥¥# $
string
¥¥% +
	returnUrl
¥¥, 5
,
¥¥5 6"
AuthorizationRequest
µµ  
request
µµ! (
)
µµ( )
{
∂∂ 	
var
∑∑ 
vm
∑∑ 
=
∑∑ 
new
∑∑ 
ConsentViewModel
∑∑ )
{
∏∏ 
RememberConsent
ππ 
=
ππ  !
model
ππ" '
?
ππ' (
.
ππ( )
RememberConsent
ππ) 8
??
ππ9 ;
true
ππ< @
,
ππ@ A
ScopesConsented
∫∫ 
=
∫∫  !
model
∫∫" '
?
∫∫' (
.
∫∫( )
ScopesConsented
∫∫) 8
??
∫∫9 ;

Enumerable
∫∫< F
.
∫∫F G
Empty
∫∫G L
<
∫∫L M
string
∫∫M S
>
∫∫S T
(
∫∫T U
)
∫∫U V
,
∫∫V W
Description
ªª 
=
ªª 
model
ªª #
?
ªª# $
.
ªª$ %
Description
ªª% 0
,
ªª0 1
	ReturnUrl
ΩΩ 
=
ΩΩ 
	returnUrl
ΩΩ %
,
ΩΩ% &

ClientName
øø 
=
øø 
request
øø $
.
øø$ %
Client
øø% +
.
øø+ ,

ClientName
øø, 6
??
øø7 9
request
øø: A
.
øøA B
Client
øøB H
.
øøH I
ClientId
øøI Q
,
øøQ R
	ClientUrl
¿¿ 
=
¿¿ 
request
¿¿ #
.
¿¿# $
Client
¿¿$ *
.
¿¿* +
	ClientUri
¿¿+ 4
,
¿¿4 5
ClientLogoUrl
¡¡ 
=
¡¡ 
request
¡¡  '
.
¡¡' (
Client
¡¡( .
.
¡¡. /
LogoUri
¡¡/ 6
,
¡¡6 7"
AllowRememberConsent
¬¬ $
=
¬¬% &
request
¬¬' .
.
¬¬. /
Client
¬¬/ 5
.
¬¬5 6"
AllowRememberConsent
¬¬6 J
}
√√ 
;
√√ 
vm
≈≈ 
.
≈≈ 
IdentityScopes
≈≈ 
=
≈≈ 
request
≈≈  '
.
≈≈' ( 
ValidatedResources
≈≈( :
.
≈≈: ;
	Resources
≈≈; D
.
≈≈D E
IdentityResources
≈≈E V
.
≈≈V W
Select
≈≈W ]
(
≈≈] ^
x
≈≈^ _
=>
≈≈` b"
CreateScopeViewModel
≈≈c w
(
≈≈w x
x
≈≈x y
,
≈≈y z
vm
≈≈{ }
.
≈≈} ~
ScopesConsented≈≈~ ç
.≈≈ç é
Contains≈≈é ñ
(≈≈ñ ó
x≈≈ó ò
.≈≈ò ô
Name≈≈ô ù
)≈≈ù û
||≈≈ü °
model≈≈¢ ß
==≈≈® ™
null≈≈´ Ø
)≈≈Ø ∞
)≈≈∞ ±
.≈≈± ≤
ToArray≈≈≤ π
(≈≈π ∫
)≈≈∫ ª
;≈≈ª º
var
«« 
	apiScopes
«« 
=
«« 
new
«« 
List
««  $
<
««$ %
ScopeViewModel
««% 3
>
««3 4
(
««4 5
)
««5 6
;
««6 7
foreach
»» 
(
»» 
var
»» 
parsedScope
»» $
in
»»% '
request
»»( /
.
»»/ 0 
ValidatedResources
»»0 B
.
»»B C
ParsedScopes
»»C O
)
»»O P
{
…… 
var
   
apiScope
   
=
   
request
   &
.
  & ' 
ValidatedResources
  ' 9
.
  9 :
	Resources
  : C
.
  C D
FindApiScope
  D P
(
  P Q
parsedScope
  Q \
.
  \ ]

ParsedName
  ] g
)
  g h
;
  h i
if
ÀÀ 
(
ÀÀ 
apiScope
ÀÀ 
!=
ÀÀ 
null
ÀÀ  $
)
ÀÀ$ %
{
ÃÃ 
var
ÕÕ 
scopeVm
ÕÕ 
=
ÕÕ  !"
CreateScopeViewModel
ÕÕ" 6
(
ÕÕ6 7
parsedScope
ÕÕ7 B
,
ÕÕB C
apiScope
ÕÕD L
,
ÕÕL M
vm
ÕÕN P
.
ÕÕP Q
ScopesConsented
ÕÕQ `
.
ÕÕ` a
Contains
ÕÕa i
(
ÕÕi j
parsedScope
ÕÕj u
.
ÕÕu v
RawValue
ÕÕv ~
)
ÕÕ~ 
||ÕÕÄ Ç
modelÕÕÉ à
==ÕÕâ ã
nullÕÕå ê
)ÕÕê ë
;ÕÕë í
	apiScopes
ŒŒ 
.
ŒŒ 
Add
ŒŒ !
(
ŒŒ! "
scopeVm
ŒŒ" )
)
ŒŒ) *
;
ŒŒ* +
}
œœ 
}
–– 
if
—— 
(
—— 
ConsentOptions
—— 
.
—— !
EnableOfflineAccess
—— 2
&&
——3 5
request
——6 =
.
——= > 
ValidatedResources
——> P
.
——P Q
	Resources
——Q Z
.
——Z [
OfflineAccess
——[ h
)
——h i
{
““ 
	apiScopes
”” 
.
”” 
Add
”” 
(
”” #
GetOfflineAccessScope
”” 3
(
””3 4
vm
””4 6
.
””6 7
ScopesConsented
””7 F
.
””F G
Contains
””G O
(
””O P
IdentityServer4
””P _
.
””_ `%
IdentityServerConstants
””` w
.
””w x
StandardScopes””x Ü
.””Ü á
OfflineAccess””á î
)””î ï
||””ñ ò
model””ô û
==””ü °
null””¢ ¶
)””¶ ß
)””ß ®
;””® ©
}
‘‘ 
vm
’’ 
.
’’ 
	ApiScopes
’’ 
=
’’ 
	apiScopes
’’ $
;
’’$ %
return
◊◊ 
vm
◊◊ 
;
◊◊ 
}
ÿÿ 	
private
⁄⁄ 
ScopeViewModel
⁄⁄ "
CreateScopeViewModel
⁄⁄ 3
(
⁄⁄3 4
IdentityResource
⁄⁄4 D
identity
⁄⁄E M
,
⁄⁄M N
bool
⁄⁄O S
check
⁄⁄T Y
)
⁄⁄Y Z
{
€€ 	
return
‹‹ 
new
‹‹ 
ScopeViewModel
‹‹ %
{
›› 
Value
ﬁﬁ 
=
ﬁﬁ 
identity
ﬁﬁ  
.
ﬁﬁ  !
Name
ﬁﬁ! %
,
ﬁﬁ% &
DisplayName
ﬂﬂ 
=
ﬂﬂ 
identity
ﬂﬂ &
.
ﬂﬂ& '
DisplayName
ﬂﬂ' 2
??
ﬂﬂ3 5
identity
ﬂﬂ6 >
.
ﬂﬂ> ?
Name
ﬂﬂ? C
,
ﬂﬂC D
Description
‡‡ 
=
‡‡ 
identity
‡‡ &
.
‡‡& '
Description
‡‡' 2
,
‡‡2 3
	Emphasize
·· 
=
·· 
identity
·· $
.
··$ %
	Emphasize
··% .
,
··. /
Required
‚‚ 
=
‚‚ 
identity
‚‚ #
.
‚‚# $
Required
‚‚$ ,
,
‚‚, -
Checked
„„ 
=
„„ 
check
„„ 
||
„„  "
identity
„„# +
.
„„+ ,
Required
„„, 4
}
‰‰ 
;
‰‰ 
}
ÂÂ 	
public
ÁÁ 
ScopeViewModel
ÁÁ "
CreateScopeViewModel
ÁÁ 2
(
ÁÁ2 3
ParsedScopeValue
ÁÁ3 C
parsedScopeValue
ÁÁD T
,
ÁÁT U
ApiScope
ÁÁV ^
apiScope
ÁÁ_ g
,
ÁÁg h
bool
ÁÁi m
check
ÁÁn s
)
ÁÁs t
{
ËË 	
var
ÈÈ 
displayName
ÈÈ 
=
ÈÈ 
apiScope
ÈÈ &
.
ÈÈ& '
DisplayName
ÈÈ' 2
??
ÈÈ3 5
apiScope
ÈÈ6 >
.
ÈÈ> ?
Name
ÈÈ? C
;
ÈÈC D
if
ÍÍ 
(
ÍÍ 
!
ÍÍ 
String
ÍÍ 
.
ÍÍ  
IsNullOrWhiteSpace
ÍÍ *
(
ÍÍ* +
parsedScopeValue
ÍÍ+ ;
.
ÍÍ; <
ParsedParameter
ÍÍ< K
)
ÍÍK L
)
ÍÍL M
{
ÎÎ 
displayName
ÏÏ 
+=
ÏÏ 
$str
ÏÏ "
+
ÏÏ# $
parsedScopeValue
ÏÏ% 5
.
ÏÏ5 6
ParsedParameter
ÏÏ6 E
;
ÏÏE F
}
ÌÌ 
return
ÔÔ 
new
ÔÔ 
ScopeViewModel
ÔÔ %
{
 
Value
ÒÒ 
=
ÒÒ 
parsedScopeValue
ÒÒ (
.
ÒÒ( )
RawValue
ÒÒ) 1
,
ÒÒ1 2
DisplayName
ÚÚ 
=
ÚÚ 
displayName
ÚÚ )
,
ÚÚ) *
Description
ÛÛ 
=
ÛÛ 
apiScope
ÛÛ &
.
ÛÛ& '
Description
ÛÛ' 2
,
ÛÛ2 3
	Emphasize
ÙÙ 
=
ÙÙ 
apiScope
ÙÙ $
.
ÙÙ$ %
	Emphasize
ÙÙ% .
,
ÙÙ. /
Required
ıı 
=
ıı 
apiScope
ıı #
.
ıı# $
Required
ıı$ ,
,
ıı, -
Checked
ˆˆ 
=
ˆˆ 
check
ˆˆ 
||
ˆˆ  "
apiScope
ˆˆ# +
.
ˆˆ+ ,
Required
ˆˆ, 4
}
˜˜ 
;
˜˜ 
}
¯¯ 	
private
˙˙ 
ScopeViewModel
˙˙ #
GetOfflineAccessScope
˙˙ 4
(
˙˙4 5
bool
˙˙5 9
check
˙˙: ?
)
˙˙? @
{
˚˚ 	
return
¸¸ 
new
¸¸ 
ScopeViewModel
¸¸ %
{
˝˝ 
Value
˛˛ 
=
˛˛ 
IdentityServer4
˛˛ '
.
˛˛' (%
IdentityServerConstants
˛˛( ?
.
˛˛? @
StandardScopes
˛˛@ N
.
˛˛N O
OfflineAccess
˛˛O \
,
˛˛\ ]
DisplayName
ˇˇ 
=
ˇˇ 
ConsentOptions
ˇˇ ,
.
ˇˇ, -&
OfflineAccessDisplayName
ˇˇ- E
,
ˇˇE F
Description
ÄÄ 
=
ÄÄ 
ConsentOptions
ÄÄ ,
.
ÄÄ, -&
OfflineAccessDescription
ÄÄ- E
,
ÄÄE F
	Emphasize
ÅÅ 
=
ÅÅ 
true
ÅÅ  
,
ÅÅ  !
Checked
ÇÇ 
=
ÇÇ 
check
ÇÇ 
}
ÉÉ 
;
ÉÉ 
}
ÑÑ 	
}
ÖÖ 
}ÜÜ 	
£C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Consent\ConsentInputModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public		 

class		 
ConsentInputModel		 "
{

 
public 
string 
Button 
{ 
get "
;" #
set$ '
;' (
}) *
public 
IEnumerable 
< 
string !
>! "
ScopesConsented# 2
{3 4
get5 8
;8 9
set: =
;= >
}? @
public 
bool 
RememberConsent #
{$ %
get& )
;) *
set+ .
;. /
}0 1
public 
string 
	ReturnUrl 
{  !
get" %
;% &
set' *
;* +
}, -
public 
string 
Description !
{" #
get$ '
;' (
set) ,
;, -
}. /
} 
} ±	
†C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Consent\ConsentOptions.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

static 
class 
ConsentOptions &
{ 
public		 
static		 
bool		 
EnableOfflineAccess		 .
=		/ 0
true		1 5
;		5 6
public

 
static

 
string

 $
OfflineAccessDisplayName

 5
=

6 7
$str

8 H
;

H I
public 
static 
string $
OfflineAccessDescription 5
=6 7
$str8 ~
;~ 
public 
static 
readonly 
string %%
MustChooseOneErrorMessage& ?
=@ A
$strB i
;i j
public 
static 
readonly 
string %(
InvalidSelectionErrorMessage& B
=C D
$strE X
;X Y
} 
} ä
¢C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Consent\ConsentViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public		 

class		 
ConsentViewModel		 !
:		" #
ConsentInputModel		$ 5
{

 
public 
string 

ClientName  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
string 
	ClientUrl 
{  !
get" %
;% &
set' *
;* +
}, -
public 
string 
ClientLogoUrl #
{$ %
get& )
;) *
set+ .
;. /
}0 1
public 
bool  
AllowRememberConsent (
{) *
get+ .
;. /
set0 3
;3 4
}5 6
public 
IEnumerable 
< 
ScopeViewModel )
>) *
IdentityScopes+ 9
{: ;
get< ?
;? @
setA D
;D E
}F G
public 
IEnumerable 
< 
ScopeViewModel )
>) *
	ApiScopes+ 4
{5 6
get7 :
;: ;
set< ?
;? @
}A B
} 
} ¯
¶C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Consent\ProcessConsentResult.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public		 

class		  
ProcessConsentResult		 %
{

 
public 
bool 

IsRedirect 
=> !
RedirectUri" -
!=. 0
null1 5
;5 6
public 
string 
RedirectUri !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 
Client 
Client 
{ 
get "
;" #
set$ '
;' (
}) *
public 
bool 
ShowView 
=> 
	ViewModel  )
!=* ,
null- 1
;1 2
public 
ConsentViewModel 
	ViewModel  )
{* +
get, /
;/ 0
set1 4
;4 5
}6 7
public 
bool 
HasValidationError &
=>' )
ValidationError* 9
!=: <
null= A
;A B
public 
string 
ValidationError %
{& '
get( +
;+ ,
set- 0
;0 1
}2 3
} 
} æ

†C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Consent\ScopeViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
ScopeViewModel 
{ 
public		 
string		 
Value		 
{		 
get		 !
;		! "
set		# &
;		& '
}		( )
public

 
string

 
DisplayName

 !
{

" #
get

$ '
;

' (
set

) ,
;

, -
}

. /
public 
string 
Description !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 
bool 
	Emphasize 
{ 
get  #
;# $
set% (
;( )
}* +
public 
bool 
Required 
{ 
get "
;" #
set$ '
;' (
}) *
public 
bool 
Checked 
{ 
get !
;! "
set# &
;& '
}( )
} 
} Ä
ÆC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Device\DeviceAuthorizationInputModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class )
DeviceAuthorizationInputModel .
:/ 0
ConsentInputModel1 B
{ 
public		 
string		 
UserCode		 
{		  
get		! $
;		$ %
set		& )
;		) *
}		+ ,
}

 
} û
≠C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Device\DeviceAuthorizationViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class (
DeviceAuthorizationViewModel -
:. /
ConsentViewModel0 @
{ 
public		 
string		 
UserCode		 
{		  
get		! $
;		$ %
set		& )
;		) *
}		+ ,
public

 
bool

 
ConfirmUserCode

 #
{

$ %
get

& )
;

) *
set

+ .
;

. /
}

0 1
} 
} ç≠
°C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Device\DeviceController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[ 
	Authorize 
] 
[ 
SecurityHeaders 
] 
public 

class 
DeviceController !
:" #

Controller$ .
{ 
private 
readonly )
IDeviceFlowInteractionService 6
_interaction7 C
;C D
private 
readonly 
IEventService &
_events' .
;. /
private 
readonly 
IOptions !
<! "!
IdentityServerOptions" 7
>7 8
_options9 A
;A B
private 
readonly 
ILogger  
<  !
DeviceController! 1
>1 2
_logger3 :
;: ;
public 
DeviceController 
(  )
IDeviceFlowInteractionService   )
interaction  * 5
,  5 6
IEventService!! 
eventService!! &
,!!& '
IOptions"" 
<"" !
IdentityServerOptions"" *
>""* +
options"", 3
,""3 4
ILogger## 
<## 
DeviceController## $
>##$ %
logger##& ,
)##, -
{$$ 	
_interaction%% 
=%% 
interaction%% &
;%%& '
_events&& 
=&& 
eventService&& "
;&&" #
_options'' 
='' 
options'' 
;'' 
_logger(( 
=(( 
logger(( 
;(( 
})) 	
[++ 	
HttpGet++	 
]++ 
public,, 
async,, 
Task,, 
<,, 
IActionResult,, '
>,,' (
Index,,) .
(,,. /
),,/ 0
{-- 	
string.. 
userCodeParamName.. $
=..% &
_options..' /
.../ 0
Value..0 5
...5 6
UserInteraction..6 E
...E F/
#DeviceVerificationUserCodeParameter..F i
;..i j
string// 
userCode// 
=// 
Request// %
.//% &
Query//& +
[//+ ,
userCodeParamName//, =
]//= >
;//> ?
if00 
(00 
string00 
.00 
IsNullOrWhiteSpace00 )
(00) *
userCode00* 2
)002 3
)003 4
return005 ;
View00< @
(00@ A
$str00A R
)00R S
;00S T
var22 
vm22 
=22 
await22 
BuildViewModelAsync22 .
(22. /
userCode22/ 7
)227 8
;228 9
if33 
(33 
vm33 
==33 
null33 
)33 
return33 "
View33# '
(33' (
$str33( /
)33/ 0
;330 1
vm55 
.55 
ConfirmUserCode55 
=55  
true55! %
;55% &
return66 
View66 
(66 
$str66 .
,66. /
vm660 2
)662 3
;663 4
}77 	
[99 	
HttpPost99	 
]99 
[:: 	$
ValidateAntiForgeryToken::	 !
]::! "
public;; 
async;; 
Task;; 
<;; 
IActionResult;; '
>;;' (
UserCodeCapture;;) 8
(;;8 9
string;;9 ?
userCode;;@ H
);;H I
{<< 	
var== 
vm== 
=== 
await== 
BuildViewModelAsync== .
(==. /
userCode==/ 7
)==7 8
;==8 9
if>> 
(>> 
vm>> 
==>> 
null>> 
)>> 
return>> "
View>># '
(>>' (
$str>>( /
)>>/ 0
;>>0 1
return@@ 
View@@ 
(@@ 
$str@@ .
,@@. /
vm@@0 2
)@@2 3
;@@3 4
}AA 	
[CC 	
HttpPostCC	 
]CC 
[DD 	$
ValidateAntiForgeryTokenDD	 !
]DD! "
publicEE 
TaskEE 
<EE 
IActionResultEE !
>EE! "
CallbackEE# +
(EE+ ,)
DeviceAuthorizationInputModelEE, I
modelEEJ O
)EEO P
{FF 	
ifGG 
(GG 
modelGG 
==GG 
nullGG 
)GG 
{HH 
throwII 
newII !
ArgumentNullExceptionII /
(II/ 0
nameofII0 6
(II6 7
modelII7 <
)II< =
)II= >
;II> ?
}JJ 
returnLL 
CallbackInternalLL #
(LL# $
modelLL$ )
)LL) *
;LL* +
}MM 	
publicOO 
asyncOO 
TaskOO 
<OO 
IActionResultOO '
>OO' (
CallbackInternalOO) 9
(OO9 :)
DeviceAuthorizationInputModelOO: W
modelOOX ]
)OO] ^
{PP 	
varQQ 
resultQQ 
=QQ 
awaitQQ 
ProcessConsentQQ -
(QQ- .
modelQQ. 3
)QQ3 4
;QQ4 5
ifRR 
(RR 
resultRR 
.RR 
HasValidationErrorRR )
)RR) *
{SS 
returnTT 
ViewTT 
(TT 
$strTT #
)TT# $
;TT$ %
}UU 
returnWW 
ViewWW 
(WW 
$strWW !
)WW! "
;WW" #
}XX 	
privateZZ 
asyncZZ 
TaskZZ 
<ZZ  
ProcessConsentResultZZ /
>ZZ/ 0
ProcessConsentZZ1 ?
(ZZ? @)
DeviceAuthorizationInputModelZZ@ ]
modelZZ^ c
)ZZc d
{[[ 	
var\\ 
result\\ 
=\\ 
new\\  
ProcessConsentResult\\ 1
(\\1 2
)\\2 3
;\\3 4
var^^ 
request^^ 
=^^ 
await^^ 
_interaction^^  ,
.^^, -(
GetAuthorizationContextAsync^^- I
(^^I J
model^^J O
.^^O P
UserCode^^P X
)^^X Y
;^^Y Z
if__ 
(__ 
request__ 
==__ 
null__ 
)__  
return__! '
result__( .
;__. /
ConsentResponseaa 
grantedConsentaa *
=aa+ ,
nullaa- 1
;aa1 2
ifdd 
(dd 
modeldd 
.dd 
Buttondd 
==dd 
$strdd  $
)dd$ %
{ee 
grantedConsentff 
=ff  
newff! $
ConsentResponseff% 4
{ff5 6
Errorff7 <
=ff= >
AuthorizationErrorff? Q
.ffQ R
AccessDeniedffR ^
}ff_ `
;ff` a
awaitii 
_eventsii 
.ii 

RaiseAsyncii (
(ii( )
newii) ,
ConsentDeniedEventii- ?
(ii? @
Userii@ D
.iiD E
GetSubjectIdiiE Q
(iiQ R
)iiR S
,iiS T
requestiiU \
.ii\ ]
Clientii] c
.iic d
ClientIdiid l
,iil m
requestiin u
.iiu v
ValidatedResources	iiv à
.
iià â
RawScopeValues
iiâ ó
)
iió ò
)
iiò ô
;
iiô ö
}jj 
elsell 
ifll 
(ll 
modelll 
.ll 
Buttonll !
==ll" $
$strll% *
)ll* +
{mm 
ifoo 
(oo 
modeloo 
.oo 
ScopesConsentedoo )
!=oo* ,
nulloo- 1
&&oo2 4
modeloo5 :
.oo: ;
ScopesConsentedoo; J
.ooJ K
AnyooK N
(ooN O
)ooO P
)ooP Q
{pp 
varqq 
scopesqq 
=qq  
modelqq! &
.qq& '
ScopesConsentedqq' 6
;qq6 7
ifrr 
(rr 
ConsentOptionsrr &
.rr& '
EnableOfflineAccessrr' :
==rr; =
falserr> C
)rrC D
{ss 
scopestt 
=tt  
scopestt! '
.tt' (
Wherett( -
(tt- .
xtt. /
=>tt0 2
xtt3 4
!=tt5 7
IdentityServer4tt8 G
.ttG H#
IdentityServerConstantsttH _
.tt_ `
StandardScopestt` n
.ttn o
OfflineAccesstto |
)tt| }
;tt} ~
}uu 
grantedConsentww "
=ww# $
newww% (
ConsentResponseww) 8
{xx 
RememberConsentyy '
=yy( )
modelyy* /
.yy/ 0
RememberConsentyy0 ?
,yy? @!
ScopesValuesConsentedzz -
=zz. /
scopeszz0 6
.zz6 7
ToArrayzz7 >
(zz> ?
)zz? @
,zz@ A
Description{{ #
={{$ %
model{{& +
.{{+ ,
Description{{, 7
}|| 
;|| 
await 
_events !
.! "

RaiseAsync" ,
(, -
new- 0
ConsentGrantedEvent1 D
(D E
UserE I
.I J
GetSubjectIdJ V
(V W
)W X
,X Y
requestZ a
.a b
Clientb h
.h i
ClientIdi q
,q r
requests z
.z {
ValidatedResources	{ ç
.
ç é
RawScopeValues
é ú
,
ú ù
grantedConsent
û ¨
.
¨ ≠#
ScopesValuesConsented
≠ ¬
,
¬ √
grantedConsent
ƒ “
.
“ ”
RememberConsent
” ‚
)
‚ „
)
„ ‰
;
‰ Â
}
ÄÄ 
else
ÅÅ 
{
ÇÇ 
result
ÉÉ 
.
ÉÉ 
ValidationError
ÉÉ *
=
ÉÉ+ ,
ConsentOptions
ÉÉ- ;
.
ÉÉ; <'
MustChooseOneErrorMessage
ÉÉ< U
;
ÉÉU V
}
ÑÑ 
}
ÖÖ 
else
ÜÜ 
{
áá 
result
àà 
.
àà 
ValidationError
àà &
=
àà' (
ConsentOptions
àà) 7
.
àà7 8*
InvalidSelectionErrorMessage
àà8 T
;
ààT U
}
ââ 
if
ãã 
(
ãã 
grantedConsent
ãã 
!=
ãã !
null
ãã" &
)
ãã& '
{
åå 
await
éé 
_interaction
éé "
.
éé" # 
HandleRequestAsync
éé# 5
(
éé5 6
model
éé6 ;
.
éé; <
UserCode
éé< D
,
ééD E
grantedConsent
ééF T
)
ééT U
;
ééU V
result
ëë 
.
ëë 
RedirectUri
ëë "
=
ëë# $
model
ëë% *
.
ëë* +
	ReturnUrl
ëë+ 4
;
ëë4 5
result
íí 
.
íí 
Client
íí 
=
íí 
request
íí  '
.
íí' (
Client
íí( .
;
íí. /
}
ìì 
else
îî 
{
ïï 
result
óó 
.
óó 
	ViewModel
óó  
=
óó! "
await
óó# (!
BuildViewModelAsync
óó) <
(
óó< =
model
óó= B
.
óóB C
UserCode
óóC K
,
óóK L
model
óóM R
)
óóR S
;
óóS T
}
òò 
return
öö 
result
öö 
;
öö 
}
õõ 	
private
ùù 
async
ùù 
Task
ùù 
<
ùù *
DeviceAuthorizationViewModel
ùù 7
>
ùù7 8!
BuildViewModelAsync
ùù9 L
(
ùùL M
string
ùùM S
userCode
ùùT \
,
ùù\ ]+
DeviceAuthorizationInputModel
ùù^ {
modelùù| Å
=ùùÇ É
nullùùÑ à
)ùùà â
{
ûû 	
var
üü 
request
üü 
=
üü 
await
üü 
_interaction
üü  ,
.
üü, -*
GetAuthorizationContextAsync
üü- I
(
üüI J
userCode
üüJ R
)
üüR S
;
üüS T
if
†† 
(
†† 
request
†† 
!=
†† 
null
†† 
)
††  
{
°° 
return
¢¢ $
CreateConsentViewModel
¢¢ -
(
¢¢- .
userCode
¢¢. 6
,
¢¢6 7
model
¢¢8 =
,
¢¢= >
request
¢¢? F
)
¢¢F G
;
¢¢G H
}
££ 
return
•• 
null
•• 
;
•• 
}
¶¶ 	
private
®® *
DeviceAuthorizationViewModel
®® ,$
CreateConsentViewModel
®®- C
(
®®C D
string
®®D J
userCode
®®K S
,
®®S T+
DeviceAuthorizationInputModel
®®U r
model
®®s x
,
®®x y-
DeviceFlowAuthorizationRequest®®z ò
request®®ô †
)®®† °
{
©© 	
var
™™ 
vm
™™ 
=
™™ 
new
™™ *
DeviceAuthorizationViewModel
™™ 5
{
´´ 
UserCode
¨¨ 
=
¨¨ 
userCode
¨¨ #
,
¨¨# $
Description
≠≠ 
=
≠≠ 
model
≠≠ #
?
≠≠# $
.
≠≠$ %
Description
≠≠% 0
,
≠≠0 1
RememberConsent
ØØ 
=
ØØ  !
model
ØØ" '
?
ØØ' (
.
ØØ( )
RememberConsent
ØØ) 8
??
ØØ9 ;
true
ØØ< @
,
ØØ@ A
ScopesConsented
∞∞ 
=
∞∞  !
model
∞∞" '
?
∞∞' (
.
∞∞( )
ScopesConsented
∞∞) 8
??
∞∞9 ;

Enumerable
∞∞< F
.
∞∞F G
Empty
∞∞G L
<
∞∞L M
string
∞∞M S
>
∞∞S T
(
∞∞T U
)
∞∞U V
,
∞∞V W

ClientName
≤≤ 
=
≤≤ 
request
≤≤ $
.
≤≤$ %
Client
≤≤% +
.
≤≤+ ,

ClientName
≤≤, 6
??
≤≤7 9
request
≤≤: A
.
≤≤A B
Client
≤≤B H
.
≤≤H I
ClientId
≤≤I Q
,
≤≤Q R
	ClientUrl
≥≥ 
=
≥≥ 
request
≥≥ #
.
≥≥# $
Client
≥≥$ *
.
≥≥* +
	ClientUri
≥≥+ 4
,
≥≥4 5
ClientLogoUrl
¥¥ 
=
¥¥ 
request
¥¥  '
.
¥¥' (
Client
¥¥( .
.
¥¥. /
LogoUri
¥¥/ 6
,
¥¥6 7"
AllowRememberConsent
µµ $
=
µµ% &
request
µµ' .
.
µµ. /
Client
µµ/ 5
.
µµ5 6"
AllowRememberConsent
µµ6 J
}
∂∂ 
;
∂∂ 
vm
∏∏ 
.
∏∏ 
IdentityScopes
∏∏ 
=
∏∏ 
request
∏∏  '
.
∏∏' ( 
ValidatedResources
∏∏( :
.
∏∏: ;
	Resources
∏∏; D
.
∏∏D E
IdentityResources
∏∏E V
.
∏∏V W
Select
∏∏W ]
(
∏∏] ^
x
∏∏^ _
=>
∏∏` b"
CreateScopeViewModel
∏∏c w
(
∏∏w x
x
∏∏x y
,
∏∏y z
vm
∏∏{ }
.
∏∏} ~
ScopesConsented∏∏~ ç
.∏∏ç é
Contains∏∏é ñ
(∏∏ñ ó
x∏∏ó ò
.∏∏ò ô
Name∏∏ô ù
)∏∏ù û
||∏∏ü °
model∏∏¢ ß
==∏∏® ™
null∏∏´ Ø
)∏∏Ø ∞
)∏∏∞ ±
.∏∏± ≤
ToArray∏∏≤ π
(∏∏π ∫
)∏∏∫ ª
;∏∏ª º
var
∫∫ 
	apiScopes
∫∫ 
=
∫∫ 
new
∫∫ 
List
∫∫  $
<
∫∫$ %
ScopeViewModel
∫∫% 3
>
∫∫3 4
(
∫∫4 5
)
∫∫5 6
;
∫∫6 7
foreach
ªª 
(
ªª 
var
ªª 
parsedScope
ªª $
in
ªª% '
request
ªª( /
.
ªª/ 0 
ValidatedResources
ªª0 B
.
ªªB C
ParsedScopes
ªªC O
)
ªªO P
{
ºº 
var
ΩΩ 
apiScope
ΩΩ 
=
ΩΩ 
request
ΩΩ &
.
ΩΩ& ' 
ValidatedResources
ΩΩ' 9
.
ΩΩ9 :
	Resources
ΩΩ: C
.
ΩΩC D
FindApiScope
ΩΩD P
(
ΩΩP Q
parsedScope
ΩΩQ \
.
ΩΩ\ ]

ParsedName
ΩΩ] g
)
ΩΩg h
;
ΩΩh i
if
ææ 
(
ææ 
apiScope
ææ 
!=
ææ 
null
ææ  $
)
ææ$ %
{
øø 
var
¿¿ 
scopeVm
¿¿ 
=
¿¿  !"
CreateScopeViewModel
¿¿" 6
(
¿¿6 7
parsedScope
¿¿7 B
,
¿¿B C
apiScope
¿¿D L
,
¿¿L M
vm
¿¿N P
.
¿¿P Q
ScopesConsented
¿¿Q `
.
¿¿` a
Contains
¿¿a i
(
¿¿i j
parsedScope
¿¿j u
.
¿¿u v
RawValue
¿¿v ~
)
¿¿~ 
||¿¿Ä Ç
model¿¿É à
==¿¿â ã
null¿¿å ê
)¿¿ê ë
;¿¿ë í
	apiScopes
¡¡ 
.
¡¡ 
Add
¡¡ !
(
¡¡! "
scopeVm
¡¡" )
)
¡¡) *
;
¡¡* +
}
¬¬ 
}
√√ 
if
ƒƒ 
(
ƒƒ 
ConsentOptions
ƒƒ 
.
ƒƒ !
EnableOfflineAccess
ƒƒ 2
&&
ƒƒ3 5
request
ƒƒ6 =
.
ƒƒ= > 
ValidatedResources
ƒƒ> P
.
ƒƒP Q
	Resources
ƒƒQ Z
.
ƒƒZ [
OfflineAccess
ƒƒ[ h
)
ƒƒh i
{
≈≈ 
	apiScopes
∆∆ 
.
∆∆ 
Add
∆∆ 
(
∆∆ #
GetOfflineAccessScope
∆∆ 3
(
∆∆3 4
vm
∆∆4 6
.
∆∆6 7
ScopesConsented
∆∆7 F
.
∆∆F G
Contains
∆∆G O
(
∆∆O P
IdentityServer4
∆∆P _
.
∆∆_ `%
IdentityServerConstants
∆∆` w
.
∆∆w x
StandardScopes∆∆x Ü
.∆∆Ü á
OfflineAccess∆∆á î
)∆∆î ï
||∆∆ñ ò
model∆∆ô û
==∆∆ü °
null∆∆¢ ¶
)∆∆¶ ß
)∆∆ß ®
;∆∆® ©
}
«« 
vm
»» 
.
»» 
	ApiScopes
»» 
=
»» 
	apiScopes
»» $
;
»»$ %
return
   
vm
   
;
   
}
ÀÀ 	
private
ÕÕ 
ScopeViewModel
ÕÕ "
CreateScopeViewModel
ÕÕ 3
(
ÕÕ3 4
IdentityResource
ÕÕ4 D
identity
ÕÕE M
,
ÕÕM N
bool
ÕÕO S
check
ÕÕT Y
)
ÕÕY Z
{
ŒŒ 	
return
œœ 
new
œœ 
ScopeViewModel
œœ %
{
–– 
Value
—— 
=
—— 
identity
——  
.
——  !
Name
——! %
,
——% &
DisplayName
““ 
=
““ 
identity
““ &
.
““& '
DisplayName
““' 2
??
““3 5
identity
““6 >
.
““> ?
Name
““? C
,
““C D
Description
”” 
=
”” 
identity
”” &
.
””& '
Description
””' 2
,
””2 3
	Emphasize
‘‘ 
=
‘‘ 
identity
‘‘ $
.
‘‘$ %
	Emphasize
‘‘% .
,
‘‘. /
Required
’’ 
=
’’ 
identity
’’ #
.
’’# $
Required
’’$ ,
,
’’, -
Checked
÷÷ 
=
÷÷ 
check
÷÷ 
||
÷÷  "
identity
÷÷# +
.
÷÷+ ,
Required
÷÷, 4
}
◊◊ 
;
◊◊ 
}
ÿÿ 	
public
⁄⁄ 
ScopeViewModel
⁄⁄ "
CreateScopeViewModel
⁄⁄ 2
(
⁄⁄2 3
ParsedScopeValue
⁄⁄3 C
parsedScopeValue
⁄⁄D T
,
⁄⁄T U
ApiScope
⁄⁄V ^
apiScope
⁄⁄_ g
,
⁄⁄g h
bool
⁄⁄i m
check
⁄⁄n s
)
⁄⁄s t
{
€€ 	
return
‹‹ 
new
‹‹ 
ScopeViewModel
‹‹ %
{
›› 
Value
ﬁﬁ 
=
ﬁﬁ 
parsedScopeValue
ﬁﬁ (
.
ﬁﬁ( )
RawValue
ﬁﬁ) 1
,
ﬁﬁ1 2
DisplayName
‡‡ 
=
‡‡ 
apiScope
‡‡ &
.
‡‡& '
DisplayName
‡‡' 2
??
‡‡3 5
apiScope
‡‡6 >
.
‡‡> ?
Name
‡‡? C
,
‡‡C D
Description
·· 
=
·· 
apiScope
·· &
.
··& '
Description
··' 2
,
··2 3
	Emphasize
‚‚ 
=
‚‚ 
apiScope
‚‚ $
.
‚‚$ %
	Emphasize
‚‚% .
,
‚‚. /
Required
„„ 
=
„„ 
apiScope
„„ #
.
„„# $
Required
„„$ ,
,
„„, -
Checked
‰‰ 
=
‰‰ 
check
‰‰ 
||
‰‰  "
apiScope
‰‰# +
.
‰‰+ ,
Required
‰‰, 4
}
ÂÂ 
;
ÂÂ 
}
ÊÊ 	
private
ÁÁ 
ScopeViewModel
ÁÁ #
GetOfflineAccessScope
ÁÁ 4
(
ÁÁ4 5
bool
ÁÁ5 9
check
ÁÁ: ?
)
ÁÁ? @
{
ËË 	
return
ÈÈ 
new
ÈÈ 
ScopeViewModel
ÈÈ %
{
ÍÍ 
Value
ÎÎ 
=
ÎÎ 
IdentityServer4
ÎÎ '
.
ÎÎ' (%
IdentityServerConstants
ÎÎ( ?
.
ÎÎ? @
StandardScopes
ÎÎ@ N
.
ÎÎN O
OfflineAccess
ÎÎO \
,
ÎÎ\ ]
DisplayName
ÏÏ 
=
ÏÏ 
ConsentOptions
ÏÏ ,
.
ÏÏ, -&
OfflineAccessDisplayName
ÏÏ- E
,
ÏÏE F
Description
ÌÌ 
=
ÌÌ 
ConsentOptions
ÌÌ ,
.
ÌÌ, -&
OfflineAccessDescription
ÌÌ- E
,
ÌÌE F
	Emphasize
ÓÓ 
=
ÓÓ 
true
ÓÓ  
,
ÓÓ  !
Checked
ÔÔ 
=
ÔÔ 
check
ÔÔ 
}
 
;
 
}
ÒÒ 	
}
ÚÚ 
}ÛÛ –
´C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Diagnostics\DiagnosticsController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[ 
SecurityHeaders 
] 
[ 
	Authorize 
] 
public 

class !
DiagnosticsController &
:' (

Controller) 3
{ 
public 
async 
Task 
< 
IActionResult '
>' (
Index) .
(. /
)/ 0
{ 	
var 
localAddresses 
=  
new! $
string% +
[+ ,
], -
{. /
$str0 ;
,; <
$str= B
,B C
HttpContextD O
.O P

ConnectionP Z
.Z [
LocalIpAddress[ i
.i j
ToStringj r
(r s
)s t
}u v
;v w
if 
( 
! 
localAddresses 
.  
Contains  (
(( )
HttpContext) 4
.4 5

Connection5 ?
.? @
RemoteIpAddress@ O
.O P
ToStringP X
(X Y
)Y Z
)Z [
)[ \
{ 
return 
NotFound 
(  
)  !
;! "
} 
var 
model 
= 
new  
DiagnosticsViewModel 0
(0 1
await1 6
HttpContext7 B
.B C
AuthenticateAsyncC T
(T U
)U V
)V W
;W X
return 
View 
( 
model 
) 
; 
} 	
} 
} ¬
™C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Diagnostics\DiagnosticsViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class  
DiagnosticsViewModel %
{ 
public  
DiagnosticsViewModel #
(# $
AuthenticateResult$ 6
result7 =
)= >
{ 	
AuthenticateResult 
=  
result! '
;' (
if 
( 
result 
. 

Properties !
.! "
Items" '
.' (
ContainsKey( 3
(3 4
$str4 A
)A B
)B C
{ 
var 
encoded 
= 
result $
.$ %

Properties% /
./ 0
Items0 5
[5 6
$str6 C
]C D
;D E
var 
bytes 
= 
	Base64Url %
.% &
Decode& ,
(, -
encoded- 4
)4 5
;5 6
var 
value 
= 
Encoding $
.$ %
UTF8% )
.) *
	GetString* 3
(3 4
bytes4 9
)9 :
;: ;
Clients 
= 
JsonConvert %
.% &
DeserializeObject& 7
<7 8
string8 >
[> ?
]? @
>@ A
(A B
valueB G
)G H
;H I
} 
} 	
public 
AuthenticateResult !
AuthenticateResult" 4
{5 6
get7 :
;: ;
}< =
public 
IEnumerable 
< 
string !
>! "
Clients# *
{+ ,
get- 0
;0 1
}2 3
=4 5
new6 9
List: >
<> ?
string? E
>E F
(F G
)G H
;H I
} 
}   µ
îC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Extensions.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

static 
class 

Extensions "
{ 
public 
static 
bool 
IsNativeClient )
() *
this* . 
AuthorizationRequest/ C
contextD K
)K L
{ 	
return 
! 
context 
. 
RedirectUri '
.' (

StartsWith( 2
(2 3
$str3 :
,: ;
StringComparison< L
.L M
OrdinalM T
)T U
&& 
! 
context 
. 
RedirectUri &
.& '

StartsWith' 1
(1 2
$str2 8
,8 9
StringComparison: J
.J K
OrdinalK R
)R S
;S T
} 	
public 
static 
IActionResult #
LoadingPage$ /
(/ 0
this0 4

Controller5 ?

controller@ J
,J K
stringL R
viewNameS [
,[ \
string] c
redirectUrid o
)o p
{ 	

controller 
. 
HttpContext "
." #
Response# +
.+ ,

StatusCode, 6
=7 8
$num9 <
;< =

controller 
. 
HttpContext "
." #
Response# +
.+ ,
Headers, 3
[3 4
$str4 >
]> ?
=@ A
$strB D
;D E
return 

controller 
. 
View "
(" #
viewName# +
,+ ,
new- 0
RedirectViewModel1 B
{C D
RedirectUrlE P
=Q R
redirectUriS ^
}_ `
)` a
;a b
} 	
} 
} õ3
°C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Grants\GrantsController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[ 
SecurityHeaders 
] 
[ 
	Authorize 
] 
public 

class 
GrantsController !
:" #

Controller$ .
{ 
private 
readonly -
!IIdentityServerInteractionService :
_interaction; G
;G H
private 
readonly 
IClientStore %
_clients& .
;. /
private 
readonly 
IResourceStore '

_resources( 2
;2 3
private 
readonly 
IEventService &
_events' .
;. /
public 
GrantsController 
(  -
!IIdentityServerInteractionService  A
interactionB M
,M N
IClientStore 
clients  
,  !
IResourceStore 
	resources $
,$ %
IEventService   
events    
)    !
{!! 	
_interaction"" 
="" 
interaction"" &
;""& '
_clients## 
=## 
clients## 
;## 

_resources$$ 
=$$ 
	resources$$ "
;$$" #
_events%% 
=%% 
events%% 
;%% 
}&& 	
[++ 	
HttpGet++	 
]++ 
public,, 
async,, 
Task,, 
<,, 
IActionResult,, '
>,,' (
Index,,) .
(,,. /
),,/ 0
{-- 	
return.. 
View.. 
(.. 
$str.. 
,..  
await..! &
BuildViewModelAsync..' :
(..: ;
)..; <
)..< =
;..= >
}// 	
[44 	
HttpPost44	 
]44 
[55 	$
ValidateAntiForgeryToken55	 !
]55! "
public66 
async66 
Task66 
<66 
IActionResult66 '
>66' (
Revoke66) /
(66/ 0
string660 6
clientId667 ?
)66? @
{77 	
await88 
_interaction88 
.88 "
RevokeUserConsentAsync88 5
(885 6
clientId886 >
)88> ?
;88? @
await99 
_events99 
.99 

RaiseAsync99 $
(99$ %
new99% (
GrantsRevokedEvent99) ;
(99; <
User99< @
.99@ A
GetSubjectId99A M
(99M N
)99N O
,99O P
clientId99Q Y
)99Y Z
)99Z [
;99[ \
return;; 
RedirectToAction;; #
(;;# $
$str;;$ +
);;+ ,
;;;, -
}<< 	
private>> 
async>> 
Task>> 
<>> 
GrantsViewModel>> *
>>>* +
BuildViewModelAsync>>, ?
(>>? @
)>>@ A
{?? 	
var@@ 
grants@@ 
=@@ 
await@@ 
_interaction@@ +
.@@+ ,!
GetAllUserGrantsAsync@@, A
(@@A B
)@@B C
;@@C D
varBB 
listBB 
=BB 
newBB 
ListBB 
<BB  
GrantViewModelBB  .
>BB. /
(BB/ 0
)BB0 1
;BB1 2
foreachCC 
(CC 
varCC 
grantCC 
inCC !
grantsCC" (
)CC( )
{DD 
varEE 
clientEE 
=EE 
awaitEE "
_clientsEE# +
.EE+ ,
FindClientByIdAsyncEE, ?
(EE? @
grantEE@ E
.EEE F
ClientIdEEF N
)EEN O
;EEO P
ifFF 
(FF 
clientFF 
!=FF 
nullFF "
)FF" #
{GG 
varHH 
	resourcesHH !
=HH" #
awaitHH$ )

_resourcesHH* 4
.HH4 5%
FindResourcesByScopeAsyncHH5 N
(HHN O
grantHHO T
.HHT U
ScopesHHU [
)HH[ \
;HH\ ]
varJJ 
itemJJ 
=JJ 
newJJ "
GrantViewModelJJ# 1
(JJ1 2
)JJ2 3
{KK 
ClientIdLL  
=LL! "
clientLL# )
.LL) *
ClientIdLL* 2
,LL2 3

ClientNameMM "
=MM# $
clientMM% +
.MM+ ,

ClientNameMM, 6
??MM7 9
clientMM: @
.MM@ A
ClientIdMMA I
,MMI J
ClientLogoUrlNN %
=NN& '
clientNN( .
.NN. /
LogoUriNN/ 6
,NN6 7
	ClientUrlOO !
=OO" #
clientOO$ *
.OO* +
	ClientUriOO+ 4
,OO4 5
DescriptionPP #
=PP$ %
grantPP& +
.PP+ ,
DescriptionPP, 7
,PP7 8
CreatedQQ 
=QQ  !
grantQQ" '
.QQ' (
CreationTimeQQ( 4
,QQ4 5
ExpiresRR 
=RR  !
grantRR" '
.RR' (

ExpirationRR( 2
,RR2 3
IdentityGrantNamesSS *
=SS+ ,
	resourcesSS- 6
.SS6 7
IdentityResourcesSS7 H
.SSH I
SelectSSI O
(SSO P
xSSP Q
=>SSR T
xSSU V
.SSV W
DisplayNameSSW b
??SSc e
xSSf g
.SSg h
NameSSh l
)SSl m
.SSm n
ToArraySSn u
(SSu v
)SSv w
,SSw x
ApiGrantNamesTT %
=TT& '
	resourcesTT( 1
.TT1 2
	ApiScopesTT2 ;
.TT; <
SelectTT< B
(TTB C
xTTC D
=>TTE G
xTTH I
.TTI J
DisplayNameTTJ U
??TTV X
xTTY Z
.TTZ [
NameTT[ _
)TT_ `
.TT` a
ToArrayTTa h
(TTh i
)TTi j
}UU 
;UU 
listWW 
.WW 
AddWW 
(WW 
itemWW !
)WW! "
;WW" #
}XX 
}YY 
return[[ 
new[[ 
GrantsViewModel[[ &
{\\ 
Grants]] 
=]] 
list]] 
}^^ 
;^^ 
}__ 	
}`` 
}aa È
†C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Grants\GrantsViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{		 
public

 

class

 
GrantsViewModel

  
{ 
public 
IEnumerable 
< 
GrantViewModel )
>) *
Grants+ 1
{2 3
get4 7
;7 8
set9 <
;< =
}> ?
} 
public 

class 
GrantViewModel 
{ 
public 
string 
ClientId 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
string 

ClientName  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
string 
	ClientUrl 
{  !
get" %
;% &
set' *
;* +
}, -
public 
string 
ClientLogoUrl #
{$ %
get& )
;) *
set+ .
;. /
}0 1
public 
string 
Description !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 
DateTime 
Created 
{  !
get" %
;% &
set' *
;* +
}, -
public 
DateTime 
? 
Expires  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
IEnumerable 
< 
string !
>! "
IdentityGrantNames# 5
{6 7
get8 ;
;; <
set= @
;@ A
}B C
public 
IEnumerable 
< 
string !
>! "
ApiGrantNames# 0
{1 2
get3 6
;6 7
set8 ;
;; <
}= >
} 
} „
ùC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Home\ErrorViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public		 

class		 
ErrorViewModel		 
{

 
public 
ErrorViewModel 
( 
) 
{ 	
} 	
public 
ErrorViewModel 
( 
string $
error% *
)* +
{ 	
Error 
= 
new 
ErrorMessage $
{% &
Error' ,
=- .
error/ 4
}5 6
;6 7
} 	
public 
ErrorMessage 
Error !
{" #
get$ '
;' (
set) ,
;, -
}. /
} 
} ¶
ùC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Home\HomeController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[ 
SecurityHeaders 
] 
[ 
AllowAnonymous 
] 
public 

class 
HomeController 
:  !

Controller" ,
{ 
private 
readonly -
!IIdentityServerInteractionService :
_interaction; G
;G H
private 
readonly 
IWebHostEnvironment ,
_environment- 9
;9 :
private 
readonly 
ILogger  
_logger! (
;( )
public 
HomeController 
( -
!IIdentityServerInteractionService ?
interaction@ K
,K L
IWebHostEnvironmentM `
environmenta l
,l m
ILoggern u
<u v
HomeController	v Ñ
>
Ñ Ö
logger
Ü å
)
å ç
{ 	
_interaction 
= 
interaction &
;& '
_environment 
= 
environment &
;& '
_logger 
= 
logger 
; 
} 	
public 
IActionResult 
Index "
(" #
)# $
{ 	
if   
(   
_environment   
.   
IsDevelopment   *
(  * +
)  + ,
)  , -
{!! 
return## 
View## 
(## 
)## 
;## 
}$$ 
_logger&& 
.&& 
LogInformation&& "
(&&" #
$str&&# W
)&&W X
;&&X Y
return'' 
NotFound'' 
('' 
)'' 
;'' 
}(( 	
public-- 
async-- 
Task-- 
<-- 
IActionResult-- '
>--' (
Error--) .
(--. /
string--/ 5
errorId--6 =
)--= >
{.. 	
var// 
vm// 
=// 
new// 
ErrorViewModel// '
(//' (
)//( )
;//) *
var22 
message22 
=22 
await22 
_interaction22  ,
.22, - 
GetErrorContextAsync22- A
(22A B
errorId22B I
)22I J
;22J K
if33 
(33 
message33 
!=33 
null33 
)33  
{44 
vm55 
.55 
Error55 
=55 
message55 "
;55" #
if77 
(77 
!77 
_environment77 !
.77! "
IsDevelopment77" /
(77/ 0
)770 1
)771 2
{88 
message:: 
.:: 
ErrorDescription:: ,
=::- .
null::/ 3
;::3 4
};; 
}<< 
return>> 
View>> 
(>> 
$str>> 
,>>  
vm>>! #
)>># $
;>>$ %
}?? 	
}@@ 
}AA °
¢C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\SecurityHeadersAttribute.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{		 
public

 

class

 $
SecurityHeadersAttribute

 )
:

* +!
ActionFilterAttribute

, A
{ 
public 
override 
void 
OnResultExecuting .
(. /"
ResultExecutingContext/ E
contextF M
)M N
{ 	
var 
result 
= 
context  
.  !
Result! '
;' (
if 
( 
result 
is 

ViewResult $
)$ %
{ 
if 
( 
! 
context 
. 
HttpContext (
.( )
Response) 1
.1 2
Headers2 9
.9 :
ContainsKey: E
(E F
$strF ^
)^ _
)_ `
{ 
context 
. 
HttpContext '
.' (
Response( 0
.0 1
Headers1 8
.8 9
Add9 <
(< =
$str= U
,U V
$strW `
)` a
;a b
} 
if 
( 
! 
context 
. 
HttpContext (
.( )
Response) 1
.1 2
Headers2 9
.9 :
ContainsKey: E
(E F
$strF W
)W X
)X Y
{ 
context 
. 
HttpContext '
.' (
Response( 0
.0 1
Headers1 8
.8 9
Add9 <
(< =
$str= N
,N O
$strP \
)\ ]
;] ^
} 
var 
csp 
= 
$str	 †
;
† °
if%% 
(%% 
!%% 
context%% 
.%% 
HttpContext%% (
.%%( )
Response%%) 1
.%%1 2
Headers%%2 9
.%%9 :
ContainsKey%%: E
(%%E F
$str%%F _
)%%_ `
)%%` a
{&& 
context'' 
.'' 
HttpContext'' '
.''' (
Response''( 0
.''0 1
Headers''1 8
.''8 9
Add''9 <
(''< =
$str''= V
,''V W
csp''X [
)''[ \
;''\ ]
}(( 
if** 
(** 
!** 
context** 
.** 
HttpContext** (
.**( )
Response**) 1
.**1 2
Headers**2 9
.**9 :
ContainsKey**: E
(**E F
$str**F a
)**a b
)**b c
{++ 
context,, 
.,, 
HttpContext,, '
.,,' (
Response,,( 0
.,,0 1
Headers,,1 8
.,,8 9
Add,,9 <
(,,< =
$str,,= X
,,,X Y
csp,,Z ]
),,] ^
;,,^ _
}-- 
var00 
referrer_policy00 #
=00$ %
$str00& 3
;003 4
if11 
(11 
!11 
context11 
.11 
HttpContext11 (
.11( )
Response11) 1
.111 2
Headers112 9
.119 :
ContainsKey11: E
(11E F
$str11F W
)11W X
)11X Y
{22 
context33 
.33 
HttpContext33 '
.33' (
Response33( 0
.330 1
Headers331 8
.338 9
Add339 <
(33< =
$str33= N
,33N O
referrer_policy33P _
)33_ `
;33` a
}44 
}55 
}66 	
}77 
}88 â
òC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Specific\Class.cs
	namespace 	
IdentityServer
 
. 

Quickstart #
.# $
Specific$ ,
{ 
public 

enum 

Permission 
{ 
Read 
, 
Create 
, 
Update 
, 
Delete 
}		 
}

 Õ
óC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Specific\Role.cs
	namespace 	
IdentityServer
 
. 

Quickstart #
.# $
Specific$ ,
{ 
public 

enum 
Role 
{ 
Buyer 
, 
Manager 
, 
} 
} É
°C:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\Specific\RolePermission.cs
	namespace 	
IdentityServer
 
. 

Quickstart #
.# $
Specific$ ,
{ 
public 

static 
class 
RolePermission &
{ 
private 
static 

Dictionary !
<! "
Role" &
,& '

Permission( 2
[2 3
]3 4
>4 5
_rolePermissions6 F
=G H
newI L

DictionaryM W
<W X
RoleX \
,\ ]

Permission^ h
[h i
]i j
>j k
{ 	
{		 
Role		 
.		 
Buyer		 
,		 
new		 

Permission		 (
[		( )
]		) *
{		+ ,

Permission		- 7
.		7 8
Read		8 <
}		= >
}		? @
,		@ A
{

 
Role

 
.

 
Manager

 
,

 
new

 

Permission

  *
[

* +
]

+ ,
{

- .

Permission

/ 9
.

9 :
Read

: >
,

> ?

Permission

@ J
.

J K
Create

K Q
,

Q R

Permission

S ]
.

] ^
Update

^ d
,

d e

Permission

f p
.

p q
Delete

q w
}

x y
}

z {
,

{ |
} 	
;	 

public 
static 

Permission  
[  !
]! "
GetPermissions# 1
(1 2
Role2 6
role7 ;
); <
=>= ?
_rolePermissions@ P
[P Q
roleQ U
]U V
;V W
} 
} Ñ+
ìC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Quickstart\TestUsers.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

static 
class 
	TestUsers !
{ 
public 
static 
List 
< 
TestUser #
># $
Users% *
{ 	
get 
{ 
var 
address 
= 
new !
{ 
street_address "
=# $
$str% 5
,5 6
locality 
= 
$str +
,+ ,
postal_code 
=  !
$num" '
,' (
country 
= 
$str '
} 
; 
return 
new 
List 
<  
TestUser  (
>( )
{ 
new 
TestUser  
{   
	SubjectId!! !
=!!" #
$str!!$ ,
,!!, -
Username""  
=""! "
$str""# *
,""* +
Password##  
=##! "
$str### *
,##* +
Claims$$ 
=$$  
{%% 
new&& 
Claim&&  %
(&&% &
JwtClaimTypes&&& 3
.&&3 4
Name&&4 8
,&&8 9
$str&&: G
)&&G H
,&&H I
new'' 
Claim''  %
(''% &
JwtClaimTypes''& 3
.''3 4
	GivenName''4 =
,''= >
$str''? F
)''F G
,''G H
new(( 
Claim((  %
(((% &
JwtClaimTypes((& 3
.((3 4

FamilyName((4 >
,((> ?
$str((@ G
)((G H
,((H I
new)) 
Claim))  %
())% &
JwtClaimTypes))& 3
.))3 4
Email))4 9
,))9 :
$str)); Q
)))Q R
,))R S
new** 
Claim**  %
(**% &
JwtClaimTypes**& 3
.**3 4
EmailVerified**4 A
,**A B
$str**C I
,**I J
ClaimValueTypes**K Z
.**Z [
Boolean**[ b
)**b c
,**c d
new++ 
Claim++  %
(++% &
JwtClaimTypes++& 3
.++3 4
WebSite++4 ;
,++; <
$str++= O
)++O P
,++P Q
new,, 
Claim,,  %
(,,% &
JwtClaimTypes,,& 3
.,,3 4
Address,,4 ;
,,,; <
JsonSerializer,,= K
.,,K L
	Serialize,,L U
(,,U V
address,,V ]
),,] ^
,,,^ _#
IdentityServerConstants,,` w
.,,w x
ClaimValueTypes	,,x á
.
,,á à
Json
,,à å
)
,,å ç
,
,,ç é
new-- 
Claim--  %
(--% &
JwtClaimTypes--& 3
.--3 4
Role--4 8
,--8 9
Role--: >
.--> ?
Manager--? F
.--F G
ToString--G O
(--O P
)--P Q
)--Q R
}.. 
}// 
,// 
new00 
TestUser00  
{11 
	SubjectId22 !
=22" #
$str22$ .
,22. /
Username33  
=33! "
$str33# (
,33( )
Password44  
=44! "
$str44# (
,44( )
Claims55 
=55  
{66 
new77 
Claim77  %
(77% &
JwtClaimTypes77& 3
.773 4
Name774 8
,778 9
$str77: E
)77E F
,77F G
new88 
Claim88  %
(88% &
JwtClaimTypes88& 3
.883 4
	GivenName884 =
,88= >
$str88? D
)88D E
,88E F
new99 
Claim99  %
(99% &
JwtClaimTypes99& 3
.993 4

FamilyName994 >
,99> ?
$str99@ G
)99G H
,99H I
new:: 
Claim::  %
(::% &
JwtClaimTypes::& 3
.::3 4
Email::4 9
,::9 :
$str::; O
)::O P
,::P Q
new;; 
Claim;;  %
(;;% &
JwtClaimTypes;;& 3
.;;3 4
EmailVerified;;4 A
,;;A B
$str;;C I
,;;I J
ClaimValueTypes;;K Z
.;;Z [
Boolean;;[ b
);;b c
,;;c d
new<< 
Claim<<  %
(<<% &
JwtClaimTypes<<& 3
.<<3 4
WebSite<<4 ;
,<<; <
$str<<= M
)<<M N
,<<N O
new== 
Claim==  %
(==% &
JwtClaimTypes==& 3
.==3 4
Address==4 ;
,==; <
JsonSerializer=== K
.==K L
	Serialize==L U
(==U V
address==V ]
)==] ^
,==^ _#
IdentityServerConstants==` w
.==w x
ClaimValueTypes	==x á
.
==á à
Json
==à å
)
==å ç
,
==ç é
new>> 
Claim>>  %
(>>% &
JwtClaimTypes>>& 3
.>>3 4
Role>>4 8
,>>8 9
Role>>: >
.>>> ?
Buyer>>? D
.>>D E
ToString>>E M
(>>M N
)>>N O
)>>O P
}?? 
}@@ 
}AA 
;AA 
}BB 
}CC 	
}DD 
}EE %
ÜC:\workspace\dotNet mentoring advanced 2022\repo\dotnet-advanced-mentoring-2022-2023\dotNetMentoringAdvanced\IdentityServer\Startup.cs
	namespace 	
IdentityServer
 
{ 
public 

class 
Startup 
{ 
public 
IWebHostEnvironment "
Environment# .
{/ 0
get1 4
;4 5
}6 7
public 
IConfiguration 
Configuration +
{, -
get. 1
;1 2
}3 4
public 
Startup 
( 
IWebHostEnvironment *
environment+ 6
,6 7
IConfiguration8 F
configurationG T
)T U
{ 	
Environment 
= 
environment %
;% &
Configuration 
= 
configuration )
;) *
} 	
public 
void 
ConfigureServices %
(% &
IServiceCollection& 8
services9 A
)A B
{ 	
services 
. #
AddControllersWithViews ,
(, -
)- .
;. /
var 
builder 
= 
services "
." #
AddIdentityServer# 4
(4 5
options5 <
=>= ?
{ 
options   
.   
Events   
.   
RaiseErrorEvents   /
=  0 1
true  2 6
;  6 7
options!! 
.!! 
Events!! 
.!! "
RaiseInformationEvents!! 5
=!!6 7
true!!8 <
;!!< =
options"" 
."" 
Events"" 
."" 
RaiseFailureEvents"" 1
=""2 3
true""4 8
;""8 9
options## 
.## 
Events## 
.## 
RaiseSuccessEvents## 1
=##2 3
true##4 8
;##8 9
options&& 
.&& #
EmitStaticAudienceClaim&& /
=&&0 1
true&&2 6
;&&6 7
}'' 
)'' 
.(( 
AddTestUsers(( 
((( 
	TestUsers(( '
.((' (
Users((( -
)((- .
;((. /
builder++ 
.++ (
AddInMemoryIdentityResources++ 0
(++0 1
Config++1 7
.++7 8
IdentityResources++8 I
)++I J
;++J K
builder,, 
.,,  
AddInMemoryApiScopes,, (
(,,( )
Config,,) /
.,,/ 0
	ApiScopes,,0 9
),,9 :
;,,: ;
builder-- 
.-- 
AddInMemoryClients-- &
(--& '
Config--' -
.--- .
Clients--. 5
)--5 6
;--6 7
builder00 
.00 )
AddDeveloperSigningCredential00 1
(001 2
)002 3
;003 4
services22 
.22 
AddAuthentication22 &
(22& '
)22' (
.33 
	AddGoogle33 
(33 
options33 "
=>33# %
{44 
options55 
.55 
SignInScheme55 (
=55) *#
IdentityServerConstants55+ B
.55B C.
"ExternalCookieAuthenticationScheme55C e
;55e f
options:: 
.:: 
ClientId:: $
=::% &
$str::' H
;::H I
options;; 
.;; 
ClientSecret;; (
=;;) *
$str;;+ P
;;;P Q
}<< 
)<< 
;<< 
}== 	
public?? 
void?? 
	Configure?? 
(?? 
IApplicationBuilder?? 1
app??2 5
)??5 6
{@@ 	
ifAA 
(AA 
EnvironmentAA 
.AA 
IsDevelopmentAA )
(AA) *
)AA* +
)AA+ ,
{BB 
appCC 
.CC %
UseDeveloperExceptionPageCC -
(CC- .
)CC. /
;CC/ 0
}DD 
appFF 
.FF 
UseStaticFilesFF 
(FF 
)FF  
;FF  !
appHH 
.HH 

UseRoutingHH 
(HH 
)HH 
;HH 
appII 
.II 
UseIdentityServerII !
(II! "
)II" #
;II# $
appJJ 
.JJ 
UseAuthorizationJJ  
(JJ  !
)JJ! "
;JJ" #
appKK 
.KK 
UseEndpointsKK 
(KK 
	endpointsKK &
=>KK' )
{LL 
	endpointsMM 
.MM %
MapDefaultControllerRouteMM 3
(MM3 4
)MM4 5
;MM5 6
}NN 
)NN 
;NN 
}OO 	
}PP 
}QQ 